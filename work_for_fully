# Full SQL â€“ unchanged (already correct)
FULL_DISABILITY_SQL = text("""
WITH children AS (
    SELECT
        c.parent_code AS parent_code,
        json_agg(
            json_build_object(
                'code', c.code,
                'title', c.title,
                'description', c.description,
                'questions_by_age_group', COALESCE(
                    (
                        SELECT json_agg(
                            json_build_object(
                                'age_group', v.age_group,
                                'questions', COALESCE(
                                    (
                                        SELECT json_agg(
                                            json_build_object(
                                                'code', q.unique_code,
                                                'text', q.question,
                                                'main_category', COALESCE(
                                                    (
                                                        SELECT json_agg(
                                                            json_build_object(
                                                                'code', mc.code,
                                                                'text', mc.category
                                                            )
                                                            ORDER BY mc.code
                                                        )
                                                        FROM (
                                                            SELECT DISTINCT ON (cqv_mc.category_question_code)
                                                                cqv_mc.category_question_code,
                                                                cq.code,
                                                                cq.category
                                                            FROM category_question_view cqv_mc
                                                            JOIN category_question cq
                                                              ON cqv_mc.category_question_code = cq.code
                                                            WHERE cqv_mc.question_code = q.unique_code
                                                              AND (CAST(:age_group AS TEXT) IS NULL
                                                                   OR cqv_mc.age_group = CAST(:age_group AS TEXT))
                                                            ORDER BY cqv_mc.category_question_code, cq.code
                                                        ) mc
                                                    ),
                                                    '[]'::json
                                                ),
                                                'question_by_category', COALESCE(
                                                    (
                                                        -- Build category + same answers for each
                                                        SELECT json_agg(
                                                            json_build_object(
                                                                'category', json_build_object(
                                                                    'code', cat.code,
                                                                    'text', cat.category
                                                                ),
                                                                'answers', COALESCE(q_answers.answers_json, '[]'::json)
                                                            )
                                                            ORDER BY cat.code
                                                        )
                                                        FROM (
                                                            SELECT DISTINCT ON (cqv2.category_question_code)
                                                                cqv2.category_question_code,
                                                                cq2.code,
                                                                cq2.category
                                                            FROM category_question_view cqv2
                                                            JOIN category_question cq2
                                                              ON cqv2.category_question_code = cq2.code
                                                            WHERE cqv2.question_code = q.unique_code
                                                              AND (CAST(:age_group AS TEXT) IS NULL
                                                                   OR cqv2.age_group = CAST(:age_group AS TEXT))
                                                            ORDER BY cqv2.category_question_code, cq2.code
                                                        ) cat
                                                        CROSS JOIN LATERAL (
                                                            SELECT json_agg(
                                                                json_build_object(
                                                                    'code', a.unique_code,
                                                                    'text', a.answer
                                                                )
                                                                ORDER BY a.unique_code
                                                            ) AS answers_json
                                                            FROM question_answer_view qav
                                                            JOIN answer a ON qav.answer_code = a.unique_code
                                                            WHERE qav.question_code = q.unique_code
                                                              AND qav.age_group = v.age_group
                                                        ) q_answers
                                                    ),
                                                    '[]'::json
                                                )
                                            )
                                            ORDER BY q.unique_code
                                        )
                                        FROM question q
                                        WHERE q.parent_code = CASE
                                            WHEN v.age_group = 'under_8_year_old' THEN c.code
                                            WHEN v.age_group = 'over_8_year_old' THEN REPLACE(c.code, '_', '.')
                                        END
                                    ),
                                    '[]'::json
                                )
                            )
                            ORDER BY
                                CASE
                                    WHEN v.age_group = 'under_8_year_old' THEN 1
                                    WHEN v.age_group = 'over_8_year_old' THEN 2
                                    ELSE 3
                                END
                        )
                        FROM (
                            SELECT DISTINCT age_group
                            FROM question_answer_view
                            WHERE (CAST(:age_group AS TEXT) IS NULL OR age_group = CAST(:age_group AS TEXT))
                        ) v
                    ),
                    '[]'::json
                )
            )
            ORDER BY c.code
        ) AS subtypes
    FROM disability_type c
    WHERE c.parent_code IS NOT NULL
    GROUP BY c.parent_code
)
SELECT
    dt.code AS disability_code,
    dt.title,
    dt.description,
    COALESCE(ch.subtypes, '[]'::json) AS subtypes
FROM disability_type dt
LEFT JOIN children ch ON ch.parent_code = dt.code
WHERE dt.parent_code IS NULL
ORDER BY CAST(SUBSTRING(dt.code FROM '[0-9]+') AS INT);
""")


@router.get(
    "/fully-question-answer-disability",
    response_model=DisabilityCategoryQuestionResponse,
    description="Get full disability questions with main_category and answers per category"
)
async def get_fully_disability_questions(
    dob: Optional[str] = Query(None, description="Date of birth YYYY/MM/DD"),
    keycloak_user: Annotated[UserInSignInKeyCloak, Depends(get_user_info)] = None,
    db: Annotated[AsyncSession, Depends(async_get_db)] = None
):
    if keycloak_user:
        await validate_user(keycloak_user.username, keycloak_user, db)

    age_group = calculate_age_group(dob) if dob else None

    result = await db.execute(FULL_DISABILITY_SQL, {"age_group": age_group})
    rows = result.mappings().all()

    return {"data": rows}
