FULL_DISABILITY_SQL = text("""
WITH children AS (
    SELECT
        c.parent_code AS parent_code,
        json_agg(
            json_build_object(
                'code', c.code,
                'title', c.title,
                'description', c.description,
                'questions_by_age_group', COALESCE(
                    (
                        SELECT json_agg(
                            json_build_object(
                                'age_group', v.age_group,
                                'questions', COALESCE(
                                    (
                                        SELECT json_agg(
                                            json_build_object(
                                                'code', q.unique_code,
                                                'text', q.question,
                                                'main_category', COALESCE(
                                                    (
                                                        SELECT json_agg(
                                                            json_build_object(
                                                                'code', mc.code,
                                                                'text', mc.category
                                                            )
                                                            ORDER BY mc.code
                                                        )
                                                        FROM (
                                                            SELECT DISTINCT ON (cqv_mc.category_question_code)
                                                                cqv_mc.category_question_code,
                                                                cq.code,
                                                                cq.category
                                                            FROM category_question_view cqv_mc
                                                            JOIN category_question cq
                                                              ON cqv_mc.category_question_code = cq.code
                                                            WHERE cqv_mc.question_code = q.unique_code
                                                              AND (CAST(:age_group AS TEXT) IS NULL OR cqv_mc.age_group = CAST(:age_group AS TEXT))
                                                            ORDER BY cqv_mc.category_question_code, cq.code
                                                        ) mc
                                                    ),
                                                    '[]'::json
                                                ),
                                                'question_by_category', COALESCE(
                                                    (
                                                        SELECT json_agg(qbc_item ORDER BY base_cat.code)
                                                        FROM (
                                                            SELECT DISTINCT ON (cq2.code)
                                                                cq2.code,
                                                                cq2.category,
                                                                cq2.child_code
                                                            FROM category_question_view cqv2
                                                            JOIN category_question cq2
                                                              ON cqv2.category_question_code = cq2.code
                                                            WHERE cqv2.question_code = q.unique_code
                                                              AND (CAST(:age_group AS TEXT) IS NULL OR cqv2.age_group = CAST(:age_group AS TEXT))
                                                            ORDER BY cq2.code
                                                        ) base_cat
                                                        CROSS JOIN LATERAL (
                                                            SELECT json_agg(
                                                                json_build_object('code', a.unique_code, 'text', a.answer)
                                                                ORDER BY a.unique_code
                                                            ) AS answers_json
                                                            FROM question_answer_view qav
                                                            JOIN answer a ON qav.answer_code = a.unique_code
                                                            WHERE qav.question_code = q.unique_code
                                                              AND qav.age_group = v.age_group
                                                        ) q_answers
                                                        LEFT JOIN LATERAL (
                                                            SELECT json_agg(
                                                                json_build_object(
                                                                    'category', json_build_object('code', ch.code, 'text', ch.category),
                                                                    'answers', q_answers.answers_json
                                                                )
                                                                ORDER BY ch.code
                                                            ) AS nested_answers
                                                            FROM (
                                                                SELECT TRIM(unnest(string_to_array(base_cat.child_code, '_'))) AS child_code
                                                            ) split
                                                            JOIN category_question ch ON ch.code = split.child_code
                                                            WHERE base_cat.child_code IS NOT NULL
                                                        ) nested ON true
                                                        CROSS JOIN LATERAL (
                                                            SELECT
                                                                CASE
                                                                    -- FIXED: Only nest if child_code contains '_'
                                                                    WHEN strpos(base_cat.child_code, '_') > 0 THEN
                                                                        json_build_object(
                                                                            'category', json_build_object('code', base_cat.code, 'text', base_cat.category),
                                                                            'answers', COALESCE(nested.nested_answers, '[]'::json)
                                                                        )
                                                                    ELSE
                                                                        -- C1, C2: flat answers
                                                                        json_build_object(
                                                                            'category', json_build_object('code', base_cat.code, 'text', base_cat.category),
                                                                            'answers', COALESCE(q_answers.answers_json, '[]'::json)
                                                                        )
                                                                END AS qbc_item
                                                        ) final
                                                    ),
                                                    '[]'::json
                                                )
                                            )
                                            ORDER BY q.unique_code
                                        )
                                        FROM question q
                                        WHERE q.parent_code = CASE
                                            WHEN v.age_group = 'under_8_year_old' THEN c.code
                                            WHEN v.age_group = 'over_8_year_old' THEN REPLACE(c.code, '_', '.')
                                        END
                                    ),
                                    '[]'::json
                                )
                            )
                            ORDER BY
                                CASE
                                    WHEN v.age_group = 'under_8_year_old' THEN 1
                                    WHEN v.age_group = 'over_8_year_old' THEN 2
                                    ELSE 3
                                END
                        )
                        FROM (
                            SELECT DISTINCT age_group
                            FROM question_answer_view
                            WHERE (CAST(:age_group AS TEXT) IS NULL OR age_group = CAST(:age_group AS TEXT))
                        ) v
                    ),
                    '[]'::json
                )
            )
            ORDER BY c.code
        ) AS subtypes
    FROM disability_type c
    WHERE c.parent_code IS NOT NULL
    GROUP BY c.parent_code
)
SELECT
    dt.code AS disability_code,
    dt.title,
    dt.description,
    COALESCE(ch.subtypes, '[]'::json) AS subtypes
FROM disability_type dt
LEFT JOIN children ch ON ch.parent_code = dt.code
WHERE dt.parent_code IS NULL
ORDER BY CAST(SUBSTRING(dt.code FROM '[0-9]+') AS INT);
""")


@router.get(
    "/fully-question-answer-disability",
    response_model=DisabilityCategoryQuestionResponse,
    description="Get full disability questions with main_category and answers per category"
)
async def get_fully_disability_questions(
    dob: Optional[str] = Query(None, description="Date of birth YYYY/MM/DD"),
    keycloak_user: Annotated[UserInSignInKeyCloak, Depends(get_user_info)] = None,
    db: Annotated[AsyncSession, Depends(async_get_db)] = None
):
    if keycloak_user:
        await validate_user(keycloak_user.username, keycloak_user, db)

    age_group = calculate_age_group(dob) if dob else None

    result = await db.execute(FULL_DISABILITY_SQL, {"age_group": age_group})
    rows = result.mappings().all()

    return {"data": rows}




================================
This is schemas part
================================

# app/schemas/disability.py
from typing import List, Optional, Union
from pydantic import BaseModel, Field


class AnswerItem(BaseModel):
    code: str = Field(..., description="Answer code (e.g. A1)")
    text: Optional[str] = Field(None, description="Answer text")


class CategoryItem(BaseModel):
    text: str = Field(..., description="Category name")
    code: str = Field(..., description="Category code")


# NEW: For nested answers inside C3
class NestedAnswerItem(BaseModel):
    category: CategoryItem
    answers: List[AnswerItem]


class QuestionCategoryItem(BaseModel):
    category: CategoryItem
    answers: Union[List[AnswerItem], List[NestedAnswerItem]]  # ‚Üê This fixes validation


class MainCategoryItem(BaseModel):
    code: str = Field(..., description="Category code")
    text: str = Field(..., description="Category name")


class QuestionItem(BaseModel):
    code: str = Field(..., description="Question code")
    text: Optional[str] = Field(None, description="Question text")
    main_category: List[MainCategoryItem] = Field(default_factory=list)
    question_by_category: List[QuestionCategoryItem] = Field(default_factory=list)


class CategoryQuestionsByAgeGroup(BaseModel):
    age_group: str
    questions: List[QuestionItem] = Field(default_factory=list)


class SubtypeItem(BaseModel):
    code: str
    title: Optional[str]
    description: Optional[str]
    questions_by_age_group: List[CategoryQuestionsByAgeGroup] = Field(default_factory=list)


class DisabilityCategoryQuestionItem(BaseModel):
    disability_code: str
    title: Optional[str]
    description: Optional[str]
    subtypes: List[SubtypeItem] = Field(default_factory=list)


class DisabilityCategoryQuestionResponse(BaseModel):
    data: List[DisabilityCategoryQuestionItem]
