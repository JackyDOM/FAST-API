import logging
from typing import Annotated,List

from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.exc import IntegrityError

from ...api.auth_keycloak import get_user_info
from ...core.db.database import async_get_db
from ...crud.crud_disability_type import crud_disability_type
from ...crud.crud_answer import crud_answer
from ...crud.crud_sub_diability import crud_sub_disability
from ...crud.crud_question import crud_question
from ...crud.crud_question_answer import crud_question_answer
from ...core.utils.user_validation import validate_user
from ...schemas.disability_type import (
    DisabilityTypeCreate,
    DisabilityTypeCreateInternal,
    DisabilityTypeRead,
    DisabilityTypeUpdate,
    DisabilityTypeUpdateInternal,
    DisabilityTypeSearch,
    DisabilityTypeStats,
)
from ...schemas.question import (
    QuestionCreateInternal,
    QuestionCreate,
    QuestionRead,
    QuestionUpdate,
    QuestionUpdateInternal
)

from ...schemas.answer import (
    AnswerCreateInternal,
    AnswerCreate,
    AnswerRead,
    AnswerUpdate,
    AnswerUpdateInternal
)
from ...schemas.question_answer import (
    QuestionAnswerCreateInternal,
    QuestionAnswerCreate,
    QuestionAnswerRead,
    QuestionAnswerUpdate,
    QuestionAnswerUpdateInternal
)
from ...schemas.sub_disability_type import (
    SubDisabilityCreateInternal,
    SubDisabilityCreate,
    SubDisabilityRead,
    SubDiabilityUpdate,
    SubDisabilityUpdateInternal
)
from ...schemas.user_keycloak import UserInSignInKeyCloak
from ...models.sub_disbility_type import SubDisabilityType
from ...models.question import Question
from ...models.disability_type import DisabilityType
from ...models.answer import Answer
from sqlalchemy import select


router = APIRouter(tags=["disability-types"], prefix="/disability-types")

@router.post(
    "/",
    status_code=status.HTTP_201_CREATED,
    response_model=DisabilityTypeRead,
    summary="Create a new disability type",
    description="Create a new disability type record"
)
async def create_disability_type(
    disability_type_data: DisabilityTypeCreate,
    keycloak_user: Annotated[UserInSignInKeyCloak, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)]
) -> DisabilityTypeRead:
    """
    Create a new disability type.
    
    Args:
        disability_type_data: Disability type creation data
        keycloak_user: Authenticated user information
        db: Database session
        
    Returns:
        Created disability type
    """
    
    # Validate user
    db_user = await validate_user(keycloak_user.username, keycloak_user, db)
    user_id = db_user["id"]
    
    try:
        # Convert to internal schema
        disability_type_create = DisabilityTypeCreateInternal(
            **disability_type_data.dict(),
            created_by=user_id
        )
        
        # Create the disability type in database
        created_disability_type = await crud_disability_type.create_disability_type(
            db=db, 
            disability_type_data=disability_type_create
        )
        
        return DisabilityTypeRead(
            id=created_disability_type.id,
            title=created_disability_type.title,
            code=created_disability_type.code,
            description=created_disability_type.description,
            parent_code=created_disability_type.parent_code,
            status=created_disability_type.status,
            created_by=created_disability_type.created_by,
            updated_by=created_disability_type.updated_by
        )
        
    except ValueError as e:
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT,
            detail=str(e)
        )
    except IntegrityError:
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT,
            detail=f"Disability type with code '{disability_type_data.code}' or title '{disability_type_data.title}' already exists"
        )
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to create disability type: {str(e)}"
        )


@router.get(
    "/",
    response_model=list[DisabilityTypeRead],
    summary="Get all disability types",
    description="Retrieve all active disability types with optional filtering"
)
async def get_disability_types(
    keycloak_user: Annotated[UserInSignInKeyCloak, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)],
    skip: int = 0,
    limit: int = 100,
    status_filter: bool | None = None,
    active_only: bool = False,
) -> list[DisabilityTypeRead]:
    """
    Get all disability types with optional filtering.
    
    Args:
        keycloak_user: Authenticated user information
        db: Database session
        skip: Number of records to skip
        limit: Maximum number of records to return
        status_filter: Filter by active/inactive status
        active_only: If True, only return active types
        
    Returns:
        List of disability types
    """
    
    # Validate user
    await validate_user(keycloak_user.username, keycloak_user, db)
    
    try:
        if active_only:
            records = await crud_disability_type.get_active_types(db=db, skip=skip, limit=limit)
        elif status_filter is not None:
            records = await crud_disability_type.get_by_status(db=db, status=status_filter, skip=skip, limit=limit)
        else:
            records = await crud_disability_type.get_all_active(db=db, skip=skip, limit=limit)
        
        return [
            DisabilityTypeRead(
                id=record.id,
                title=record.title,
                code=record.code,
                description=record.description,
                parent_code=record.parent_code,
                status=record.status,
                created_by=record.created_by,
                updated_by=record.updated_by
            )
            for record in records
        ]
        
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to retrieve disability types: {str(e)}"
        )


@router.post(
    "/search",
    response_model=list[DisabilityTypeRead],
    summary="Search disability types",
    description="Search disability types with multiple criteria"
)
async def search_disability_types(
    search_params: DisabilityTypeSearch,
    keycloak_user: Annotated[UserInSignInKeyCloak, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)],
    skip: int = 0,
    limit: int = 100,
) -> list[DisabilityTypeRead]:
    """
    Search disability types with multiple criteria.
    
    Args:
        search_params: Search parameters
        keycloak_user: Authenticated user information
        db: Database session
        skip: Number of records to skip
        limit: Maximum number of records to return
        
    Returns:
        List of matching disability types
    """
    
    # Validate user
    await validate_user(keycloak_user.username, keycloak_user, db)
    
    try:
        records = await crud_disability_type.search_types(
            db=db, 
            search_params=search_params, 
            skip=skip, 
            limit=limit
        )
        
        return [
            DisabilityTypeRead(
                id=record.id,
                title=record.title,
                code=record.code,
                description=record.description,
                status=record.status,
                created_by=record.created_by,
                updated_by=record.updated_by
            )
            for record in records
        ]
        
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to search disability types: {str(e)}"
        )


@router.get(
    "/stats",
    response_model=DisabilityTypeStats,
    summary="Get disability type statistics",
    description="Get comprehensive statistics about disability types"
)
async def get_disability_type_statistics(
    keycloak_user: Annotated[UserInSignInKeyCloak, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)]
) -> DisabilityTypeStats:
    """
    Get comprehensive statistics about disability types.
    
    Args:
        keycloak_user: Authenticated user information
        db: Database session
        
    Returns:
        Statistics about disability types
    """
    
    # Validate user
    await validate_user(keycloak_user.username, keycloak_user, db)
    
    try:
        return await crud_disability_type.get_statistics(db=db)
        
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to retrieve statistics: {str(e)}"
        )


@router.get(
    "/{disability_type_id}",
    response_model=DisabilityTypeRead,
    summary="Get disability type by ID",
    description="Retrieve a specific disability type by its ID"
)
async def get_disability_type(
    disability_type_id: int,
    keycloak_user: Annotated[UserInSignInKeyCloak, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)]
) -> DisabilityTypeRead:
    """
    Get a specific disability type by ID.
    
    Args:
        disability_type_id: ID of the disability type to retrieve
        keycloak_user: Authenticated user information
        db: Database session
        
    Returns:
        Disability type details
    """
    
    # Validate user
    await validate_user(keycloak_user.username, keycloak_user, db)
    
    try:
        record = await crud_disability_type.get(db=db, id=disability_type_id)
        if not record or record.get("is_deleted"):
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="Disability type not found"
            )
        
        # return DisabilityTypeRead(
        #     id=record.id,
        #     title=record.title,
        #     code=record.code,
        #     description=record.description,
        #     status=record.status,
        #     created_by=record.created_by,
        #     updated_by=record.updated_by
        # )

        return DisabilityTypeRead(**record)
        
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to retrieve disability type: {str(e)}"
        )


@router.put(
    "/{disability_type_id}",
    response_model=DisabilityTypeRead,
    summary="Update disability type",
    description="Update an existing disability type"
)
async def update_disability_type(
    disability_type_id: int,
    disability_type_update: DisabilityTypeUpdate,
    keycloak_user: Annotated[UserInSignInKeyCloak, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)]
) -> DisabilityTypeRead:
    """
    Update an existing disability type.
    
    Args:
        disability_type_id: ID of the disability type to update
        disability_type_update: Update data
        keycloak_user: Authenticated user information
        db: Database session
        
    Returns:
        Updated disability type
    """
    
    # Validate user
    db_user = await validate_user(keycloak_user.username, keycloak_user, db)
    user_id = db_user["id"]
    
    try:
        # Check if record exists
        existing_record = await crud_disability_type.get(db=db, id=disability_type_id)
        if not existing_record or existing_record.is_deleted:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="Disability type not found"
            )
        
        # Check for duplicate code if being updated
        if disability_type_update.code and disability_type_update.code != existing_record.code:
            if await crud_disability_type.check_duplicate_code(db, disability_type_update.code, disability_type_id):
                raise HTTPException(
                    status_code=status.HTTP_409_CONFLICT,
                    detail=f"Disability type with code '{disability_type_update.code}' already exists"
                )
        
        # Check for duplicate title if being updated
        if disability_type_update.title and disability_type_update.title != existing_record.title:
            if await crud_disability_type.check_duplicate_title(db, disability_type_update.title, disability_type_id):
                raise HTTPException(
                    status_code=status.HTTP_409_CONFLICT,
                    detail=f"Disability type with title '{disability_type_update.title}' already exists"
                )
        
        # Prepare update data
        update_data = DisabilityTypeUpdateInternal(
            **disability_type_update.dict(exclude_unset=True),
            updated_by=user_id
        )
        
        # Update the record
        updated_record = await crud_disability_type.update(db=db, id=disability_type_id, object=update_data)
        
        return DisabilityTypeRead(
            id=updated_record.id,
            title=updated_record.title,
            code=updated_record.code,
            description=updated_record.description,
            status=updated_record.status,
            created_by=updated_record.created_by,
            updated_by=updated_record.updated_by
        )
        
    except HTTPException:
        raise
    except IntegrityError:
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT,
            detail="Duplicate code or title constraint violation"
        )
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to update disability type: {str(e)}"
        )


@router.put(
    "/{disability_type_id}/status",
    response_model=DisabilityTypeRead,
    summary="Update disability type status",
    description="Update only the status of a disability type"
)
async def update_disability_type_status(
    disability_type_id: int,
    new_status: bool,
    keycloak_user: Annotated[UserInSignInKeyCloak, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)]
) -> DisabilityTypeRead:
    """
    Update only the status of a disability type.
    
    Args:
        disability_type_id: ID of the disability type to update
        new_status: New status to set (True for active, False for inactive)
        keycloak_user: Authenticated user information
        db: Database session
        
    Returns:
        Updated disability type
    """
    
    # Validate user
    db_user = await validate_user(keycloak_user.username, keycloak_user, db)
    user_id = db_user["id"]
    
    try:
        # Update status
        updated_record = await crud_disability_type.update_status(
            db=db, 
            record_id=disability_type_id, 
            new_status=new_status, 
            updated_by=user_id
        )
        
        if not updated_record:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="Disability type not found"
            )
        
        return DisabilityTypeRead(
            id=updated_record.id,
            title=updated_record.title,
            code=updated_record.code,
            description=updated_record.description,
            status=updated_record.status,
            created_by=updated_record.created_by,
            updated_by=updated_record.updated_by
        )
        
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to update disability type status: {str(e)}"
        )


@router.delete(
    "/{disability_type_id}",
    summary="Delete disability type",
    description="Soft delete a disability type (mark as deleted)"
)
async def delete_disability_type(
    disability_type_id: int,
    keycloak_user: Annotated[UserInSignInKeyCloak, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)]
) -> dict:
    """
    Soft delete a disability type.
    
    Args:
        disability_type_id: ID of the disability type to delete
        keycloak_user: Authenticated user information
        db: Database session
        
    Returns:
        Deletion confirmation
    """
    
    # Validate user
    db_user = await validate_user(keycloak_user.username, keycloak_user, db)
    
    try:
        # Check if record exists
        existing_record = await crud_disability_type.get(db=db, id=disability_type_id)
        if not existing_record or existing_record.is_deleted:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="Disability type not found"
            )
        
        # Soft delete the record
        await crud_disability_type.db_delete(db=db, id=disability_type_id)
        
        return {
            "message": f"Disability type '{existing_record.title}' has been deleted successfully",
            "deleted_id": disability_type_id
        }
        
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to delete disability type: {str(e)}"
        )


@router.post(
    "/seed",
    summary="Seed predefined disability types",
    description="Insert all predefined disability types from the template into the database"
)
async def seed_disability_types(
    keycloak_user: Annotated[UserInSignInKeyCloak, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)]
) -> dict:
    """
    Seed the database with predefined disability types.
    
    This endpoint inserts all the standard disability types with Khmer titles
    and Q-codes as defined in the template.
    
    Args:
        keycloak_user: Authenticated user information
        db: Database session
        
    Returns:
        Summary of the seeding operation
    """

    logging.info("keycloak_user", keycloak_user)
    
    # Validate user
    db_user = await validate_user(keycloak_user.username, keycloak_user, db)
    user_id = db_user["id"]
    
    # Predefined disability types with Khmer titles and codes
    DISABILITY_TYPES = [
        # Physical Disabilities - Q1
        {"title": "ពិការភាពកាយសម្បទា", "code": "Q1", "description": "ពិការភាពផ្នែកកាយសម្បទា និងចលនា", "parent_code": None, "image": "ពិការភាពកាយសម្បទា.png"},
        {"title": "ពិបាកធ្វើចលនាលើ", "code": "Q1_1", "description": "ពិបាកធ្វើចលនាផ្នែកខាងលើនៃរាងកាយ", "parent_code": "Q1", "image": "ពិបាកធ្វើចលនាលើ.png"},
        {"title": "ពិបាកធ្វើចលនាក្រោម", "code": "Q1_2", "description": "ពិបាកធ្វើចលនាផ្នែកខាងក្រោមនៃរាងកាយ", "parent_code": "Q1", "image": "ពិបាកធ្វើចលនាក្រោម.png"},
        {"title": "ពិបាកសម្របសម្រួលដងខ្លួនខ្នង", "code": "Q1_3", "description": "ពិបាកក្នុងការសម្របសម្រួលដងខ្លួនខ្នង", "parent_code": "Q1", "image": "ពិបាកសម្របសម្រួលដងខ្លួនខ្នង.png"},
        {"title": "ពិការភាពសិរីរាង្គខាងក្នុង", "code": "Q1_4", "description": "ពិការភាពសិរីរាង្គខាងក្នុងរាងកាយ", "parent_code": "Q1", "image": "ពិការភាពសិរីរាង្គខាងក្នុង.png"},
        
        # Sensory Disabilities - Q2
        {"title": "ពិការភាពញ្ញាណដឹង", "code": "Q2", "description": "ពិការភាពផ្នែកញ្ញាណ និងការដឹងស្គាល់", "parent_code": None, "image": "ពិការភាពញ្ញាណដឹង.png"},
        {"title": "ពិបាកស្តាប់", "code": "Q2_1", "description": "ពិបាកក្នុងការស្តាប់ឮ", "parent_code": "Q2", "image": "ពិបាកស្តាប់.png"}, 
        {"title": "ពិបាកនិយាយ", "code": "Q2_2", "description": "ពិបាកក្នុងការនិយាយ", "parent_code": "Q2", "image": "ពិបាកនិយាយ.png"},
        {"title": "ពិបាកមើល", "code": "Q2_3", "description": "ពិបាកក្នុងការមើលឃើញ", "parent_code": "Q2", "image": "ពិបាកមើល.png"},
        
        # Intellectual Disabilities - Q3
        {"title": "ពិការភាពសតិបញ្ញា", "code": "Q3", "description": "ពិការភាពផ្នែកសតិបញ្ញា និងការយល់ដឹង", "parent_code": None, "image": "ពិការភាពសតិបញ្ញា.png"},
        {"title": "ដោស៊ីនដ្រូម", "code": "Q3_1", "description": "ជំងឺដោស៊ីនដ្រូម", "parent_code": "Q3", "image": "ដោស៊ីនដ្រូម.png"},
        {"title": "អូទីស្សឹម", "code": "Q3_2", "description": "ជំងឺអូទីស្សឹម", "parent_code": "Q3", "image": "អូទីស្សឹម.png"},
        {"title": "ពិការចលករខួរក្បាល(ស៊ីភី)", "code": "Q3_3", "description": "ពិការចលករខួរក្បាល (Cerebral Palsy)", "parent_code": "Q3", "image": "ពិការចលករខួរក្បាល(ស៊ីភី).png"},
        
        # Mental Health Disabilities - Q4
        {"title": "ពិការផ្លូវចិត្ត", "code": "Q4", "description": "ពិការភាពផ្នែកផ្លូវចិត្ត និងអារម្មណ៍", "parent_code": None, "image": "ពិការភាពភ្លូវចិត្ត.png"},
        {"title": "ពិការភាពផ្លូវចិត្ត", "code": "Q4_1", "description": "ពិការភាពផ្លូវចិត្តទូទៅ", "parent_code": "Q4", "image": "ពិការភាពផ្លូវចិត្ត.png"},
        {"title": "ពិបាកចងចាំ", "code": "Q4_2", "description": "ពិបាកក្នុងការចងចាំ និងការចាំ", "parent_code": "Q4", "image": "ពិបាកចងចាំ.png"},
        
        # Other Disabilities - Q5
        {"title": "ពិការភាពផ្សេងៗ", "code": "Q5", "description": "ពិការភាពប្រភេទផ្សេងៗ", "parent_code": None, "image": "ពិការភាពផ្សេងៗ.png"},
        {"title": "ជំងឺរមួលសារពាង្គកាយមិនប្រក្រតី", "code": "Q5_1", "description": "ជំងឺរុំរលាយសារពាង្គកាយមិនប្រក្រតី", "parent_code": "Q5", "image": "ជំងឺរមួលសារពាង្គកាយមិនប្រក្រតី.png"},
        {"title": "ពិការភាពផ្សេងៗ", "code": "Q5_2", "description": "ពិការភាពប្រភេទផ្សេងៗដទៃទៀត", "parent_code": "Q5", "image": "ពិការភាពផ្សេង.png"},

        #living enviroment - Q6
        {"title": "បរិស្ថានរស់នៅ", "code": "Q6", "description": "បរិស្ថានរស់នៅ", "parent_code": None, "image": "បរិស្ថានរស់នៅ.png"},
        {"title": "សកម្មភាពសង្គម", "code": "Q6_1", "description": "បរិស្ថានរស់នៅ", "parent_code": "Q6", "image": "សកម្មភាពសង្គម.png"},
        {"title": "ជំនួយការផ្ទាល់ខ្លួន", "code": "Q6_2", "description": "បរិស្ថានរស់នៅ", "parent_code": "Q6", "image": "ជំនួយការផ្ទាល់ខ្លួន.png"},
        {"title": "ឧបករណ៍ជំនួយ", "code": "Q6_3", "description": "បរិស្ថានរស់នៅ", "parent_code": "Q6", "image": "ឧបករណ៍ជំនួយ.png"},
    ]
    
    try:
        inserted_count = 0
        skipped_count = 0
        failed_items = []
        
        for disability_type_data in DISABILITY_TYPES:
            try:
                # Check if disability type with this code already exists
                existing = await crud_disability_type.get_by_code(db, disability_type_data["code"])
                
                if existing:
                    skipped_count += 1
                    continue
                # Create new disability type
                disability_type_create = DisabilityTypeCreateInternal(
                    title=disability_type_data["title"],
                    code=disability_type_data["code"],
                    description=disability_type_data["description"],
                    parent_code=disability_type_data["parent_code"],
                    image=disability_type_data["image"],
                    status=True,
                    created_by=user_id
                )
                
                # Insert into database
                await crud_disability_type.create(db=db, object=disability_type_create)
                inserted_count += 1
                
            except Exception as e:
                failed_items.append({
                    "code": disability_type_data["code"],
                    "title": disability_type_data["title"],
                    "error": str(e)
                })
        
        # Get final count
        total_in_db = len(await crud_disability_type.get_all_active(db=db, limit=1000))
        
        return {
            "message": "Disability types seeding completed",
            "summary": {
                "total_processed": len(DISABILITY_TYPES),
                "inserted": inserted_count,
                "skipped": skipped_count,
                "failed": len(failed_items),
                "total_in_database": total_in_db
            },
            "failed_items": failed_items,
            "status": "success" if len(failed_items) == 0 else "partial_success"
        }
        
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to seed disability types: {str(e)}"
        )


@router.post(
    "/question",
    summary = "Questions of disability types",
    description = "Insert all question disability types from the template into the database"
)
async def question_disability_types(
    keycloak_user: Annotated[UserInSignInKeyCloak, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)]
) -> dict: 
    """
    Seed the database with question disability types.
    
    This endpoint inserts all the question disability types with Khmer titles
    
    Args:
        keycloak_user: Authenticated user information
        db: Database session
        
    Returns:
        Summary of the seeding operation
    """

    logging.info("keycloak_user", keycloak_user)
    
    # Validate user
    db_user = await validate_user(keycloak_user.username, keycloak_user, db)
    user_id = db_user["id"]


    QUESTION_DISABILITY_TYPES = [
        # Age under 8 years old
        # Physical disability
        {"question": "តើកុមារអាចប្រើមេដៃចាប់កាន់ ឬលើកវត្ថុអ្វីមួយបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាលើ", "parent_code": "Q1_1", "unique_code": "Q1_1_1"},
        {"question": "តើកុមារអាចប្រើម្រាមដៃរើសវត្ថុដាក់ ដោះ ឬបិទឡេវអាវបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាលើ", "parent_code": "Q1_1", "unique_code": "Q1_1_2"},
        {"question": "តើកុមារអាចបង្វិលកដៃទៅឆ្វេង ឬស្តាំបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាលើ", "parent_code": "Q1_1", "unique_code": "Q1_1_3"},
        {"question": "តើកុមារអាចបត់កែងដៃ ដោយដាក់ចុងដៃលើស្មាបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាលើ", "parent_code": "Q1_1", "unique_code": "Q1_1_4"},
        {"question": "តើកុមារអាចលើក ដាក់ ឬទាញ វត្ថុបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាលើ", "parent_code": "Q1_1", "unique_code": "Q1_1_5"},
        {"question": "តើកុមារអាចលើកដៃដាក់ទៅមុខត្រឹមភ្នែកខ្លួនងងបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាលើ", "parent_code": "Q1_1", "unique_code": "Q1_1_6"},
        {"question": "តើកុមារអាចញាក់ ឬបង្វិលស្មាបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាលើ", "parent_code": "Q1_1", "unique_code": "Q1_1_7"},

        {"question": "តើកុមារអាចឈរអោយមានលំនឹងមួយកន្លែងលើសពី១នាទីបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាក្រោម", "parent_code": "Q1_2", "unique_code": "Q1_2_1"},
        {"question": "តើកុមារអាចដើរលើបន្ទាត់ត្រង់បានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាក្រោម", "parent_code": "Q1_2", "unique_code": "Q1_2_2"},
        {"question": "តើកុមារអាចដើរចុងជើង ឬចង្អើតចុងជើងបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាក្រោម", "parent_code": "Q1_2", "unique_code": "Q1_2_3"},
        {"question": "តើកុមារអាចបង្វិលកជើង ទៅឆ្វេង ឬទៅស្តាំ ឡើង ឬចុះបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាក្រោម", "parent_code": "Q1_2", "unique_code": "Q1_2_4"},
        {"question": "តើកុមារអាចឡើងចុះកៅអីកម្ពស់៣តឹកបានដែរឬទេ? (សាច់ដុំជើង)", "description": "ពិបាកធើ្វចលនាក្រោម", "parent_code": "Q1_2", "unique_code": "Q1_2_5"},
        {"question": "តើកុមារអាចឡើងចុះកាំជណ្តើរបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាក្រោម", "parent_code": "Q1_2", "unique_code": "Q1_2_6"},
        {"question": "តើកុមារអាចឡើងចុះកាំជណ្តើរបានដែរឬទេ ពេលមានអ្នកជួយ ឬឧបករណ៍ជំនួយ?", "description": "ពិបាកធើ្វចលនាក្រោម", "parent_code": "Q1_2", "unique_code": "Q1_2_7"},
        {"question": "តើកុមារអាចដើរដោយខ្លួនងងបានចម្ងាយប៉ុន្មានម៉ែត្រ?", "description": "ពិបាកធើ្វចលនាក្រោម", "parent_code": "Q1_2", "unique_code": "Q1_2_8"},
        {"question": "តើកុមារអាចដើរបានប៉ុន្មានម៉ែត្រ ដោយប្រើឧបករណ៍ជំនួយ ឬមានអ្នកជួយ?", "description": "ពិបាកធើ្វចលនាក្រោម", "parent_code": "Q1_2", "unique_code": "Q1_2_9"},

        {"question": "តើកុមារដេកក្នុងសភាពចុះខ្សោយខ្លាំងដែរឬទេ?", "description": "ពិបាកសម្របសម្រួលដងខ្លួន និងខ្នង", "parent_code": "Q1_3", "unique_code": "Q1_3_1"},
        {"question": "តើកុមារអាចក្រោកអង្គុយដោយគ្មានជំនួយបានដែរឬទេ?", "description": "ពិបាកសម្របសម្រួលដងខ្លួន និងខ្នង", "parent_code": "Q1_3", "unique_code": "Q1_3_2"},
        {"question": "តើកុមារបាត់បង់មុខងារចលករមួយចំហៀងខ្លួនឆ្វេង ឬស្តាំ ឬទាំងសងខាងដែរឬទេ? (លើស៦ខែ)", "description": "ពិបាកសម្របសម្រួលដងខ្លួន និងខ្នង", "parent_code": "Q1_3", "unique_code":"Q1_3_3"},
        {"question": "តើដងខ្លួនរបស់កុមារខូចទ្រង់ទ្រាយដែរឬទេ? (វៀច កោង គម ជាអចិន្រ្តៃយ៍)", "description": "ពិបាកសម្របសម្រួលដងខ្លួន និងខ្នង", "parent_code": "Q1_3", "unique_code": "Q1_3_4"},
        {"question": "តើដងខ្លួន និងអវយវះរបស់កុមារញាក់ញ៍រ ឬស្ពឹកខ្លាំងដែរឬទេ? (លើស៦ខែ)", "description": "ពិបាកសម្របសម្រួលដងខ្លួន និងខ្នង", "parent_code": "Q1_3", "unique_code": "Q1_3_5"},
        {"question": "តើកុមារធ្លាប់មានរបួសខួរឆ្អឹងខ្នងដែរឬទេ?", "description": "ពិបាកសម្របសម្រួលដងខ្លួន និងខ្នង", "parent_code": "Q1_3", "unique_code": "Q1_3_6"},
        {"question": "តើកុមារបាត់បង់មុខងារចលករត្រឹមចង្កេះចុះក្រោមដែរឬទេ? (លើស៦ខែ)", "description": "ពិបាកសម្របសម្រួលដងខ្លួន និងខ្នង", "parent_code": "Q1_3", "unique_code": "Q1_3_7"},
        {"question": "តើកុមារឈឺចាប់ខ្លាំងជាប្រចាំត្រង់ក​ ចង្កេះ ឬដងខ្លួនដែរទេ? (ឈឺជាអចិន្រ្តៃយ៍)", "description": "ពិបាកសម្របសម្រួលដងខ្លួន និងខ្នង", "parent_code": "Q1_3", "unique_code": "Q1_3_8"},
        {"question": "តើកុមារប្រើថ្នាំលេប ឬចាក់ជាប្រចាំដែរឬទេ? (លើស៦ខែ)", "description": "ពិបាកសម្របសម្រួលដងខ្លួន និងខ្នង", "parent_code": "Q1_3", "unique_code": "Q1_3_9"},

        {"question": "តើកុមារធ្លាប់មានការវះកាត់ធំលើសសរីរាង្គខាងក្នុងដែរឬទេ?", "description": "ពិការភាពសរីរាង្គខាងក្នុង", "parent_code": "Q1_4", "unique_code": "Q1_4_1"},
        {"question": "តើសរីរាង្គខាងក្នុងរបស់កុមារធ្លាប់ឈឺចាប់ដែរឬទេ?", "description": "ពិការភាពសរីរាង្គខាងក្នុង", "parent_code": "Q1_4", "unique_code": "Q1_4_2"},
        {"question": "តើកុមារប្រើឧបករណ៍ជំនួយសរីរាង្គដែរឬទេ?", "description": "ពិការភាពសរីរាង្គខាងក្នុង", "parent_code": "Q1_4", "unique_code": "Q1_4_3"},
        {"question": "តើកុមារប្រើថ្នាំពេទ្យដែរឬទេ សម្រាប់ជំងឺដែលបានវះកាត់ធំ?", "description": "ពិការភាពសរីរាង្គខាងក្នុង", "parent_code": "Q1_4", "unique_code": "Q1_4_4"},
        {"question": "តើកុមារអាចដើរ ឬលោតបានដែរឬទេចាប់តាំងពីក្រោយវះកាត់ធំ?", "description": "ពិការភាពសរីរាង្គខាងក្នុង", "parent_code": "Q1_4", "unique_code": "Q1_4_5"},
        {"question": "តើកុមារអាចមើលថែទាំអនាម័យខ្លួនងង ឬរស់នៅដោយងករាជ្យបានដែរឬទេ?", "description": "ពិការភាពសរីរាង្គខាងក្នុង", "parent_code": "Q1_4", "unique_code": "Q1_4_6"},

        # Cognitive disability
        {"question": "តើកុមារអាចស្តាប់ព្ឬដែរឬទេ?", "description": "ពិបាកស្តាប់", "parent_code": "Q2_1", "unique_code": "Q2_1_1"},
        {"question": "តើកុមារមានប្រើឧបករណ៍ជំនួយការស្តាប់ជាប្រចាំដែរឬទេ?", "description": "ពិបាកស្តាប់", "parent_code": "Q2_1", "unique_code": "Q2_1_2"},
        {"question": "បើខ្ញុំគោះប៊ិកលើបាតដៃរបស់ខ្ញុំ តើកុមារស្តាប់ព្ឬដែរឬទេ? (គោះស្តាំឆ្វេងពីមុខ ពីក្រោយ)", "description": "ពិបាកស្តាប់", "parent_code": "Q2_1", "unique_code": "Q2_1_3"},
        {"question": "តើកុមារពិបាកស្តាប់ ឬយល់ពីនរណាម្នាក់និយាយដែរឬទេ?", "description": "ពិបាកស្តាប់", "parent_code": "Q2_1", "unique_code": "Q2_1_4"},
        {"question": "តើកុមារមានបញ្ហាក្នុងការស្តាប់វិទ្យា ឬទូរទស្សន៍ដែរឬទេ? (ទោះបើកសំឡេងខ្លាំងៗក៏ដោយ)", "description": "ពិបាកស្តាប់", "parent_code": "Q2_1", "unique_code": "Q2_1_5"},
        {"question": "តើកុមារពិបាកស្តាប់ នៅពេលនរណាម្នាក់និយាយតិចៗដែរឬទេ?", "description": "ពិបាកស្តាប់", "parent_code": "Q2_1", "unique_code": "Q2_1_6"},
        {"question": "តើកុមារមានបញ្ហាស្តាប់ ដែលបណ្តាលអោយអ្នកប្រកែកជាមួយគេញឹកញាប់ដែរឬទេ?", "description": "ពិបាកស្តាប់", "parent_code": "Q2_1", "unique_code": "Q2_1_7"},

        {"question": "តើកុមារអាចនិយាយ ឬសន្ទនាបានដែរឬទេ?", "description": "ពិបាកនិយាយ", "parent_code": "Q2_2", "unique_code": "Q2_2_1"},
        {"question": "តើកុមារអាចនិយាយលើសពី ៥ ពាក្យជាប់គ្នាដែរឬទេ?", "description": "ពិបាកនិយាយ", "parent_code": "Q2_2", "unique_code": "Q2_2_2"},
        {"question": "តើកុមារប្រើភាសាសញ្ញា ឬភាសាកាយវិការដែរឬទេ ពេលនិយាយ?", "description": "ពិបាកនិយាយ", "parent_code": "Q2_2", "unique_code": "Q2_2_3"},
        {"question": "តើកុមារពិបាក ក្នុងការនិយាយភាសាកំណើតរបស់ខ្លួនច្បាស់ដែរឬទេ?", "description": "ពិបាកនិយាយ", "parent_code": "Q2_2", "unique_code":"Q2_2_4"},
        {"question": "តើកុមារអាចនិយាយត្រាប់តាមបានដែរឬទេ?", "description": "ពិបាកនិយាយ", "parent_code": "Q2_2", "unique_code":"Q2_2_5"},
        {"question": "តើកុមារនិយាយ ដោយប្រើខ្យល់ច្រមុះ(ក្ងួរ) ដែរឬទេ?", "description": "ពិបាកនិយាយ", "parent_code": "Q2_2", "unique_code": "Q2_2_6"},
        {"question": "តើកុមារមានការពិបាកបញ្ចេញសូរសំឡេងដែរឬទេ?", "description": "ពិបាកនិយាយ", "parent_code": "Q2_2", "unique_code": "Q2_2_7"},

        {"question": "តើកុមារអាចមើលឃើញ ក្នុងបរិយាកាសធម្មតាដែរឬទេ?", "description": "ពិបាកមើល", "parent_code": "Q2_3", "unique_code": "Q2_3_1"},
        {"question": "តើកុមារអាចមើលឃើញច្បាស់ដែរឬទេទោះពាក់វ៉ែនតាក៏ដោយ?", "description": "ពិបាកមើល", "parent_code": "Q2_3", "unique_code": "Q2_3_2"},
        {"question": "តើកុមារអាចមើលឃើញម្រាមដៃច្បាស់ក្នុងចម្ងាយ ៥ ម៉ែត្រដែរឬទេ? (ទោះពាក់វែនតាក៏ដោយ)", "description": "ពិបាកមើល", "parent_code": "Q2_3", "unique_code": "Q2_3_3"},
        {"question": "តើកុមារអាចមើលឃើញម្រាមដៃច្បាស់ក្នុងចម្ងាយ៣ម៉ែត្រដែរឬទេ? (ទោះពាក់វ៉ែនតាក៏ដោយ)", "description": "ពិបាកមើល", "parent_code": "Q2_3", "unique_code":"Q2_3_4"},
        {"question": "តើកុមារអាចមើលឃើញម្រាមដៃច្បាស់ក្នុងចម្ងាយ៤០ម៉ែត្របានដែរឬទេ? (ពាក់វ៉ែនតាក៏ដោយ)", "description": "ពិបាកមើល", "parent_code": "Q2_3", "unique_code": "Q2_3_5"},
        {"question": "តើកុមារអាចមើលឃើញពណ៏ (បែតង ខៀវ ក្រហម លឿង) ដែរឬទេ?", "description": "ពិបាកមើល", "parent_code": "Q2_3", "unique_code": "Q2_3_6"},

        # Intellectual disability
        {"question": "តើកុមារដេក ឬសរីរាង្គកាយ ពិសេសសាច់ដុំស្ថិតក្នុងសភាពចុះខ្សោយខ្លាំងដែរឬទេ?", "description": "ដោនស៊ីនដ្រូម", "parent_code": "Q3_1", "unique_code": "Q3_1_1"},
        {"question": "តើកុមារមានឥរិយាបថពិបាកសម្របខ្លួនជាមួយសង្គមដែរឬទេ?", "description": "ដោនស៊ីនដ្រូម", "parent_code": "Q3_1", "unique_code": "Q3_1_2"},
        {"question": "តើកុមារមានការនិយាយម្តងហើយម្តងទៀត ឬរវើរវាយដែរឬទេ? (និយាយដដែលៗ)", "description": "ដោនស៊ីនដ្រូម", "parent_code": "Q3_1", "unique_code": "Q3_1_3"},
        {"question": "តើកុមារនិយាយច្រើន ឬតិចតួចបំផុត ប៉ុន្តែពិបាកយល់ពីការប្រាស្រ័យទាក់ទងតាមពាក្យសម្តីដែរឬទេ?", "description": "ដោនស៊ីនដ្រូម", "parent_code": "Q3_1", "unique_code": "Q3_1_4"},
        {"question": "តើកុមារមានអាកប្បកិរិយារញ៉េរញ៉ៃ ឬចលនាម្តងទៅនេះម្តងទៅនោះដែរឬទេ?", "description": "ដោនស៊ីនដ្រូម", "parent_code": "Q3_1", "unique_code": "Q3_1_5"},
        {"question": "តើកុមារធ្លាប់រវើរវាយ ឬចង់ធើ្វនេះធើ្វនោះមិនធម្មតាដែរឬទេ?", "description": "ដោនស៊ីនដ្រូម", "parent_code": "Q3_1", "unique_code": "Q3_1_6"},
        {"question": "តើកុមារពិបាកនិយាយគ្នាលើរឿងតែមួយ ឬរក្សាការសន្ទនាគ្នាទៅវិញទៅមកដែរឬទេ?", "description": "ដោនស៊ីនដ្រូម", "parent_code": "Q3_1", "unique_code": "Q3_1_7"},
        {"question": "តើកុមារពិបាកក្នុងការយល់ដឹងពីអារម្មណ៍កុមារដទៃដែរឬទេ?", "description": "ដោនស៊ីនដ្រូម", "parent_code": "Q3_1", "unique_code": "Q3_1_8"},

        {"question": "តើកុមារនិយាយតិចតួចហើយផ្តល់ចម្លើយមិនទាក់ទងទៅនឹងសំណួរដែរឬទេ?", "description": "អូទីស្សឹម", "parent_code": "Q3_2", "unique_code": "Q3_2_1"},
        {"question": "តើកុមារមិនឆ្លើយតប បើហៅឈ្មោះចំៗ ឬគេចវេសពីការមើលភ្នែកដែរឬទេ?", "description": "អូទីស្សឹម", "parent_code": "Q3_2", "unique_code": "Q3_2_2"},
        {"question": "តើកុមារពិបាកយល់អំពីអារម្មណ៍របស់កុមារដទៃដែរឬទេ?", "description": "អូទីស្សឹម", "parent_code": "Q3_2", "unique_code": "Q3_2_3"},
        {"question": "តើកុមារងាយនឹងតូចចិត្តដែរឬទេ បើយើងផ្លាស់ប្តូរ ឬយកអ្វីមួយពីពួកគេ?", "description": "អូទីស្សឹម", "parent_code": "Q3_2", "unique_code": "Q3_2_4"},
        {"question": "តើកុមារតែងមានចំណាប់អារម្មណ៍ងប់និងអ្វីមួយដែរឬទេ? (ធើ្វអីធ្វើនឹង មិនរវល់ ឬតប)", "description": "អូទីស្សឹម", "parent_code": "Q3_2", "unique_code": "Q3_2_5"},
        {"question": "តើកុមារងាយប្តូរអារម្មណ៍តានតឹង ឬរំភើបពេលប៉ះ ចាប់ រងក្លិន រសជាតិ ឬសំឡេងអ្វីមួយដែរឬទេ?", "description": "អូទីស្សឹម", "parent_code": "Q3_2", "unique_code": "Q3_2_6"},
        {"question": "តើកុមារពិបាកទំនាក់ទំនងសង្គមជាមួយមនុស្សដទៃទៀតដែរឬទេ? (និយាយត្រាប់តាម ឬឡងពាក្យ)", "description": "អូទីស្សឹម", "parent_code": "Q3_2", "unique_code": "Q3_2_7"},
        {"question": "តើកុមារមិនអោយកុមារផ្សេង ឬអ្នកដទែដែលមិនស្គាល់ប៉ះដៃ ឬរូបរាងកាយដែរឬទេ?", "description": "អូទីស្សឹម", "parent_code": "Q3_2", "unique_code": "Q3_2_8"},
        {"question": "តើកុមារបង្ហាញការយល់ដឹងតិចតួចអំពីស្ថានភាពគ្រោះថ្នាក់ដែរឬទេ?", "description": "អូទីស្សឹម", "parent_code": "Q3_2", "unique_code": "Q3_2_9"},

        {"question": "តើកុមារអាចដើរក្នុងផ្ទះ ឬក្រៅផ្ទះ និងឡើងជណ្តើរដោយខ្លួនងងមិនចាំបាត់ជួយកាន់ដៃដែរឬទេ?", "description": "ពិការចលករខួរក្បាល(ស៊ីភី)", "parent_code": "Q3_3", "unique_code": "Q3_3_1"},
        {"question": "តើកុមារអាចធើ្វសកម្មភាព ដូចជារត់ ឬលោតបានដែរឬទេ?", "description": "ពិការចលករខួរក្បាល(ស៊ីភី)", "parent_code": "Q3_3", "unique_code": "Q3_3_2"},
        {"question": "តើកុមារមានការថមថយកម្លាំង ឬល្បឿនលំនឹងខ្លួន និងការសម្របសម្រួលសាច់ដុំដែរឬទេ?", "description": "ពិការចលករខួរក្បាល(ស៊ីភី)", "parent_code": "Q3_3", "unique_code": "Q3_3_3"},
        {"question": "តើកុមារប្រើរទេះរុញជាប្រចាំ ដោយខ្លួនងងបានដែរឬទេ?", "description": "ពិការចលករខួរក្បាល(ស៊ីភី)", "parent_code": "Q3_3", "unique_code": "Q3_3_4"},
        {"question": "តើកុមារអាចឈរបានដែរឬទេ?", "description": "ពិការចលករខួរក្បាល(ស៊ីភី)", "parent_code": "Q3_3", "unique_code": "Q3_3_5"},
        {"question": "តើកុមារពិបាកបញ្ជកាយសម្បទា ធើ្វចលនា និងចល័តដែរឬទេ?", "description": "ពិការចលករខួរក្បាល(ស៊ីភី)", "parent_code": "Q3_3", "unique_code": "Q3_3_6"},
        {"question": "តើកុមារមានការពិបាកគ្រប់ផ្នែកកាយសម្បទាទាំងអស់ដែរឬទេ?", "description": "ពិការចលករខួរក្បាល(ស៊ីភី)", "parent_code": "Q3_3", "unique_code": "Q3_3_7"},
        {"question": "តើកុមារមានសមត្ថភាពការពារក្បាល ក និងទីតាំងផ្សេងទៀតដោយខ្លួនងងដែរឬទេ?", "description": "ពិការចលករខួរក្បាល(ស៊ីភី)", "parent_code": "Q3_3", "unique_code": "Q3_3_8"},

        # Mentally disabled
        {"question": "តើកុមារមានអារម្មណ៍ពិបាកចិត្ត ឆាប់ខឹង ឆាប់ភ័យញ័រ ថប់បារម្ភ ឬតានតឹងខ្លាំងដែរឬទេ?", "description": "ពិការផ្លូវចិត្ត", "parent_code": "Q4_1", "unique_code": "Q4_1_1"},
        {"question": "តើកុមារមានអារម្មណ៍ចង់បោកក្បាលខ្លួនងងជាប្រចាំដែរឬទេ?", "description": "ពិការផ្លូវចិត្ត", "parent_code": "Q4_1", "unique_code": "Q4_1_2"},
        {"question": "តើកុមារមានអារម្មណ៍ចង់នៅតែម្នាក់ងង ឬខ្លាចគេងងមកជិតដែរឬទេ?", "description": "ពិការផ្លូវចិត្ត", "parent_code": "Q4_1", "unique_code": "Q4_1_3"},
        {"question": "តើកុមារមានអារម្មណ៍បោចទាញ ចង់វៃ ជេរប្រទេច បំផ្លិចបំផ្លាញជាញឹកញាប់ដែរឬទេ?", "description": "ពិការផ្លូវចិត្ត", "parent_code": "Q4_1", "unique_code": "Q4_1_4"},
        {"question": "តើកុមារមានអារម្មណ៍ធុញទ្រាន់ខ្លាំង ឬក្តោបត្រចៀកជាញឹកញាប់ ពេលនរណាម្នាក់និយាយដែរឬទេ?", "description": "ពិការផ្លូវចិត្ត", "parent_code": "Q4_1", "unique_code": "Q4_1_5"},
        {"question": "រៀងរាល់ពេលឃើញមនុស្សច្រើន តើកុមារយំខ្លាំងដែរឬទេ? (ទោះជាមនុស្សធ្លាប់ស្គាល់ឬជួបពីមុន)", "description": "ពិការផ្លូវចិត្ត", "parent_code": "Q4_1", "unique_code": "Q4_1_6"},
        {"question": "តើកុមារឧស្សាហ៍យំតែម្នាក់ងង ដោយមិនមានមូលហេតុដែរឬទេ?", "description": "ពិការផ្លូវចិត្ត", "parent_code": "Q4_1", "unique_code": "Q4_1_7"},

        {"question": "បើធៀបនឹងកុមារអាយុដំណាលគ្នា តើកុមារចេះប្រាប់ ឬបង្ហាញពីច្រមុះ មាត់ ត្រចៀក ឬភ្នែកដែរឬទេ?", "description": "ពិបាកចងចាំ", "parent_code": "Q4_2", "unique_code": "Q4_2_1"},
        {"question": "បើធៀបនឹងកុមារអាយុដំណាលគ្នា តើកុមារអាចធើ្វតាមការប្រាប់ដែលសាមញ្ញៗ បានដែរឬទេ?", "description": "ពិបាកចងចាំ", "parent_code": "Q4_2", "unique_code": "Q4_2_2"},
        {"question": "តើកុមារអាចស្គាល់ឈ្មោះសត្វ ដែលមនុស្សទូទៅស្គាល់ដែរឬទេ?", "description": "ពិបាកចងចាំ", "parent_code": "Q4_2", "unique_code": "Q4_2_3"},
        {"question": "តើកុមាររៀបចំគំនិត ក្នុងការនិយាយ ឬសរសេរ តាមការប្រាប់ដែរឬទេ?", "description": "ពិបាកចងចាំ", "parent_code": "Q4_2", "unique_code": "Q4_2_4"},
        {"question": "តើកុមារដឹងពីសកម្មភាពដែលត្រូវធើ្វតាមលំដាប់លំដោយ ដែលបានប្រាប់ដែរឬទេ?", "description": "ពិបាកចងចាំ", "parent_code": "Q4_2", "unique_code": "Q4_2_5"},
        {"question": "តើកុមារអាចនិយាយអ្វីដែលបានកើតឡើងពីម្សិលមិញ ឬកន្លងមកបានដែរឬទេ?", "description": "ពិបាកចងចាំ", "parent_code": "Q4_2", "unique_code": "Q4_2_6"},
        {"question": "តើការរៀនរបស់កុមារ ស្របតាមការលូតលាស់របស់កុមារដែរឬទេ?", "description": "ពិបាកចងចាំ", "parent_code": "Q4_2", "unique_code": "Q4_2_7"},

        # Other disabilities
        {"question": "តើកុមារធ្លាប់ប្រកាច់ ឬឆ្កួតជ្រូកក្នុងរយះពេល៣ខែចុងក្រោយដែរឬទេ?", "description": "ជំងឺរមួលសារពាង្គកាយមិនប្រក្រតី", "parent_code": "Q5_1", "unique_code":"Q5_1_1"},
        {"question": "តើកុមារធ្លាប់មានជំងឺប្រកាច់ ឬប្រកាច់បណ្តាលមកពីគ្រុនក្តៅខ្លាំងដែរឬទេ?", "description": "ជំងឺរមួលសារពាង្គកាយមិនប្រក្រតី", "parent_code": "Q5_1", "unique_code": "Q5_1_2"},
        {"question": "តើការប្រកាច់ ឬជំងឺឆ្កួតជ្រូកមិនអាចគ្រប់គ្រងបាន ទោះបីជាមានការព្យាបាលនៅមន្ទីរពេទ្យ និងការព្យាបាលដោយថ្នាំដែរឬទេ? (ចាំបាច់ត្រូវមានការបញ្ជាក់ពីមណ្ធលសុខភាព)", "description": "ជំងឺរមួលសារពាង្គកាយមិនប្រក្រតី", "parent_code": "Q5_1", "unique_code": "Q5_1_3"},
        {"question": "តើកុមារធ្លាប់បញ្ជូនទៅមន្ទីរពេទ្យ ៥ដង ឬលើសពីនេះ ដោយសារការប្រកាច់ ឬជំងឺឆ្កួតជ្រូកដែរឬទេ?", "description": "ជំងឺរមួលសារពាង្គកាយមិនប្រក្រតី", "parent_code": "Q5_1", "unique_code": "Q5_1_4"},
        {"question": "តើកុមារធ្លាប់ប្រកាច់ធើ្វអោយរបួសរាង្គកាយធ្ងន់ធ្ងរ ត្រូវព្យាបាលភ្លាមៗ ឬសម្រាកព្យាបាលនៅមន្ទីរពេទ្យដែរឬទេ?", "description": "ជំងឺរមួលសារពាង្គកាយមិនប្រក្រតី", "parent_code": "Q5_1", "unique_code": "Q5_1_5"},
        {"question": "តើកុមារធ្លាប់ប្រើថ្នាំសម្រាប់ការពារប្រកាច់ដែរឬទេ?", "description": "ជំងឺរមួលសារពាង្គកាយមិនប្រក្រតី", "parent_code": "Q5_1", "unique_code": "Q5_1_6"},

        {"question": "តើកុមារមានជំងឺរាំរៃ (លើសពី៦ខែ) ប្រចាំកាយដែរឬទេ?", "description": "ជំងឺរាំរៃ", "parent_code": "Q5_2", "unique_code": "Q5_2_1"},
        {"question": "តើកុមារធ្លាប់មានរបួស ឬវះកាត់ធំសរីរាង្គខាងក្នុងដែរឬទេ?", "description": "ជំងឺរាំរៃ", "parent_code": "Q5_2", "unique_code": "Q5_2_2"},
        {"question": "តើកុមារត្រូវការប្រើប្រាស់ថ្នាំព្យាបាលជាប្រចាំដែរឬទេ?", "description": "ជំងឺរាំរៃ", "parent_code": "Q5_2", "unique_code": "Q5_2_3"},
        {"question": "តើជំងឺរបស់កុមារមានការឈឺចាប់ជាប្រចាំដែរឬទេ?", "description": "ជំងឺរាំរៃ", "parent_code": "Q5_2", "unique_code": "Q5_2_4"},
        {"question": "តើកុមារត្រូវការពិគ្រោះយោបល់ និងព្យាបាលជាប្រចាំជាមួយគ្រូពេទ្យដែរឬទេ?", "description": "ជំងឺរាំរៃ", "parent_code": "Q5_2", "unique_code": "Q5_2_5"},
        {"question": "តើកុមារអាចធើ្វចលនា ឬហាត់ប្រាណដោយខ្លួនងងដែរឬទេ?", "description": "ជំងឺរាំរៃ", "parent_code": "Q5_2", "unique_code": "Q5_2_6"},
        {"question": "តើជំងឺរបស់កុមារបានបង្កផលពិបាកដល់សកម្មភាពប្រចាំថ្ងៃរបស់កុមារដែរឬទេ?", "description": "ជំងឺរាំរៃ", "parent_code": "Q5_2", "unique_code": "Q5_2_7"},
        {"question": "តើជំងឺរបស់កុមារបានប៉ះពាល់ដល់អារម្មណ៍របស់កុមារ (ខឹង មួរមឍ៉ៅ ខ្លាច ) ដែរឬទេ?", "description": "ជំងឺរាំរៃ", "parent_code": "Q_5", "unique_code": "Q5_2_8"},

        # Living environment
        {"question": "ធៀបទៅនឹងកុមារដែលមានអាយុដំណាលគ្នា តើកុមារលេងជាមួយក្មេងដទៃដែរឬទេ?", "description": "សកម្មភាពសង្គម", "parent_code": "Q6_1", "unique_code": "Q6_1_1"},
        {"question": "ធៀបជាមួយកុមារមានអាយុដំណាលគ្នា តើកុមារជាធម្មតាបង្ហាញការអាណិតដល់ក្មេងដទៃដែរឬទេ?", "description": "សកម្មភាពសង្គម", "parent_code": "Q6_1", "unique_code": "Q6_1_2"},

        {"question": "តើមាននរណាម្នាក់ចាំជួយមើលកុមារធើ្វសកម្មភាពជាប្រចាំលើសពី ៨ ម៉ោងដែរឬទេ?", "description": "ជំនួយការ", "parent_code": "Q6_2", "unique_code": "Q6_2_1"},
        {"question": "តើកុមារត្រូវការជំនួយបន្ថែមក្នុងសកម្មភាពប្រចាំថ្ងៃនៅផ្ទះ ឬក្រៅផ្ទះនៅពេលពួកគេធំឡើងដែរឬទេ?", "description": "ជំនួយការ", "parent_code": "Q6_2","unique_code":"Q6_2_2"},
        {"question": "តើកុមារត្រូវការជំនួយក្នុងសកម្មភាពប្រចាំថ្ងៃដែរឬទេ?", "description": "ជំនួយការ", "parent_code": "Q6_2","unique_code": "Q6_2_3"},
        {"question": "តើកុមារត្រូវការ ការជំនួយក្នុងសកម្មភាពប្រចាំថ្ងៃ (២៤ ៧) ដែរឬទេ?", "description": "ជំនួយការ", "parent_code": "Q6_2","unique_code":"Q6_2_4"},

        # Auxiliary equipment


        #Age over 8 years old
        # Physical disability
        {"question": "តើអ្នកអាចប្រើមេដៃចាប់កាន់ ឬលើកវត្ថុអ្វីមួយបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាលើ", "parent_code": "Q1.1", "unique_code": "Q1.1.1"},
        {"question": "តើអ្នកអាចប្រើម្រាមដៃរើសវត្ថុដាក់ ដោះឬបិទឡេវអាវបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាលើ", "parent_code": "Q1.1", "unique_code": "Q1.1.2"},
        {"question": "តើអ្នកអាចបង្វិលកដៃទៅឆ្វេង ឬស្តាំបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាលើ", "parent_code": "Q1.1", "unique_code": "Q1.1.3"},
        {"question": "តើអ្នកអាចបត់កែងដៃ ដោយដាក់ចុងដៃលើស្មាបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាលើ", "parent_code": "Q1.1", "unique_code": "Q1.1.4"},
        {"question": "តើអ្នកអាចលើក ដាក់ ឬទាញ វត្ថុទម្ងន់ កន្លះគីឡូក្រាម ឬធ្ងន់ជាងនេះបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាលើ", "parent_code": "Q1.1", "unique_code":"Q1.1.5"},
        {"question": "តើអ្នកអាចលើកដៃដាក់ទៅមុខត្រឹមភ្នែកខ្លួនងងបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាលើ", "parent_code": "Q1.1", "unique_code": "Q1.1.6"},
        {"question": "តើអ្នកអាចញាក់ ឬបង្វិលស្មាបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាលើ", "parent_code": "Q1.1", "unique_code": "Q1.1.7"},

        {"question": "តើអ្នកអាចឈរអោយមានលំនឹងមួយកន្លែងលើសពី១០នាទីបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាក្រោម", "parent_code": "Q1.2", "unique_code": "Q1.2.1"},
        {"question": "តើអ្នកអាចដើរលើបន្ទាត់ត្រង់លើសពី១០នាទីដែរឬទេ?", "description": "ពិបាកធើ្វចលនាក្រោម", "parent_code": "Q1.2", "unique_code": "Q1.2.2"},
        {"question": "តើអ្នកអាចដើរ ចុងជើង ឬចង្អើតចុងជើងបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាក្រោម", "parent_code": "Q1.2", "unique_code": "Q1.2.3"},
        {"question": "តើអ្នកអាចបង្វិលកជើង ទៅឆ្វេង ឬទៅស្តាំ ឡើង ឬចុះបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាក្រោម", "parent_code": "Q1.2", "unique_code": "Q1.2.4"},
        {"question": "តើអ្នកអាចឡើងចុះកៅអីកម្ពស់៣តឹកបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាក្រោម", "parent_code": "Q1.2", "unique_code": "Q1.2.5"},
        {"question": "តើអ្នកអាចឡើងចុះកាំជណ្តើរបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាក្រោម", "parent_code": "Q1.2", "unique_code": "Q1.2.6"},
        {"question": "តើអ្នកអាចឡើងចុះកាំជណ្តើរបានដែរឬទេ ពេលមានអ្នកជួយ ឬតោងយឺតបង្កាន់ដៃ?", "description": "ពិបាកធើ្វចលនាក្រោម", "parent_code": "Q1.2", "unique_code": "Q1.2.7"},
        {"question": "តើអ្នកអាចដើរដោយខ្លួនងង ដោយគ្មានអ្នកជួយបានចម្ងាយប៉ុន្មានម៉ែត្រ?", "description": "ពិបាកធើ្វចលនាក្រោម", "parent_code": "Q1.2", "unique_code": "Q1.2.8"},
        {"question": "តើអ្នកអាចដើរបានប៉ុន្មានម៉ែត្រ ដោយប្រើឧបករណ៍ជំនួយ ឬមានអ្នកជួយ?", "description": "ពិបាកធើ្វចលនាក្រោម", "parent_code": "Q1.2", "unique_code": "Q1.2.9"},

        {"question": "តើអ្នកដេកក្នុងសភាពចុះខ្សោយខ្លាំងដែរឬទេ?", "description": "ពិបាកសម្របសម្រួលដងខ្លួន និងខ្នង", "parent_code": "Q1.3", "unique_code": "Q1.3.1"},
        {"question": "តើអ្នកអាចក្រោកអង្គុយដោយគ្មានជំនួយបានដែរឬទេ?", "description": "ពិបាកសម្របសម្រួលដងខ្លួន និងខ្នង", "parent_code": "Q1.3", "unique_code": "Q1.3.2"},
        {"question": "តើអ្នកបាត់បង់មុខងារចលករមួយចំហៀងខ្លួនឆ្វេង ឬស្តាំសងខាងដែរឬទេ? (លើស៦ខែ)", "description": "ពិបាកសម្របសម្រួលដងខ្លួន និងខ្នង", "parent_code": "Q1.3", "unique_code": "Q1.3.3"},
        {"question": "តើដងខ្លួនរបស់អ្នកខូចទ្រង់ទ្រាយដែរឬទេ? (វៀច កោង គម ជាអចិន្រែ្តយ៍)", "description": "ពិបាកសម្របសម្រួលដងខ្លួន និងខ្នង", "parent_code": "Q1.3", "unique_code": "Q1.3.4"},
        {"question": "តើដងខ្លួន និងអវយវះរបស់ញាក់ញ័រឬស្ពឹកខ្លាំងឬទេ? (លើស៦ខែ)", "description": "ពិបាកសម្របសម្រួលដងខ្លួន និងខ្នង", "parent_code": "Q1.3", "unique_code": "Q1.3.5"},
        {"question": "តើអ្នកធ្លាប់មានរបួសខួរឆ្អឹងខ្នងដែររទេ?", "description": "ពិបាកសម្របសម្រួលដងខ្លួន និងខ្នង", "parent_code": "Q1.3", "unique_code": "Q1.3.6"},
        {"question": "តើអ្នកអាចប្រើមុខងារចលករត្រឹមចង្កេះចុះក្រោមដែរឬទេ? (លើស៦ខែ)", "description": "ពិបាកសម្របសម្រួលដងខ្លួន និងខ្នង", "parent_code": "Q1.3", "unique_code": "Q1.3.7"},
        {"question": "តើអ្នកឈឺចាប់ខ្លាំងជាប្រចាំត្រង់ក ចង្កេះ ឬដងខ្លួនដែរទេ? (ឈឺជាអចិន្រៃយ៍)", "description": "ពិបាកសម្របសម្រួលដងខ្លួន និងខ្នង", "parent_code": "Q1.3", "unique_code": "Q1.3.8"},
        {"question": "តើអ្នកប្រើថ្នាំលេប ឬចាក់ជាប្រចាំដែរឬទេ? (លើស៦ខែ)", "description": "ពិបាកសម្របសម្រួលដងខ្លួន និងខ្នង", "parent_code": "Q1.3", "unique_code": "Q1.3.9"},

        {"question": "តើអ្នកធ្លាប់មានការវះកាត់ធំលើសសរីរាង្គខាងក្នុងដែរឬទេ?", "description": "ពិការភាពសរីរាង្គខាងក្នុង", "parent_code": "Q1.4", "unique_code": "Q1.4.1"},
        {"question": "តើសរីរាង្គខាងក្នុងរបស់អ្នកធ្លាប់ឈឺចាប់ដែរឬទេ?", "description": "ពិការភាពសរីរាង្គខាងក្នុង", "parent_code": "Q1.4", "unique_code": "Q1.4.2"},
        {"question": "តើអ្នកប្រើឧបករណ៍ជំនួយសរីរាង្គឬទេ?", "description": "ពិការភាពសរីរាង្គខាងក្នុង", "parent_code": "Q1.4", "unique_code": "Q1.4.3"},
        {"question": "តើអ្នកប្រើថ្នាំពេទ្យដែរឬទេ សម្រាប់ជំងឺដែលបានវះកាត់ធំ?", "description": "ពិការភាពសរីរាង្គខាងក្នុង", "parent_code": "Q1.4", "unique_code": "Q1.4.4"},
        {"question": "តើអ្នកអាចដើរ ឬលោតបានដែរឬទេចាប់តាំងពីក្រោយវះកាត់ធំ?", "description": "ពិការភាពសរីរាង្គខាងក្នុង", "parent_code": "Q1.4", "unique_code": "Q1.4.5"},
        {"question": "តើអ្នកអាចមើលថែទាំអនាម័យខ្លួនងង ឬរស់នៅដោយងករាជ្យបានដែរឬទេ?", "description": "ពិការភាពសរីរាង្គខាងក្នុង", "parent_code": "Q1.4", "unique_code": "Q1.4.6"},


        # Cognitive disability
        {"question": "តើអ្នកអាចស្តាប់ព្ឬដែរ ឬទេ?", "description": "ពិបាកស្តាប់", "parent_code": "Q2.1", "unique_code": "Q2.1.1"},
        {"question": "តើអ្នកមានប្រើឧបករណ៍ជំនួយការស្តាប់ជាប្រចាំដែរឬទេ?", "description": "ពិបាកស្តាប់", "parent_code": "Q2.1", "unique_code": "Q2.1.2"},
        {"question": "បើខ្ញុំគោះប៊ិកលើបាតដៃរបស់ខ្ញុំ តើអ្នកស្តាប់ព្ឬដែរឬទេ? (គោះស្តាំឆ្វេងពីមុខពីក្រោយ", "description": "ពិបាកស្តាប់", "parent_code": "Q2.1", "unique_code": "Q2.1.3"},
        {"question": "តើអ្នកពិបាកស្តាប់ ឬយល់ពីនរណាម្នាក់និយាយដែរឬទេ?", "description": "ពិបាកស្តាប់", "parent_code": "Q2.1", "unique_code": "Q2.1.4"},
        {"question": "តើអ្នកមានបញ្ហក្នុងការស្តាប់វិទ្យុ ឬទូរទស្សន៍ដែរឬទេ? (ទោះបើកសំឡេងខ្លាំងៗក៏ដោយ)", "description": "ពិបាកស្តាប់", "parent_code": "Q2.1", "unique_code": "Q2.1.5"},
        {"question": "តើអ្នកពិបាកស្តាប់ នៅពេលនរណាម្នាក់និយាយតិចៗដែរឬទេ?", "description": "ពិបាកស្តាប់", "parent_code": "Q2.1", "unique_code": "Q2.1.6"},
        {"question": "តើអ្នកមានបញ្ហស្តាប់ដែលបណ្តាលអោយអ្នកប្រកែកជាមួយគេញឹកញាប់ដែរឬទេ?", "description": "ពិបាកស្តាប់", "parent_code": "Q2.1", "unique_code":"Q2.1.7"},

        {"question": "តើអ្នកអាចនិយាយ ឬសន្ទនាបានដែរឬទេ?", "description": "ពិបាកនិយាយ", "parent_code": "Q2.2", "unique_code": "Q2.2.1"},
        {"question": "តើអ្នកអាចនិយាយលើសពី៥០ពាក្យបានដែរឬទេ?", "description": "ពិបាកនិយាយ", "parent_code": "Q2.2", "unique_code":"Q2.2.2"},
        {"question": "តើអ្នកប្រើភាសាសញ្ញា ឬភាសាកាយវិការដែរឬទេ ពេលនិយាយ?", "description": "ពិបាកនិយាយ", "parent_code": "Q2.2", "unique_code": "Q2.2.3"},
        {"question": "តើអ្នកពិបាក ក្នុងការនិយាយភាសាកំណើតរបស់ខ្លួនច្បាស់ដែរឬទេ?", "description": "ពិបាកនិយាយ", "parent_code": "Q2.2", "unique_code": "Q2.2.4"},
        {"question": "តើអ្នកអាចនិយាយត្រាប់តាមបានដែរឬទេ?", "description": "ពិបាកនិយាយ", "parent_code": "Q2.2", "unique_code": "Q2.2.5"},
        {"question": "តើអ្នកនិយាយ ដោយប្រើខ្យល់ច្រមុះ (ក្ថួរ) ដែរឬទេ?", "description": "ពិបាកនិយាយ", "parent_code": "Q2.2", "unique_code": "Q2.2.6"},
        {"question": "តើអ្នកពិបាកនិយាយ ឬសន្ទនានៅក្នុងកន្លែង ឬបន្ទប់មានមនុស្សកកកុញដែរឬទេ?", "description": "ពិបាកនិយាយ", "parent_code": "Q2.2", "unique_code": "Q2.2.7"},

        {"question": "តើអ្នកអាចមើលឃើញ ក្នុងបរិយាកាសធម្មតាដែរឬទេ?", "description": "ពិបាកមើល", "parent_code": "Q2.3", "unique_code": "Q2.3.1"},
        {"question": "តើអ្នកអាចមើលឃើញច្បាស់ដែរឬទេ ទោះពាក់វ៉ែនតាក៏ដោយ?", "description": "ពិបាកមើល", "parent_code": "Q2.3", "unique_code": "Q2.3.2"},
        {"question": "តើអ្នកអាចក្រឡេកមើលឃើញដៃរបស់គាត់ឃើញដែរឬទេ?", "description": "ពិបាកមើល", "parent_code": "Q2.3", "unique_code": "Q2.3.3"},
        {"question": "តើអ្នកអាចធើ្វសញ្ញា ឬសកម្មភាពត្រាប់តាម ឬបញេ្ជញទឹកមុខតាមអ្នកដទៃបានដែរឬទេ?", "description": "ពិបាកមើល", "parent_code": "Q2.3", "unique_code": "Q2.3.4"},
        {"question": "តើអ្នកព្រិចភ្នែកដែរឬទេ ពេកត្រូវពន្លឺ?", "description": "ពិបាកមើល", "parent_code": "Q2.3", "unique_code": "Q2.3.5"},
        {"question": "តើអ្នកអាចមើលឃើញពណ៏ (បែតង ខៀវ ក្រហម លឿង) ដែរឬទេ?", "description": "ពិបាកមើល", "parent_code": "Q2.3", "unique_code": "Q2.3.6"},
        {"question": "តើអ្នកអាចមើលឃើញម្រាមដៃច្បាស់ក្នុងចម្ងាយ៥ម៉ែត្រដែរឬទេ? (ទោះពាក់វ៉ែនតាក៏ដោយ)", "description": "ពិបាកមើល", "parent_code": "Q2.3", "unique_code": "Q2.3.7"},
        {"question": "តើអ្នកអាចមើលម្រាមដៃច្បាស់ក្នុងចម្ងាយ៣ម៉ែត្រដែរឬទេ? (ទោះពាក់វ៉ែនតាក៏ដោយ)", "description": "ពិបាកមើល", "parent_code": "Q2.3", "unique_code": "Q2.3.8"},
        {"question": "តើអ្នកអាចមើលឃើញម្រាមដៃច្បាស់ក្នុងចម្ងាយ៤០សង់ទីម៉ែត្របានដែរឬទេ? (ពាក់វ៉ែនតាក៏ដោយ)", "description": "ពិបាកមើល", "parent_code": "Q2.3", "unique_code": "Q2.3.9"},
        {"question": "តើអ្នកអាចដើរទៅមុខ ដោយខ្លួនងងបានដែរឬទេ? (ប្រើដៃ ដើម្បីរកផ្លូវដើរ)", "description": "ពិបាកមើល", "parent_code": "Q2.3", "unique_code": "Q2.3.10"},

        # Intellectual disability
        {"question": "តើអ្នកដេក ឬសរីរាង្គកាយ ពិសេសសាច់ដុំ ស្ថិតក្នុងសភាពចុះខ្សោយខ្លាំងដែរឬទេ?", "description": "ដោនស៊ីនដ្រូម", "parent_code": "Q3.1", "unique_code": "Q3.1.1"},
        {"question": "តើអ្នកមានឥរិយាបថពិបាកសម្របខ្លួនជាមួយសង្គមដែរឬទេ?", "description": "ដោនស៊ីនដ្រូម", "parent_code": "Q3.1", "unique_code": "Q3.1.2"},
        {"question": "តើអ្នកមានការនិយាយម្តងងើយម្តងទៀតឬរវើយរវាយដែរឬទេ? (និយាយដដែលៗ)", "description": "ដោនស៊ីនដ្រូម", "parent_code": "Q3.1", "unique_code": "Q3.1.3"},
        {"question": "តើអ្នកនិយាយច្រើន ឬតិចតួចបំផុត ប៉ុន្តែពិបាកយល់ពីការប្រាស្រ័យទាក់ទងតាមពាក្យសម្តីដែរឬទេ?", "description": "ដោនស៊ីនដ្រូម", "parent_code": "Q3.1", "unique_code": "Q3.1.4"},
        {"question": "តើអ្នកមានអាកប្បកិរិយារញេរញៃ ឬចលនាម្តងទៅនេះម្តងទៅនោះដែរឬទេ?", "description": "ដោនស៊ីនដ្រូម", "parent_code": "Q3.1", "unique_code": "Q3.1.5"},
        {"question": "តើអ្នកធ្លាប់រវើរវាយ ឬចង់ធ្វើនេះធើ្វនោះមិនធម្មតាដែរឬទេ?", "description": "ដោនស៊ីនដ្រូម", "parent_code": "Q3.1", "unique_code": "Q3.1.6"},
        {"question": "តើអ្នកពិបាកនិយាយគ្នាលើរឿងតែមួយឬរក្សាការសន្ទនាគ្នាទៅវិញទៅមកដែរឬទេ?", "description": "ដោនស៊ីនដ្រូម", "parent_code": "Q3.1", "unique_code": "Q3.1.7"},
        {"question": "តើអ្នកពិបាកក្នុងការយល់ដឹងពីអារម្មណ៍អ្នកដទៃដែរឬទេ?", "description": "ដោនស៊ីនដ្រូម", "parent_code": "Q3.1", "unique_code": "Q3.1.8"},
        {"question": "តើអ្នកចូលចិត្តជជែកអំពីរឿងខ្លួនងងជាងរឿងអ្នកដទៃដែរឬទេ?", "description": "ដោនស៊ីនដ្រូម", "parent_code": "Q3.1", "unique_code": "Q3.1.9"},

        {"question": "តើអ្នកនិយាយតិចតួចហើយផ្តល់ចម្លើយមិនទាក់ទងទៅនិងសំណួរដែរឬទេ?", "description": "អូទីស្សឹម", "parent_code": "Q3.2", "unique_code": "Q3.2.1"},
        {"question": "តើអ្នកមិនឆ្លើយតប បើហៅឈ្មោះចំៗ ឬគេចវេសពីការមើលភ្នែកដែរឬទេ?", "description": "អូទីស្សឹម", "parent_code": "Q3.2", "unique_code": "Q3.2.2"},
        {"question": "តើអ្នកពិបាកយល់អំពីអារម្មណ៍របស់អ្នកឌទៃដែរឬទេ?", "description": "អូទីស្សឹម", "parent_code": "Q3.2", "unique_code": "Q3.2.3"},
        {"question": "តើអ្នកងាយនឹងខកចិត្តដែររទេ បើយើងផ្លាស់ប្តូរ ឬយកអ្វីមួយពិពួកគេ?", "description": "អូទីស្សឹម", "parent_code": "Q3.2", "unique_code": "Q3.2.4"},
        {"question": "តើអ្នកតែងមានចំណាប់អារម្មណ៍ងប់ងល់នឹងអ្វីមួយដែរឬទេ?", "description": "អូទីស្សឹម", "parent_code": "Q3.2", "unique_code": "Q3.2.5"},
        {"question": "តើអ្នកងាយប្តូរអាម្មណ៍តានតឹង ឬរំភើប ពេលប៉ះ ចាប់ រងក្លិន រសជាតិ ឬសំភេងអ្វីមួយដែរឬទេ?", "description": "អូទីស្សឹម", "parent_code": "Q3.2", "unique_code": "Q3.2.6"},
        {"question": "តើអ្នកពិបាកទំនាក់ទំនងសង្គមជាមួយមនុស្សដទៃទៀតដែរឬទេ? (និយាយត្រាប់តាម ឬឡងពាក្យ)", "description": "អូទីស្សឹម", "parent_code": "Q3.2", "unique_code": "Q3.2.7"},
        {"question": "តើអ្នកមិនអោយអ្នកផ្សេង ឬអ្នកដទៃដែលមិនស្គាល់ប៉ះដៃ ឬប្តូររាងកាយដែរឬទេ?", "description": "អូទីស្សឹម", "parent_code": "Q3.2", "unique_code": "Q3.2.8"},
        {"question": "តើអ្នកបង្ហាញការយល់ដឹងតិចតួចអំពីស្ថានភាពគ្រោះថ្នាក់ដែរឬទេ?", "description": "អូទីស្សឹម", "parent_code": "Q3.2", "unique_code": "Q3.2.9"},

        {"question": "តើអ្នកអាចដើរក្នុងផ្ទះ ឬក្រៅផ្ទះ និងឡើងជណ្តើរដោយខ្លួនងងមិនចាំបាច់ជួយកាន់ដៃដែរឬទេ?", "description": "ពិការចលករខួរក្បាល(ស៊ីភី)", "parent_code": "Q3.3", "unique_code": "Q3.3.1"},
        {"question": "តើអ្នកអាចធើ្វសកម្មភាព ដូចជារត់ ឬលោតបានដែរឬទេ?", "description": "ពិការចលករខួរក្បាល(ស៊ីភី)", "parent_code": "Q3.3", "unique_code": "Q3.3.2"},
        {"question": "តើអ្នកមានការថមថយកម្លាំង ឬល្បឿនលំនឹង និងការសម្របសម្រួលសាច់ដុំដែរឬទេ?", "description": "ពិការចលករខួរក្បាល(ស៊ីភី)", "parent_code": "Q3.3", "unique_code": "Q3.3.3"},
        {"question": "តើអ្នកប្រើរទះរុញជាប្រចាំ ដោយខ្លួនងងបានដែរឬទេ?", "description": "ពិការចលករខួរក្បាល(ស៊ីភី)", "parent_code": "Q3.3", "unique_code": "Q3.3.4"},
        {"question": "តើអ្នកអាចឈរបានដែរឬទេ?", "description": "ពិការចលករខួរក្បាល(ស៊ីភី)", "parent_code": "Q3.3", "unique_code": "Q3.3.5"},
        {"question": "តើអ្នកពិបាកបញ្ជាកាយសម្បទា ធើ្វចលនានិងចល័តទីដែរឬទេ?", "description": "ពិការចលករខួរក្បាល(ស៊ីភី)", "parent_code": "Q3.3", "unique_code": "Q3.3.6"},
        {"question": "តើអ្នកមានការពិបាកគ្រប់ផ្នែកកាយសម្បទាទាំងអស់ដែរឬទេ?", "description": "ពិការចលករខួរក្បាល(ស៊ីភី)", "parent_code": "Q3.3", "unique_code": "Q3.3.7"},
        {"question": "តើអ្នកមានសមត្ថភាពការពារក្បាល ក និងទីតាំងផ្សេងទៀតដោយខ្លួនងងដែរឬទេ?", "description": "ពិការចលករខួរក្បាល(ស៊ីភី)", "parent_code": "Q3.3", "unique_code": "Q3.3.8"},

        # Mentally disabled
        {"question": "តើអ្នកមានអារម្មណ៍ពិបាកចិត្ត ឆាប់ខឹង ឆាប់ភ៏យញ៍រ ថប់បារម្ភ ឬតានតឹងខ្លាំងដែរឬទេ?", "description": "ពិការផ្លូវចិត្ត", "parent_code": "Q4.1", "unique_code": "Q4.1.1"},
        {"question": "តើអ្នកមានប្រើថ្នាំរម្ងាប់អារម្មណ៦ ឬថ្នាំសណ្តំដែររឬទេ?", "description": "ពិការផ្លូវចិត្ត", "parent_code": "Q4.1", "unique_code": "Q4.1.2"},
        {"question": "តើអ្នកមានអារម្មន៦ចង់នៅតែម្នាក់ងង ឬខ្លាចគេងងមកជិតដែរឬទេ?", "description": "ពិការផ្លូវចិត្ត", "parent_code": "Q4.1", "unique_code": "Q4.1.3"},
        {"question": "តើអ្នកមានអារម្មណ៍ចង់វ៉ៃ ជេរបញ្ជោរ ឬបំផ្លិតបំផ្លាញជាញឹកញាប់ដែរឬទេ?", "description": "ពិការផ្លូវចិត្ត", "parent_code": "Q4.1", "unique_code": "Q4.1.4"},
        {"question": "តើអ្នកមានអារម្មណ៍ធុញទ្រាន់ខ្លាំង ឬក្តោបត្រចៀកជាញឹកញាប់នរណាម្នាក់និយាយដែរឬទេ?", "description": "ពិការផ្លូវចិត្ត", "parent_code": "Q4.1", "unique_code": "Q4.1.5"},
        {"question": "តើអ្នកចូលចិត្តច្រៀងរាំតែម្នាក់ងងដែរឬទេ? (ទោះពេលយប់ជ្រៅក៏ដោយ)", "description": "ពិការផ្លូវចិត្ត", "parent_code": "Q4.1", "unique_code": "Q4.1.6"},
        {"question": "តើអ្នកឆ្លើយតបដោយកំហឹង នៅពេលអ្នកមានអារម្មណ៍ថាត្រូវបានគេប្រមាថដែរឬទេ?", "description": "ពិការផ្លូវចិត្ត", "parent_code": "Q4.1", "unique_code": "Q4.1.7"},
        {"question": "តើអ្នកមានអារម្មណ៍ភ័យព្រួយ ឬព្រួយបារម្ភខ្លាំង ហើយពិបាកគ្រប់គ្រងដែរឬទេ?", "description": "ពិការផ្លូវចិត្ត", "parent_code": "Q4.1", "unique_code": "Q4.1.8"},
        {"question": "តើអ្នកធ្លាប់ឈឺចាប់ផ្លូវចិត្តខ្លាំង រយះពេលជាច្រើនខែ បន្ទាប់ពីការបាតបង់អ្វីមួយដែរឬទេ?", "description": "ពិការផ្លូវចិត្ត", "parent_code": "Q4.1", "unique_code": "Q4.1.9"},
        {"question": "តើអ្នកពិបាកោផ្តោតអារម្មណ៍លើអ្វីផ្សេងក្រៅពីអ្នកជាទីស្រលាញ់ដែលបានបាត់បង់ដែរឬទេ?", "description": "ពិការផ្លូវចិត្ត", "parent_code": "Q4.1", "unique_code": "Q4.1.10"},

        {"question": "តើអ្នកអាចចូលរួមរៀនសូត្រ ហើយពិបាកចងចាំខ្លាំងដែរឬទេ?", "description": "ពិបាកចងចាំ", "parent_code": "Q4.2", "unique_code": "Q4.2.1"},
        {"question": "តើអ្នកធ្លាប់ភ្លេចអ្វីមួយដែលអ្នកទើបទុកដាក់ថ្មីៗដែរឬទេ?", "description": "ពិបាកចងចាំ", "parent_code": "Q4.2", "unique_code": "Q4.2.2"},
        {"question": "តើអ្នកឧស្សាហ៍ភ្លេច ហើយសួរម្តងហើយ ម្តងទៀតដែរឬទេ?", "description": "ពិបាកចងចាំ", "parent_code": "Q4.2", "unique_code": "Q4.2.3"},
        {"question": "តើអ្នកមានអារម្មណ៍ច្រឡំ ក្នុងពេលអំឡុងពេលសន្ទនា ហើយត្រូវឈប់សិនដែរឬទេ?", "description": "ពិបាកចងចាំ", "parent_code": "Q4.2", "unique_code": "Q4.2.4"},
        {"question": "តើអ្នកពិបាកចាំព្រឹត្តិការណ៍ ដូចជាថ្ងៃកំណើតខ្លួនងងដែរឬទេ?", "description": "ពិបាកចងចាំ", "parent_code": "Q4.2", "unique_code": "Q4.2.5"},
        {"question": "តើអ្នកឧស្សាហ៍បាត់បង់វត្ថុ និងមានអារម្មណ៍ថាគេលួចវត្ថុដែរឬទេ?", "description": "ពិបាកចងចាំ", "parent_code": "Q4.2", "unique_code": "Q4.2.6"},
        {"question": "តើអ្នកមានការពិបាកក្នុងការចងចាំលើការអនុវត្តអនាម័យល្អដែរឬទេ?", "description": "ពិបាកចងចាំ", "parent_code": "Q4.2", "unique_code": "Q4.2.7"},
        {"question": "តើអ្នកមានការផ្លាស់ប្តូរបុគ្គលិកលក្ខណះជាញឹកញាប់ដែរឬទេ? (ឆាប់ខឹង អន្ទះសារ ....)", "description": "ពិបាកចងចាំ", "parent_code": "Q4.2", "unique_code": "Q4.2.8"},
        {"question": "តើអ្នកពិបាកចាំពាក្យដែលខ្លួនងង ឬអ្នកដទៃនិយាយប្រាប់ពី បីនាទីមុនដែរឬទេ?", "description": "ពិបាកចងចាំ", "parent_code": "Q4.2", "unique_code": "Q4.2.9"},

        # Other disabilities
        {"question": "តើអ្នកធ្លាប់ប្រកាច់ ឬឆ្កួតជ្រូកក្នុងរយះពេល៣ខែចុងក្រោយដែរឬទេ?", "description": "ជំងឺរមួលសារពាង្គកាយមិនប្រក្រតី", "parent_code": "Q5.1", "unique_code": "Q5.1.1"},
        {"question": "តើអ្នកធ្លាប់ប្រកាច់ ឬប្រកាច់បណ្តោលមកពីគ្រុនក្តៅខ្លាំង ពេលនៅក្មេងដែរឬទេ?", "description": "ជំងឺរមួលសារពាង្គកាយមិនប្រក្រតី", "parent_code": "Q5.1", "unique_code": "Q5.1.2"},
        {"question": "តើការប្រកាច់ ឬជំងឺឆ្កួតជ្រូកមិនអាចគ្រប់គ្រងបាន ទោះបីជាមានការព្យាបាលនៅមន្ទីពេទ្យ និងការព្យបាលដោយថ្នាំដែរឬទេ? (ចាំបាច់ត្រូវមានការបញ្ជាក់ពីមណ្ធលសុខភាព)", "description": "ជំងឺរមួលសារពាង្គកាយមិនប្រក្រតី", "parent_code": "Q5.1", "unique_code": "Q5.1.3"},
        {"question": "តើអ្នកធ្លាប់បញ្ចូននៅមន្ទីរពេទ្យ ៦ដងឬលើសពីនេះ ដោយសារការប្រកាច់ ឬជំងឺឆ្កួតជ្រូកដែរឬទេ?", "description": "ជំងឺរមួលសារពាង្គកាយមិនប្រក្រតី", "parent_code": "Q5.1", "unique_code": "Q5.1.4"},
        {"question": "តើអ្នកធ្លាប់ប្រកាច់ធ្វើអោយរបួសរាង្គកាយធ្ងន់ធ្ងរ ត្រូវព្យបាលភ្លាមៗ ឬសម្រាកព្យាបាលនៅមន្ទីរពេទ្យដែរឬទេ?", "description": "ជំងឺរមួលសារពាង្គកាយមិនប្រក្រតី", "parent_code": "Q5.1", "unique_code": "Q5.1.5"},
        {"question": "តើអ្នកធ្លាប់ប្រើថ្នាំសម្រាប់ការពារប្រកាច់ដែរឬទេ?", "description": "ជំងឺរមួលសារពាង្គកាយមិនប្រក្រតី", "parent_code": "Q5.1", "unique_code": "Q5.1.6"},

        {"question": "តើអ្នកមានជំងឺរាំរៃ (លើសពី៦ខែ) ប្រចាំកាយដែរឬទេ?", "description": "ពិការភាពផ្សេងៗ", "parent_code": "Q5.2", "unique_code": "Q5.2.1"},
        {"question": "តើអ្នកធ្លាប់មានរបួស ឬវះកាត់ធំសរីរាង្គខាងក្នុងដែរឬទេ?", "description": "ពិការភាពផ្សេងៗ", "parent_code": "Q5.2", "unique_code": "Q5.2.2"},
        {"question": "តើអ្នកត្រូវការប្រើប្រាស់ថ្នាំព្យបាលជាប្រចាំដែរឬទេ?", "description": "ពិការភាពផ្សេងៗ", "parent_code": "Q5.2", "unique_code":"Q5.2.3"},
        {"question": "តើជងឺរបស់អ្នកមានការឺឈចាប់ជាប្រចាំដែរឬទេ?", "description": "ពិការភាពផ្សេងៗ", "parent_code": "Q5.2", "unique_code": "Q5.2.4"},
        {"question": "តើអ្នកត្រូវការពិគ្រោះយោបល់ និងព្យបាលជាប្រចាំជាមួយគ្រូពេទ្យដែរឬទេ?", "description": "ពិការភាពផ្សេងៗ", "parent_code": "Q5.2", "unique_code": "Q5.2.5"},
        {"question": "តើអ្នកអាចធើ្វចលនា ឬហាត់ប្រាណដោយច្លួនងងដែរឬទេ?", "description": "ពិការភាពផ្សេងៗ", "parent_code": "Q5.2", "unique_code": "Q5.2.6"},
        {"question": "តើជំងឺរបស់អ្នកបានបង្កផលពិបាកដល់សកម្មភាពប្រចាំរបស់អ្នកដែរឬទេ?", "description": "ពិការភាពផ្សេងៗ", "parent_code": "Q5.2", "unique_code": "Q5.2.7"},
        {"question": "តើជំងឺរបស់អ្នកបានប៉ះពាល់ដល់អារម្មណ៍របស់អ្នក (ខឹង មួរម៉ៅ ខ្លាច) ដែរឬទេ?", "description": "ពិការភាពផ្សេងៗ", "parent_code": "Q5.2", "unique_code": "Q5.2.8"},

        # Living environment
        {"question": "តើអ្នកពិបាកចូលរួមក្នុងសកម្មភាពរបស់សហគមន៍ដែរឬទេ?", "description": "សកម្មភាពសង្គម", "parent_code": "Q6.1", "unique_code": "Q6.1.1"},
        {"question": "តើអ្នកអាចទៅផ្សារ ហាងទំនិញ ធនាគារឬសាលាឃុំ សង្កត់ បានដោយងាយស្រួលដែរឬទេ?", "description": "សកម្មភាពសង្គម", "parent_code": "Q6.1", "unique_code": "Q6.1.2"},
        {"question": "តើប្រភេទមធ្យោបាយធើ្វដំណើរអ្វី ដែលអ្នកប្រើប្រាស់?", "description": "សកម្មភាពសង្គម", "parent_code": "Q6.1", "unique_code": "Q6.1.3"},
        {"question": "តើមធ្យោបាយធើ្វឌំណើរឆ្លើយតបតាមត្រូវការរបស់ជនមានពិការភាពដែរឬទេ?", "description": "សកម្មភាពសង្គម", "parent_code": "Q6.1", "unique_code": "Q6.1.4"},
        {"question": "តើអ្នកជាអ្នកសម្រេចចិត្តដោយខ្លួនងងអំពីសកម្មភាពប្រចាំថ្ងៃដែរឬទេ?", "description": "សកម្មភាពសង្គម", "parent_code": "Q6.1", "unique_code": "Q6.1.5"},
        {"question": "តើអ្នកមានអារម្មណ៍ថាអ្នកដទែមិនអោយតម្លៃឬមិនស្តាប់អ្វីដែលអ្នកនិយាយដែរឬទេ?", "description": "សកម្មភាពសង្គម", "parent_code": "Q6.1", "unique_code": "Q6.1.6"},

        {"question": "តើអ្នកត្រូវការជំនួយការសម្រាប់សកម្មភាពប្រចាំថ្ងៃដែររទេ?", "description": "ជំនួយការ", "parent_code": "Q6.2", "unique_code": "Q6.2.1"},
        {"question": "តើអ្នកត្រូវការ ការជំនួយក្នុងសកម្មភាពប្រចាំថ្ងៃ (២៤/៧) ដែរឬទេ?", "description": "ជំនួយការ", "parent_code": "Q6.2","unique_code": "Q6.2.2"},
        {"question": "តើនរណាជាអ្នកជួយអ្នកក្នុងសកម្មភាពប្រចាំថ្ងៃ? សូមបញ្ជាក់", "description": "ជំនួយការ", "parent_code": "Q6.2","unique_code": "Q6.2.3"},
        {"question": "ប្រសិនបើ អ្នកតម្រូវការជំនួយសកម្មភាពប្រចាំថ្ងៃ តើអ្នកមើលថែទាំមានពេលវេលាគ្រប់គ្រាន់សម្រាប់ជយយអ្នកដែរឬទេ?", "description": "ជំនួយការ", "parent_code": "Q6.2","unique_code": "Q6.2.4"},

    ]

    try:
        inserted_count = 0
        skipped_count = 0
        failed_items = []
        
        for question_disability_type_data in QUESTION_DISABILITY_TYPES:
            try:
                # Check if disability type with this code already exists
                existing = await crud_question.get_by_question(
                    db=db,
                    question=question_disability_type_data["question"]
                )
                
                if existing:
                    skipped_count += 1
                    continue
                # Create new disability type
                disability_type_create = QuestionCreateInternal(
                    question=question_disability_type_data["question"],
                    description=question_disability_type_data["description"],
                    parent_code=question_disability_type_data["parent_code"],
                    unique_code=question_disability_type_data["unique_code"],
                    created_by=user_id
                )
                
                # Insert into database
                await crud_question.create(db=db, object=disability_type_create)
                inserted_count += 1
                
            except Exception as e:
                await db.rollback()
                failed_items.append({
                    "question": question_disability_type_data["question"],
                    "error": str(e)
                })
        
        # Get final count
        total_in_db = len(await crud_question.get_all_active(db=db, limit=1000))
        
        return {
            "message": "Disability types seeding completed",
            "summary": {
                "total_processed": len(QUESTION_DISABILITY_TYPES),
                "inserted": inserted_count,
                "skipped": skipped_count,
                "failed": len(failed_items),
                "total_in_database": total_in_db
            },
            "failed_items": failed_items,
            "status": "success" if len(failed_items) == 0 else "partial_success"
        }
        
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to seed disability types: {str(e)}"
        )
    

@router.post(
    "/answer",
    summary = "Answer of Disability types",
    description = "Insert all answer disability types from the template into the database"
)
async def answer_disability_types(
    keycloak_user: Annotated[UserInSignInKeyCloak, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)]
) -> dict: 
    """
    Seed the database with question disability types.
    
    This endpoint inserts all the question disability types with Khmer titles
    
    Args:
        keycloak_user: Authenticated user information
        db: Database session
        
    Returns:
        Summary of the seeding operation
    """

    logging.info("keycloak_user", keycloak_user)
    
    # Validate user
    db_user = await validate_user(keycloak_user.username, keycloak_user, db)
    user_id = db_user["id"]

    ANSWER_DISABILITY_TYPES = [
        # Under 8 years-old
        {"answer": "គ្មានបញ្ហា", "description": "", "unique_code": "A1"},
        {"answer": "ធើ្វបានខ្លះៗ", "description": "", "unique_code": "A2"},
        {"answer": "ពិបាក ឬប្រើជំនួយ", "description": "", "unique_code": "A3"},
        {"answer": "មិនអាចធើ្វបាន", "description": "", "unique_code": "A4"},
        {"answer": "២៥០ម៉ែត្រឡើង", "description": "", "unique_code": "A5"},
        {"answer": "ចន្លោះ៥០-២៥០ម៉ែត្រ", "description": "", "unique_code": "A6"},
        {"answer": "៥០ម៉ែត្រចុះ", "description": "", "unique_code": "A7"},
        {"answer": "មិនចុះខ្សោយ", "description": "", "unique_code": "A8"},
        {"answer": "ខ្សោយតិចតួច", "description": "", "unique_code": "A9"},
        {"answer": "ខ្សោយបង្គួរ", "description": "", "unique_code": "A10"},
        {"answer": "ខ្សោយខ្លាំង", "description": "", "unique_code": "A11"},
        {"answer": "តិចតួច", "description": "", "unique_code": "A12"},
        {"answer": "បង្គួរ", "description": "", "unique_code": "A13"},
        {"answer": "ខ្លាំង", "description": "", "unique_code": "A14"},
        {"answer": "មិនធ្លាប់មាន", "description": "", "unique_code": "A15"},
        {"answer": "ធ្លាប់មាន", "description": "", "unique_code": "A16"},
        {"answer": "មិនដែល", "description": "", "unique_code": "A17"},
        {"answer": "ម្តងម្តាល", "description": "", "unique_code": "A18"},
        {"answer": "ញឹកញាប់", "description": "", "unique_code": "A19"},
        {"answer": "ជាប្រចាំ", "description": "", "unique_code": "A20"},
        {"answer": "មិនមាន", "description": "", "unique_code": "A21"},
        {"answer": "មាន", "description": "", "unique_code": "A22"},
        {"answer": "មិនត្រូវការ", "description": "", "unique_code": "A23"},
        {"answer": "ត្រូវការ", "description": "", "unique_code": "A24"},
        

        #Over 8 years-old
        {"answer": "សាធារណះ", "description": "", "unique_code": "A25"},
        {"answer": "មធ្យោបាយផ្ទាល់ខ្លួន", "description": "", "unique_code": "A26"},
        {"answer": "គ្មានមធ្យោបាយធើ្វដំណើរ", "description": "", "unique_code": "A27"},
        {"answer": "ទេ", "description": "", "unique_code": "A28"},
        {"answer": "បាទ/ចាស", "description": "", "unique_code": "A29"},
        {"answer": "តិចមានបញ្ហា", "description": "", "unique_code": "A30"},
        {"answer": "ឪពុកម្តាយបង្កើតម្នាក់ ឬ ទាំងពីរ", "description": "", "unique_code": "A31"},
        {"answer": "ឪពុកម្តាយចិញ្ចឹមម្នាក់ ឬ ទាំងពីរ", "description": "", "unique_code": "A32"},
        {"answer": "ជីដូនជីតាបង្កើត", "description": "", "unique_code": "A33"},
        {"answer": "បងប្អូនប្រុស/ស្រី", "description": "", "unique_code": "A34"},
        {"answer": "សាច់ញាតិ", "description": "", "unique_code": "A35"},
        {"answer": "មិនមែនសាច់ញាតិ", "description": "", "unique_code": "A36"},
        {"answer": "អ្នកមើលថែអាជីព", "description": "", "unique_code": "A37"},
        {"answer": "មានគ្រប់គ្រាន់", "description": "", "unique_code": "A38"},
        {"answer": "មានភាគច្រើន", "description": "", "unique_code": "A39"},
        {"answer": "ជួនមានជួនអត់", "description": "", "unique_code": "A40"},
        {"answer": "សឹងតែមិនមានសោះ", "description": "", "unique_code": "A41"},
        {"answer": "បើកភ្នែកខ្លះៗ", "description": "", "unique_code": "A42"},
        {"answer": "បើកភ្នែកដោយពិបាក", "description": "", "unique_code": "A43"},
        {"answer": "បិទភ្នែក", "description": "", "unique_code": "A44"},
    ]
    try:
        inserted_count = 0
        skipped_count = 0
        failed_items = []
        
        for answer_disability_type_data in ANSWER_DISABILITY_TYPES:
            try:
                # Check if disability type with this code already exists
                existing = await crud_answer.get_by_answer(
                    db=db,
                    answer=answer_disability_type_data["answer"]
                )
                
                if existing:
                    skipped_count += 1
                    continue
                # Create new disability type
                disability_type_create = AnswerCreateInternal(
                    answer=answer_disability_type_data["answer"],
                    description=answer_disability_type_data["description"],
                    unique_code=answer_disability_type_data["unique_code"],
                    created_by=user_id
                )
                
                # Insert into database
                await crud_answer.create(db=db, object=disability_type_create)
                inserted_count += 1
                
            except Exception as e:
                failed_items.append({
                    "answer": answer_disability_type_data["answer"],
                    "error": str(e)
                })
        
        # Get final count
        total_in_db = len(await crud_answer.get_all_active(db=db, limit=1000))
        
        return {
            "message": "Disability types seeding completed",
            "summary": {
                "total_processed": len(ANSWER_DISABILITY_TYPES),
                "inserted": inserted_count,
                "skipped": skipped_count,
                "failed": len(failed_items),
                "total_in_database": total_in_db
            },
            "failed_items": failed_items,
            "status": "success" if len(failed_items) == 0 else "partial_success"
        }
        
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to seed disability types: {str(e)}"
        )


@router.post(
    "/questionAnswer",
    summary = "Question and Answer of Disability types",
    description = "Get all Question and Answer that relate each other"
)
async def question_answer_disability_types(
    QA_disability_type_data: QuestionAnswerCreate,
    keycloak_user: Annotated[UserInSignInKeyCloak, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)]
) -> QuestionAnswerRead:
    """
    Create a Question-Answer record.

    Args:
        qa_data: QuestionAnswer creation data
        keycloak_user: Authenticated user info from Keycloak
        db: Async database session

    Returns:
        Created QuestionAnswer record
    """
    # Validate user
    db_user = await validate_user(keycloak_user.username, keycloak_user, db)
    user_id = db_user["id"]

    try:
        # Convert request into internal schema with created_by
        qa_internal = QuestionAnswerCreateInternal(
            **QA_disability_type_data.dict(),
            created_by=str(user_id)
        )

        # Create the QuestionAnswer record
        created_qa = await crud_question_answer.create_question_answer(
            db=db, 
            qa_data=qa_internal
        )

        # Return only what QuestionAnswerRead expects
        return QuestionAnswerRead(
            id=created_qa.id,
            main_id=created_qa.main_id,
            question_code=created_qa.question_code,
            answer_code=created_qa.answer_code,
            category_code=created_qa.category_code
            # created_at=created_qa.created_at
        )

    except ValueError as e:
        # Raised when duplicate found in check_duplicate()
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT,
            detail=str(e)
        )
    except IntegrityError:
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT,
            detail=f"Failed to create QuestionAnswer"
        )
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to create QuestionAnswer: {str(e)}"
        )
    

@router.post(
    "/subDisabilityTypes",
    response_model=List[dict],
    summary="Get sub-disabilities by disability_type_id using unique_code mapping",
)
async def get_sub_disabilities(
    payload: dict,
    keycloak_user: Annotated[UserInSignInKeyCloak, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)],
):
    disability_type_id = payload.get("disability_type_id")
    if not disability_type_id:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="Field 'disability_type_id' is required."
        )

    # Validate user
    await validate_user(keycloak_user.username, keycloak_user, db)

    try:
        # Get DisabilityType
        disability_stmt = select(DisabilityType).where(DisabilityType.id == disability_type_id)
        disability_res = await db.execute(disability_stmt)
        disability = disability_res.scalar_one_or_none()
        if not disability:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="DisabilityType not found."
            )

        # Get Questions for this disability
        question_stmt = select(Question).where(Question.parent_code == disability.code)
        question_res = await db.execute(question_stmt)
        questions = question_res.scalars().all()
        if not questions:
            return []

        # Get all Answers
        answer_stmt = select(Answer)
        answer_res = await db.execute(answer_stmt)
        answers = answer_res.scalars().all()

        # Map Answers to Questions using unique_code logic
        # For example, if question code is Q1_1, answers A1-A4 belong to it
        # You can adjust this mapping based on your convention
        question_answer_map = {}
        for q in questions:
            question_answer_map[q.question] = [
                a.answer for a in answers if a.unique_code.startswith("A")  # adjust rule if needed
            ]

        # Build the final JSON
        items = []
        for q_text, ans_list in question_answer_map.items():
            for ans_text in ans_list:
                items.append({
                    "question": q_text,
                    "answer": ans_text
                })

        return [
            {
                "title_disability_type": disability.title,
                "items": items
            }
        ]

    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to fetch sub-disabilities: {str(e)}"
        )




============



from typing import Annotated,List, Optional
import os
import logging
import json
from datetime import datetime, date
from pathlib import Path
from urllib.parse import quote
import uuid
from http import HTTPStatus
from fastapi import (
    APIRouter, 
    Depends, 
    HTTPException, 
    status, 
    Form, 
    UploadFile
)
from sqlalchemy import select
from sqlalchemy.exc import IntegrityError
from sqlalchemy.ext.asyncio import AsyncSession
from ...core.config import settings
# Auth & DB
from ...api.auth_keycloak import get_user_info
from ...core.db.database import async_get_db
from ...core.utils.user_validation import validate_user
from ...core.utils.helpers import get_asset_url

# CRUD
from ...crud.crud_main import crud_main
from ...crud.crud_question_answer import crud_question_answer
from app.crud.crud_user_profile import crud_user_profile

# Models
from ...models.main import AccountStatus, Gender
from ...models.disability_type import DisabilityType
from ...models.user_profile import UserProfile

# Schemas
from ...schemas.main import (
    MainCreate,
    MainCreateInternal,
    MainRead,
    MainUpdate,
    MainSearch,
    MainStats,
    MainUserIDSearch,
    MainDisabilitySearch,
    MainListResponse,
    MainRecordResponse,
    DisabilityRecordResponse,
    UserDisabilityRequest,
    DisabilityUpdateRequest,
    DisabilityRecieve,
    DisabilityUpdate,
    DisabilityDetail,
    DisabilityComplaint,
    DisabilityFraud,
    DisabilityWithoutVillage,
    complaint,
    Fraud,
    village,
    district,
    commune,
    province,
    ListSurvey,
    AddSurvey,
    DeleteSurvey,
    DisabilitySearchCode

)
from ...schemas.question_answer import QuestionAnswerCreateInternal
from ...schemas.user_keycloak import UserInSignInKeyCloak

# DMIS Services
from ...core.services.dmis_service import (
    get_disability_handler,
    get_list_disabilities_commune,
    update_disability_reject,
    update_disability_recieve_card,
    update_disability_photo,
    get_detail_of_disability,
    get_complaint_solution_disability,
    add_fraud_disability,
    get_disability_without_village,
    get_complaint,
    get_fraud,
    get_all_village,
    get_district_by_province,
    get_all_commune_by_district,
    get_all_village_by_commune,
    get_list_surveys,
    add_survey,
    delete_survey,
    get_disability_code,
)

from ...models.main_asset import MainAsset, AssetType
from ...core.services.minio_service import MinioService
from ...models.main import (
    Main as MainModel,
)
from ...core.services.dmis_service import insert_disability_dmis
import base64
import io
from PIL import Image
from fastapi import UploadFile, HTTPException
from ...models.main_asset import MainAsset, AssetType
from ...core.services.minio_service import MinioService
from ...models.main import (
    Main as MainModel,
)
import re
from typing import Union
from ...core.utils.helpers import get_asset_url
from urllib.parse import quote


router = APIRouter(tags=["main"], prefix="/main")

logger = logging.getLogger("disability_logger")
logging.basicConfig(level=logging.INFO)

@router.get(
    "/get-asset-url",
    status_code=status.HTTP_201_CREATED,
    summary="Get asset URL",
    description="Create a new main record for a person"
)
async def get_disability_type_images(
    keycloak_user: Annotated[UserInSignInKeyCloak, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)]
) -> List[dict]:
    result = await db.execute(select(DisabilityType))
    disabilities = result.scalars().all()

    if not disabilities:
        logger.warning("No disability types found in the database")
        raise HTTPException(status_code=404, detail="No disability types found")

    urls_with_names = []
    for disability in disabilities:
        if disability.image:
            # URL encode filename (for Khmer characters)
            encoded_filename = quote(disability.image)
            file_path = f"public/{encoded_filename}" 
            url = get_asset_url(file_path=file_path, token=keycloak_user.token)
            urls_with_names.append({
                "title": disability.title, 
                "url": url
            })
            logger.info(f"Generated URL for disability '{disability.title}': {url}")
        else:
            logger.warning(f"Disability '{disability.title}' has no image")

    logger.info(f"Total URLs generated: {len(urls_with_names)}")
    return urls_with_names

# async def get_asset_url_test(
#     keycloak_user: Annotated[UserInSignInKeyCloak, Depends(get_user_info)],
#     db: Annotated[AsyncSession, Depends(async_get_db)]
# ) -> str:

#     return get_asset_url(file_path="public/disability_type.jpg", token=keycloak_user.token)

    
@router.post(
    "/",
    status_code=status.HTTP_201_CREATED,
    response_model=MainRead,
    summary="Create a new main record",
    description="Create a new main record for a person"
)
async def create_main_record(
    main_data: MainCreate,
    keycloak_user: Annotated[UserInSignInKeyCloak, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)]
) -> MainRead:
    """
    Create a new main record.
    
    Args:
        main_data: Main record creation data
        keycloak_user: Authenticated user information
        db: Database session
        
    Returns:
        Created main record
    """
    
    # Validate user
    db_user = await validate_user(keycloak_user.username, keycloak_user, db)
    user_id = db_user["id"]
    
    try:
        # Convert to internal schema
        main_create = MainCreateInternal(
            **main_data.dict(),
            created_by=str(user_id)
        )
        
        # Create the main record in database
        created_main = await crud_main.create(db=db, object=main_create)
        await db.commit()  # <-- commit transaction to DB
        await db.refresh(created_main)
        
        return MainRead(
            id=created_main.id,
            name=created_main.name,
            phone_number=created_main.phone_number,
            first_name=created_main.first_name,
            last_name=created_main.last_name,
            first_name_kh=created_main.first_name_kh,
            last_name_kh=created_main.last_name_kh,
            gender=created_main.gender,
            dob=created_main.dob,
            have_eq_card=created_main.have_eq_card,
            eq_card=created_main.eq_card,
            disability_date=created_main.disability_date,
            gazetteer_code=created_main.gazetteer_code,
            status=created_main.status,
            notes=created_main.notes,
            spid=created_main.spid,
            latitude=created_main.latitude,
            longitude=created_main.longitude,
            remarks=created_main.remarks,
            created_by=created_main.created_by,
            updated_by=created_main.updated_by
        )
        
    except IntegrityError:
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT,
            detail=f"Main record with name '{main_data.name}' already exists"
        )
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to create main record: {str(e)}"
        )
    


# Search-User-ID
@router.get(
    "/getdisabilities",
    response_model=DisabilityRecordResponse,
    summary="Get All Disabilities",
    description="Retrieve all disabilities from DMIS API service"
)
async def get_disbility(
    keycloak_user: Annotated[UserInSignInKeyCloak, Depends(get_user_info)] = None,
    db: Annotated[AsyncSession, Depends(async_get_db)] = None
) -> DisabilityRecordResponse:

    if keycloak_user:
        await validate_user(keycloak_user.username, keycloak_user, db)

    try:
        disability_data = await get_disability_handler()

        return DisabilityRecordResponse(
            error=disability_data.get("error", False),
            message=disability_data.get("message", "Data retrieved successfully"),
            data=disability_data.get("data")
        )

    except Exception as e:
        raise HTTPException(
            status_code=500,
            detail=f"Failed to retrieve disability data: {e}"
        )


## Fetching Main-Record
@router.get(
    "/",
    response_model=MainListResponse,
    summary="Get all main records",
    description="Retrieve all active main records with optional filtering"
)
async def get_main_records(
    keycloak_user: Annotated[UserInSignInKeyCloak, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)],
    skip: int = 0,
    limit: int = 100,
    status_filter: AccountStatus | None = None,
    gazetteer_code: str | None = None,
):
    """
    Get all main records with optional filtering.
    
    Args:
        keycloak_user: Authenticated user information
        db: Database session
        skip: Number of records to skip
        limit: Maximum number of records to return
        status_filter: Filter by account status
        gazetteer_code: Filter by gazetteer code
        
    Returns:
        List of main records
    """
    
    # Validate user
    await validate_user(keycloak_user.username, keycloak_user, db)
    
    try:
        if status_filter:
            records = await crud_main.get_by_status(db=db, status=status_filter, skip=skip, limit=limit)
        elif gazetteer_code:
            records = await crud_main.get_by_gazetteer_code(db=db, gazetteer_code=gazetteer_code, skip=skip, limit=limit)
        else:
            records = await crud_main.get_all_active(db=db, skip=skip, limit=limit)
        
        result = [
            MainRead(
                id=record.id,
                name=record.name,
                phone_number=record.phone_number,
                first_name=record.first_name,
                last_name=record.last_name,
                first_name_kh=record.first_name_kh,
                last_name_kh=record.last_name_kh,
                gender=record.gender,
                dob=record.dob,
                have_eq_card=record.have_eq_card,
                eq_card=record.eq_card,
                disability_date=record.disability_date,
                gazetteer_code=record.gazetteer_code,
                status=record.status,
                notes=record.notes,
                spid=record.spid,
                latitude=record.latitude,
                longitude=record.longitude,
                remarks=record.remarks,
                created_by=record.created_by,
                updated_by=record.updated_by,
                score_question=record.score_question,
                disability_code=record.disability_code,
                family_name=record.family_name,
                given_name=record.given_name,
                family_name_en=record.family_name_en,
                given_name_en=record.given_name_en,

                # disability_photo=record.disability_photo_path,
                # disability_photo_infor=record.disability_photo_infor,
                # disability_photo_doc=record.disability_photo_doc,

                disability_getinfor=record.disability_getinfor,
                disability_name=record.disability_name,
                idpoor_status=record.idpoor_status,
                vacine_status=record.vacine_status,
                vacine_date=record.vacine_date,
                live_with_who=record.live_with_who,
                reason_disability=record.reason_disability,
                year_start_disability=record.year_start_disability,
                submit_date=record.submit_date,
                child_education_level=record.child_education_level,
                is_educated=record.is_educated,
                education_level=record.education_level,
                have_income=record.have_income,
                primary_job=record.primary_job,
                find_job=record.find_job,
                no_job_reason=record.no_job_reason,
                no_job_reason_other=record.no_job_reason_other,
                no_tvet=record.no_tvet_reason,
                is_tvet=record.is_tvet,
                daily_help=record.daily_help,
                chronic_diseases=record.chronic_diseases,
                score_status_live=record.score_status_live,
                
            )
            for record in records
        ]
    
        return {
            "error": False,
            "message": "Successful fetching main records",
            "data": result
        }
        
    except Exception as e:
        return {
            "error": True,
            "message": f"Failed to fetch main records: {str(e)}",
            "data": []
        }


## Fetching Detail Main-Record
@router.get(
    "/{main_record_id}",
    response_model=MainRecordResponse,
    summary="Get main record by ID",
)
async def get_main_record(
    main_record_id: int,
    keycloak_user: Annotated[UserInSignInKeyCloak, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)],
):
    await validate_user(keycloak_user.username, keycloak_user, db)

    try:
        record = await crud_main.get(db=db, id=main_record_id)

        if not record or record.get("is_deleted"):
            return MainListResponse(
                error=True,
                message="Fail for fetching detail main record",
                data=[]
            )

        main_read = MainRead(**record)

        return MainRecordResponse(
            error=False,
            message="Successful for fetching detail main record",
            data=[main_read] 
        )

    except Exception as e:
        return MainRecordResponse(
            error=True,
            message=f"Fail for fetching detail main record: {str(e)}",
            data=[]
        )
    

@router.post(
    "/searchdisability",
    response_model=list[MainRead],
    summary="Search main records",
    description="Search main records with multiple criteria"
)
async def search_main_records(
    search_params: MainDisabilitySearch,
    keycloak_user: Annotated[UserInSignInKeyCloak, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)],
    skip: int = 0,
    limit: int = 100,
) -> list[MainRead]:
    """
    Search main records with multiple criteria.
    
    Args:
        search_params: Search parameters
        keycloak_user: Authenticated user information
        db: Database session
        skip: Number of records to skip
        limit: Maximum number of records to return
        
    Returns:
        List of matching main records
    """
    
    # Validate user
    await validate_user(keycloak_user.username, keycloak_user, db)
    
    try:
        records = await crud_main.search_Disability_records(db=db, search_params=search_params, skip=skip, limit=limit)
        
        return [
            MainRead(
                id=record.id,
                name=record.name,
                phone_number=record.phone_number,
                first_name=record.first_name,
                last_name=record.last_name,
                first_name_kh=record.first_name_kh,
                last_name_kh=record.last_name_kh,
                gender=record.gender,
                dob=record.dob,
                have_eq_card=record.have_eq_card,
                eq_card=record.eq_card,
                disability_date=record.disability_date,
                gazetteer_code=record.gazetteer_code,
                status=record.status,
                notes=record.notes,
                spid=record.spid,
                latitude=record.latitude,
                longitude=record.longitude,
                remarks=record.remarks,
                created_by=record.created_by,
                updated_by=record.updated_by,
                family_name=record.family_name,
                given_name=record.given_name,
                family_name_en=record.family_name_en,
                given_name_en=record.given_name_en,
                disability_code=record.disability_code,
                disability_getinfor=record.disability_getinfor,
                disability_name=record.disability_name,
                idpoor_status=record.idpoor_status,
                vacine_status=record.vacine_status,
                vacine_date=record.vacine_date,
                live_with_who=record.live_with_who,
                reason_disability=record.reason_disability,
                year_start_disability=record.year_start_disability,
                submit_date=record.submit_date,
                child_education_level=record.child_education_level,
                is_educated=record.is_educated,
                education_level=record.education_level,
                have_income=record.have_income,
                primary_job=record.primary_job,
                find_job=record.find_job,
                no_job_reason=record.no_job_reason,
                no_job_reason_other=record.no_job_reason_other,
                no_tvet=record.no_tvet_reason,
                is_tvet=record.is_tvet,
                daily_help=record.daily_help,
                chronic_diseases=record.chronic_diseases,
                score_status_live=record.score_status_live,
                score_question=record.score_question,

                # disability_photo=record.disability_photo_path,
                # disability_photo_infor=record.disability_photo_infor,
                # disability_photo_doc=record.disability_photo_doc,
            )
            for record in records
        ]
        
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to search main records: {str(e)}"
        )


@router.post(
    "/getdisabilities",
    summary="Get Disabilities by User ID",
    description="Search User ID in user_profile and return disabilities from DMIS API"
)
async def get_disabilities_by_user(
    request: UserDisabilityRequest,
    keycloak_user: Annotated[dict, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)],
):
    
    await validate_user(keycloak_user.username, keycloak_user, db)

    try:
        user_id_pwd_str = str(request.user_id_pwd)

        stmt = select(UserProfile).where(UserProfile.user_id_pwd == user_id_pwd_str)
        result = await db.execute(stmt)
        user = result.scalar_one_or_none()

        if not user:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail=f"User with user_id_pwd {user_id_pwd_str} not found"
            )

        # 2. Call DMIS API to get user's profile/disabilities
        dmis_response = await get_list_disabilities_commune({"user_id_pwd": user.user_id_pwd})


        if dmis_response.get("error"):
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail=f"Failed to get disabilities from DMIS API for user {user.user_id_pwd}"
            )
            

        # 3. Return formatted response
        return {
            "error": False,
            "message": "List of beneficiary members",
            "disabilities": dmis_response.get("data") 
        }

    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"An unexpected error occurred: {str(e)}"
        )


@router.post(
    "/getdisabilitiesupdate",
    summary="Get Disabilities Update (Reinterview endpoint)",
    description=""
)
async def get_disabilities_update(
    request: UserDisabilityRequest,
    keycloak_user: Annotated[dict, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)],
):
    await validate_user(keycloak_user.username, keycloak_user, db)

    try:
        user_id_pwd = str(request.user_id_pwd)

        stmt = select(UserProfile).where(UserProfile.user_id_pwd == user_id_pwd)
        result = await db.execute(stmt)
        user = result.scalar_one_or_none()

        if not user:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail=f"User with user_id_pwd {user_id_pwd} not found"
            )
        
        dmis_response = await get_list_disabilities_commune({"user_id_pwd": user.user_id_pwd})

        if dmis_response.get("error"):
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail=f"Failed to get disabilities from DMIS API for user {user.user_id_pwd}"
            )
        
        return {
            "error": False,
            "message": "List of beneficiary memebers",
            "disabilities": dmis_response.get("data")
        }

    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"An unexpected error occurred: {str(e)}"
        )  


@router.post(
    "/getdisabilitiesupdatenew",
    summary="Get Disabilities For Update",
    description=""
)
async def get_disabilities_update_new(
    request: UserDisabilityRequest,
    keycloak_user: Annotated[dict, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)],
):
    
    await validate_user(keycloak_user.username, keycloak_user, db)

    try:
        user_id_pwd = str(request.user_id_pwd)

        stmt = select(UserProfile).where(UserProfile.user_id_pwd == user_id_pwd)
        result = await db.execute(stmt)
        user = result.scalar_one_or_none()

        if not user:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail=f"User with user_id_pwd {user_id_pwd} not found"
            )
        
        dmis_response = await get_list_disabilities_commune({"user_id_pwd": user.user_id_pwd})

        if dmis_response.get("error"):
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail=f"Failed to get disability from DMIN API for user {user.user_id_pwd}"
            )
        
        return {
            "error": False,
            "message": "List of beneficiary members",
            "disabilities": dmis_response.get("data")
        }
    

    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"An unexpected error occurred: {str(e)}"
        )


## Update Disabilities Rejected (Remove data)
@router.post(
    "/updatedisabilityreject",
    summary="Update Disabilities Rejected (Remove data)",
    description="Remove a disability record from DMIS and update reject info"
)
async def get_disability_rejected(
    request: DisabilityUpdateRequest,
    keycloak_user: Annotated[dict, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)],
):
    await validate_user(keycloak_user.username, keycloak_user, db)

    try:
        remove_params = {
            "id": int(request.disability_id),
            "updated_by": str(request.updated_by)
        }

        dmis_result = await update_disability_reject(remove_params)

        return {
            "error": dmis_result["error"],
            "message": dmis_result["message"]
        }


    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"An unexpected error occurred: {str(e)}"
        )


## Update Disabilities Received Card (Scan delivery card to disability person)
@router.post("/disabilityrecivecard")
async def update_disability_recieve_card_route(
    request: DisabilityRecieve,
    keycloak_user: Annotated[dict, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)],
):

    await validate_user(keycloak_user.username, keycloak_user, db)

    try:
        recieve_params = {
            "id": request.id,
            "created_by": request.created_by,
            "st_qr": request.st_qr
        }

        dmis_result = await update_disability_recieve_card(recieve_params)

        if dmis_result.get("error") and "not found" in dmis_result.get("message", "").lower():
            return {
                "error": True,
                "message": "Data not found"
            }

        return {
            "error": dmis_result.get("error", False),
            "message": dmis_result.get(
                "message",
                "ការផ្ទៀងផ្ទាត់បានជោគជ័យ សូមផ្តល់កាតជូនជនមានពិការភាព"
            )
        }

    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(
            status_code=500,
            detail=f"An unexpected error occurred: {str(e)}"
        )


## Update Disability
@router.post("/updatedisability")
async def update_disability_route(
    request: DisabilityUpdate,
    keycloak_user: Annotated[dict, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)],
):

    await validate_user(keycloak_user.username, keycloak_user, db)

    try:
        """
        
        """

        disability_params = {
            "id": request.id,
            "family_code": request.family_code,    
            "updated_by": request.updated_by,        
            "fileColumnKeys": request.fileColumnKeys 
        }

        dmis_result = await update_disability_photo(disability_params)

        if dmis_result.get("error"):
            return {
                "error": True,
                "message": dmis_result.get("message", "មិនអាចកែទិន្នន័យនេះបានទេ")
            }

        return {
            "error": False,
            "message": dmis_result.get("message", "save disability completed")
        }

    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"An unexpected error occurred: {str(e)}"
        )



## Detail of Disability
@router.post("/getdisabilitydetailbyID")
async def get_disability_detail_route(
    request: DisabilityDetail,
    keycloak_user: Annotated[dict, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)],
):
    await validate_user(keycloak_user.username, keycloak_user, db)

    try:
        detail_param = {"id": request.id}

        dmis_result = await get_detail_of_disability(detail_param)

        if dmis_result.get("error"):
            return {
                "error": True,
                "message": dmis_result.get("message", "DATA NOT FOUND")
            }

        return dmis_result

    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"An unexpected error occurred: {str(e)}"
        )


# Add Complaint Solution
@router.post("/addcomplaint_solution")
async def complaint_solution_route(
    request: DisabilityComplaint,
    keycloak_user: Annotated[dict, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)],
):
    await validate_user(keycloak_user.username, keycloak_user, db)

    try:
        complaint_param = {
            "user_id": request.user_id,
            "disability_id": request.disability_id,
            "is_disability": request.is_disability,
            "person_complaint_name": request.person_complaint_name,
            "relationship": request.relationship,
            "person_receive": request.person_receive,
            "complaint_result": request.complaint_result,
            "complaint_type": request.complaint_type,
            "title": request.title,
            "request_update": request.request_update,
            "status": request.status
        }

        dmis_result = await get_complaint_solution_disability(complaint_param)


        if dmis_result.get("error"):
            return {
                "error": True,
                "message": dmis_result.get("message", "DATA NOT FOUND")
            }

        return dmis_result

    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"An unexpected error occurred: {str(e)}"
        )
    

# Add Fraud Disability
@router.post("/addfraud_solution")
async def fraud_solution_route(
    request: DisabilityFraud,
    keycloak_user: Annotated[dict, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)],
):
    await validate_user(keycloak_user.username, keycloak_user, db)

    try:
        fraud_param = {
            "user_id": request.user_id,
            "disability_id": request.disability_id,
            "reporter_name": request.reporter_name,
            "reporter_title": request.reporter_title,
            "reporter_address": request.reporter_address,
            "fraud_type": request.fraud_type
        }

        dmis_result = await add_fraud_disability(fraud_param)

        if dmis_result.get("error"):
            return {
                "error": True,
                "message": dmis_result.get("message", "DATA NOT FOUND")
            }
        
        return dmis_result
    
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"An unexpected error occurred: {str(e)}"
        )


# Get disability without village
@router.post("/getDisabilitiesWithoutVillage")
async def get_disability_without_village_route(
    request: DisabilityWithoutVillage,
    keycloak_user: Annotated[dict, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)],
):
    await validate_user(keycloak_user.username, keycloak_user, db)

    try:
        village_param = {
            "user_id": request.user_id
        }

        dmis_result = await get_disability_without_village(village_param)

        if dmis_result.get("error"):
            return {
                "error": True,
                "message": dmis_result.get("message", "DATA NOT FOUND")
            }
        
        return dmis_result
    
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"An unexpected error occurred: {str(e)}"
        )


# Get complaint
@router.post("/getcomplaint_solution")
async def get_complaint_route(
    request: complaint,
    keycloak_user: Annotated[dict, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)],
):
    await validate_user(keycloak_user.username, keycloak_user, db)

    try:
        complaint_param = {
            "user_id": request.user_id
        }

        dmis_result = await get_complaint(complaint_param)

        if dmis_result.get("error"):
            return {
                "error": True,
                "message": dmis_result.get("message", "DATA NOT FOUND")
            }
        
        return dmis_result
    
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"An unexpected error occurred: {str(e)}"
        )
    
# Get Fraud
@router.post("/getfraud_solution")
async def get_fraud_route(
    request: Fraud,
    keycloak_user: Annotated[dict, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)],
):
    await validate_user(keycloak_user.username, keycloak_user, db)

    try:
        fraud_param = {
            "user_id": request.user_id
        }

        dmis_result = await get_fraud(fraud_param)

        if dmis_result.get("error"):
            return {
                "error": True,
                "message": dmis_result.get("message", "DATA NOT FOUND")
            }
        
        return dmis_result
    
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"An unexpected error occurred: {str(e)}"
        )


# Get All Provinces
@router.post("/getProvinces")
async def get_all_province_route(
    request: village,
    keycloak_user: Annotated[dict, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)],
):
    await validate_user(keycloak_user.username, keycloak_user, db)

    try:
        village_param = {
            "user_id": request.user_id
        }

        dmis_result = await get_all_village(village_param)

        if dmis_result.get("error"):
            return {
                "error": True,
                "message": dmis_result.get("message", "DATA NOT FOUND")
            }
        
        return dmis_result
    
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"An unexpected error occurred: {str(e)}"
        )


# Get District By Provinces
@router.post("/getDistricts")
async def get_fraud_route(
    request: district,
    keycloak_user: Annotated[dict, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)],
):
    await validate_user(keycloak_user.username, keycloak_user, db)

    try:
        district_param = {
            "province": request.province
        }

        dmis_result = await get_district_by_province(district_param)

        if dmis_result.get("error"):
            return {
                "error": True,
                "message": dmis_result.get("message", "DATA NOT FOUND")
            }
        
        return dmis_result
    
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"An unexpected error occurred: {str(e)}"
        )


# Get Commune By District
@router.post("/getCommunes")
async def get_commune_route(
    request: commune,
    keycloak_user: Annotated[dict, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)],
):
    await validate_user(keycloak_user.username, keycloak_user, db)

    try:
        fraud_param = {
            "district": request.district
        }

        dmis_result = await get_all_commune_by_district(fraud_param)

        if dmis_result.get("error"):
            return {
                "error": True,
                "message": dmis_result.get("message", "DATA NOT FOUND")
            }
        
        return dmis_result
    
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"An unexpected error occurred: {str(e)}"
        )

# Get Province by commune
@router.post("/getVillages")
async def get_commune_route(
    request: province,
    keycloak_user: Annotated[dict, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)],
):
    await validate_user(keycloak_user.username, keycloak_user, db)

    try:
        province_param = {
            "commune": request.commune
        }

        dmis_result = await get_all_village_by_commune(province_param)

        if dmis_result.get("error"):
            return {
                "error": True,
                "message": dmis_result.get("message", "DATA NOT FOUND")
            }
        
        return dmis_result
    
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"An unexpected error occurred: {str(e)}"
        )


# Get List Survey
@router.get("/surveys/index")
async def get_survey_route(
    request: ListSurvey,
    keycloak_user: Annotated[dict, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)],
):
    await validate_user(keycloak_user.username, keycloak_user, db)

    try:
        dmis_result = await get_list_surveys({"user_id": request.user_id})

        if dmis_result.get("error"):
            return {
                "error": True,
                "message": dmis_result.get("message", "DATA NOT FOUND")
            }

        return dmis_result

    except Exception as e:
        raise HTTPException(
            status_code=500,
            detail=f"An unexpected error occurred: {str(e)}"
        )
    

# Add Survey
@router.post("/surveys/add")
async def get_commune_route(
    request: AddSurvey,
    keycloak_user: Annotated[dict, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)],
):
    await validate_user(keycloak_user.username, keycloak_user, db)

    try:
        add_survey_param = {
            "disability_code": request.disability_code,
            "disability_name": request.disability_name,
            "disability_gender": request.disability_gender,
            "is_disability_interview": request.is_disability_interview,
            "is_id_poor": request.is_id_poor,
            "is_update_id_poor": request.is_update_id_poor,
            "is_family_package": request.is_family_package,
            "is_tvet": request.is_tvet,
            "created_by": request.created_by,
            "province_id": request.province_id,
            "district_id": request.district_id,
            "commune_id": request.commune_id,
            "village_id": request.village_id,
        }

        dmis_result = await add_survey(add_survey_param)

        if dmis_result.get("error"):
            return {
                "error": True,
                "message": dmis_result.get("message", "DATA NOT FOUND")
            }
        
        return dmis_result
    
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"An unexpected error occurred: {str(e)}"
        )



# Delete Survey
@router.post("/surveys/delete")
async def delete_survey_route(
    request: DeleteSurvey,
    keycloak_user: Annotated[dict, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)],
):
    await validate_user(keycloak_user.username, keycloak_user, db)

    try:
        delete_survey_param = {
            "id": request.id,
            
        }

        dmis_result = await delete_survey(delete_survey_param)

        if dmis_result.get("error"):
            return {
                "error": True,
                "message": dmis_result.get("message", "DATA NOT FOUND")
            }
        
        return dmis_result
    
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"An unexpected error occurred: {str(e)}"
        )



# Search-Disability-code from DMIS API
@router.post("/searchdisabilitycode")
async def search_disability_code(
    request: DisabilitySearchCode,
    keycloak_user: Annotated[dict, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)],
):
    await validate_user(keycloak_user.username, keycloak_user, db)

    try:
        search_disability_code = {
            "disability_code": request.disability_code,
        }

        dmis_result = await get_disability_code(search_disability_code)

        if dmis_result.get("error"):
            return {
                "error": True,
                "message": dmis_result.get("message", "DATA NOT FOUND")
            }
        
        return dmis_result
    
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"An unexpected error occurred: {str(e)}"
        )



@router.get(
    "/stats",
    response_model=MainStats,
    summary="Get main records statistics",
    description="Get comprehensive statistics about main records"
)
async def get_main_statistics(
    keycloak_user: Annotated[UserInSignInKeyCloak, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)]
) -> MainStats:
    """
    Get comprehensive statistics about main records.
    
    Args:
        keycloak_user: Authenticated user information
        db: Database session
        
    Returns:
        Statistics about main records
    """
    
    # Validate user
    await validate_user(keycloak_user.username, keycloak_user, db)
    
    try:
        return await crud_main.get_statistics(db=db)
        
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to retrieve statistics: {str(e)}"
        )


@router.get(
    "/{main_id}",
    response_model=MainRead,
    summary="Get main record by ID",
    description="Retrieve a specific main record by its ID"
)
async def get_main_record(
    main_id: int,
    keycloak_user: Annotated[UserInSignInKeyCloak, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)]
) -> MainRead:
    """
    Get a specific main record by ID.
    
    Args:
        main_id: ID of the main record to retrieve
        keycloak_user: Authenticated user information
        db: Database session
        
    Returns:
        Main record details
    """
    
    # Validate user
    await validate_user(keycloak_user.username, keycloak_user, db)
    
    try:
        record = await crud_main.get(db=db, id=main_id)
        if not record or record.is_deleted:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="Main record not found"
            )
        
        return MainRead(
            id=record.id,
            name=record.name,
            phone_number=record.phone_number,
            first_name=record.first_name,
            last_name=record.last_name,
            first_name_kh=record.first_name_kh,
            last_name_kh=record.last_name_kh,
            gender=record.gender,
            dob=record.dob,
            have_eq_card=record.have_eq_card,
            eq_card=record.eq_card,
            disability_date=record.disability_date,
            gazetteer_code=record.gazetteer_code,
            status=record.status,
            notes=record.notes,
            spid=record.spid,
            latitude=record.latitude,
            longitude=record.longitude,
            remarks=record.remarks,
            created_by=record.created_by,
            updated_by=record.updated_by
        )
        
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to retrieve main record: {str(e)}"
        )


@router.put(
    "/{main_id}",
    response_model=MainRead,
    summary="Update main record",
    description="Update an existing main record"
)
async def update_main_record(
    main_id: int,
    main_update: MainUpdate,
    keycloak_user: Annotated[UserInSignInKeyCloak, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)]
) -> MainRead:
    """
    Update an existing main record.
    
    Args:
        main_id: ID of the main record to update
        main_update: Update data
        keycloak_user: Authenticated user information
        db: Database session
        
    Returns:
        Updated main record
    """
    
    # Validate user
    db_user = await validate_user(keycloak_user.username, keycloak_user, db)
    user_id = db_user["id"]
    
    try:
        # Check if record exists
        existing_record = await crud_main.get(db=db, id=main_id)
        if not existing_record or existing_record.is_deleted:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="Main record not found"
            )
        
        # Prepare update data
        from ...schemas.main import MainUpdateInternal
        update_data = MainUpdateInternal(
            **main_update.dict(exclude_unset=True),
            updated_by=user_id
        )
        
        # Update the record
        updated_record = await crud_main.update(db=db, id=main_id, object=update_data)
        
        return MainRead(
            id=updated_record.id,
            name=updated_record.name,
            phone_number=updated_record.phone_number,
            first_name=updated_record.first_name,
            last_name=updated_record.last_name,
            first_name_kh=updated_record.first_name_kh,
            last_name_kh=updated_record.last_name_kh,
            gender=updated_record.gender,
            dob=updated_record.dob,
            have_eq_card=updated_record.have_eq_card,
            eq_card=updated_record.eq_card,
            disability_date=updated_record.disability_date,
            gazetteer_code=updated_record.gazetteer_code,
            status=updated_record.status,
            notes=updated_record.notes,
            spid=updated_record.spid,
            latitude=updated_record.latitude,
            longitude=updated_record.longitude,
            remarks=updated_record.remarks,
            created_by=updated_record.created_by,
            updated_by=updated_record.updated_by
        )
        
    except HTTPException:
        raise
    except IntegrityError:
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT,
            detail="Duplicate name or unique constraint violation"
        )
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to update main record: {str(e)}"
        )


@router.put(
    "/{main_id}/status",
    response_model=MainRead,
    summary="Update main record status",
    description="Update only the status of a main record"
)
async def update_main_status(
    main_id: int,
    new_status: AccountStatus,
    keycloak_user: Annotated[UserInSignInKeyCloak, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)]
) -> MainRead:
    """
    Update only the status of a main record.
    
    Args:
        main_id: ID of the main record to update
        new_status: New status to set
        keycloak_user: Authenticated user information
        db: Database session
        
    Returns:
        Updated main record
    """
    
    # Validate user
    db_user = await validate_user(keycloak_user.username, keycloak_user, db)
    user_id = db_user["id"]
    
    try:
        # Update status
        updated_record = await crud_main.update_status(
            db=db, 
            record_id=main_id, 
            new_status=new_status, 
            updated_by=user_id
        )
        
        if not updated_record:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="Main record not found"
            )
        
        return MainRead(
            id=updated_record.id,
            name=updated_record.name,
            phone_number=updated_record.phone_number,
            first_name=updated_record.first_name,
            last_name=updated_record.last_name,
            first_name_kh=updated_record.first_name_kh,
            last_name_kh=updated_record.last_name_kh,
            gender=updated_record.gender,
            dob=updated_record.dob,
            have_eq_card=updated_record.have_eq_card,
            eq_card=updated_record.eq_card,
            disability_date=updated_record.disability_date,
            gazetteer_code=updated_record.gazetteer_code,
            status=updated_record.status,
            notes=updated_record.notes,
            spid=updated_record.spid,
            latitude=updated_record.latitude,
            longitude=updated_record.longitude,
            remarks=updated_record.remarks,
            created_by=updated_record.created_by,
            updated_by=updated_record.updated_by
        )
        
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to update main record status: {str(e)}"
        )


@router.delete(
    "/{main_id}",
    summary="Delete main record",
    description="Soft delete a main record (mark as deleted)"
)
async def delete_main_record(
    main_id: int,
    keycloak_user: Annotated[UserInSignInKeyCloak, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)]
) -> dict:
    """
    Soft delete a main record.
    
    Args:
        main_id: ID of the main record to delete
        keycloak_user: Authenticated user information
        db: Database session
        
    Returns:
        Deletion confirmation
    """
    
    # Validate user
    db_user = await validate_user(keycloak_user.username, keycloak_user, db)
    
    try:
        # Check if record exists
        existing_record = await crud_main.get(db=db, id=main_id)
        if not existing_record or existing_record.is_deleted:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="Main record not found"
            )
        
        # Soft delete the record
        await crud_main.db_delete(db=db, id=main_id)
        
        return {
            "message": f"Main record '{existing_record.name}' has been deleted successfully",
            "deleted_id": main_id
        }
        
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to delete main record: {str(e)}"
        )






# Directory to save uploaded files
UPLOAD_DIR = Path("app/api/v1/uploads")
UPLOAD_DIR.mkdir(parents=True, exist_ok=True)

ALLOWED_EXTENSIONS = {'.jpg', '.jpeg', '.png', '.pdf', '.webp'}
MAX_FILE_SIZE = 10 * 1024 * 1024  # 10MB
import uuid
import mimetypes

async def save_upload_file(file: UploadFile, folder: Path) -> str:
    if file is None:
        return None
    
    # Validate file size
    content = await file.read()
    if len(content) > MAX_FILE_SIZE:
        raise HTTPException(
            status_code=413,
            detail=f"File too large. Maximum size is {MAX_FILE_SIZE / (1024*1024)}MB"
        )
    
    # Validate file extension
    file_ext = Path(file.filename).suffix.lower()
    if file_ext not in ALLOWED_EXTENSIONS:
        raise HTTPException(
            status_code=400,
            detail=f"File type {file_ext} not allowed. Allowed types: {ALLOWED_EXTENSIONS}"
        )
    
    # Sanitize filename - use UUID to prevent path traversal
    safe_filename = f"{uuid.uuid4()}{file_ext}"
    file_path = folder / safe_filename
    
    # Validate file content type
    detected_type = mimetypes.guess_type(file.filename)[0]
    if not detected_type or not detected_type.startswith(('image/', 'application/pdf')):
        raise HTTPException(status_code=400, detail="Invalid file content type")
    
    # Ensure folder exists and is within expected directory
    folder.mkdir(parents=True, exist_ok=True)
    
    with open(file_path, "wb") as buffer:
        buffer.write(content)
    
    return str(file_path)

# convert image into base64
async def uploadfile_to_small_base64(
    file: UploadFile | None,
    max_size=(800, 800),
    quality=65,
) -> str | None:
    if not file:
        return None

    raw = await file.read()
    if not raw:
        return None

    try:
        image = Image.open(io.BytesIO(raw))
        image = image.convert("RGB")
        image.thumbnail(max_size)

        buffer = io.BytesIO()
        image.save(buffer, format="JPEG", quality=quality, optimize=True)

        compressed = buffer.getvalue()

        # 🔒 Safety limit (~900 KB)
        if len(compressed) > 900_000:
            raise HTTPException(
                status_code=400,
                detail="Image too large after compression"
            )

        return base64.b64encode(compressed).decode("utf-8")

    except Exception as e:
        raise HTTPException(status_code=400, detail=f"Invalid image file: {e}")


# Add-new-Disability Part
KHMER_REGEX = re.compile(r"^[\u1780-\u17FF\s]+$")
ENGLISH_REGEX = re.compile(r"^[A-Za-z\s]+$")
CAMBODIA_PHONE_REGEX = re.compile(r"^0\d{9}$")

def validate_khmer_only(value: str, field_name: str):
    if not value or not KHMER_REGEX.fullmatch(value.strip()):
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail=f"សូមបញ្ចូល {field_name} ជាអក្សរខ្មែរប៉ុណ្ណោះ."
        )

def validate_english_only(value: str, field_name: str):
    if not value or not ENGLISH_REGEX.fullmatch(value.strip()):
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail=f"សូមបញ្ចូល​ {field_name} ជាអក្សរ​អង់គ្លេងប៉ុណ្ណោះ."
        )
    
def validate_cambodia_phone(value: str, field_name: str = "phone_number"):
    if not value or not CAMBODIA_PHONE_REGEX.fullmatch(value.strip()):
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="សូមបញ្ចូលលេខទូរស័ព្ទកម្ពុជា ១០ ខ្ទង់ (ចាប់ផ្តើមដោយលេខ 0)"
        )


def get_photo_url(attachment_path: Optional[str], token: str) -> Optional[str]:
    """Generate signed URL for person's photo (same style as get_image_url)."""
    if not attachment_path:
        return None
    encoded_path = quote(attachment_path)
    return get_asset_url(file_path=encoded_path, token=token)


@router.post(
    "/insertdisability",
    status_code=status.HTTP_201_CREATED,
    summary="Register a new disability member",
    description="Create a new disability registration record following the external API format"
)
async def insert_disability(
    # Authentication
    keycloak_user: Annotated[UserInSignInKeyCloak, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)],
    
    # Personal Information - Khmer
    disability_getinfor: Annotated[str, Form()],
    disability_family_name: Annotated[str, Form()],
    disability_given_name: Annotated[str, Form()],
    disability_name: Annotated[str, Form()],
    
    # Personal Information - English
    disability_family_name_en: Annotated[str, Form()],
    disability_given_name_en: Annotated[str, Form()],
    disability_name_eng: Annotated[str, Form()],
    
    # Basic Information
    gender: Annotated[Union[int, str], Form()],
    national_id: Annotated[str, Form()],
    family_code: Annotated[str, Form()],
    phone_number: Annotated[str, Form()],
    date_of_birth: Annotated[str, Form()],
    
    # ID Poor Information
    idpoor_id: Annotated[str, Form()],
    family_code_idpoor: Annotated[str, Form()],
    idpoor_status: Annotated[str, Form()],
    
    # Vaccination Information
    vacine_status: Annotated[int, Form()],
    vacine_date: Annotated[str, Form()],
    
    # Location and Living Situation
    village_id: Annotated[str, Form()],
    job: Annotated[str, Form()],
    live_with_who: Annotated[str, Form()],
    
    # Disability Information
    reason_disability: Annotated[str, Form()],
    year_start_disability: Annotated[int, Form()],
    submit_date: Annotated[str, Form()],

    # disability code
    # disability_code: Annotated[str, Form()],
    
    # Scoring Information
    # score_question: Annotated[str, Form()],

    # Education Information
    child_education_level: Annotated[str, Form()],
    is_educated: Annotated[str, Form()],
    education_level: Annotated[str, Form()],
    
    # Employment Information
    have_income: Annotated[str, Form()],
    primary_job: Annotated[str, Form()],
    find_job: Annotated[str, Form()],
    no_job_reason: Annotated[str, Form()],
    no_job_reason_other: Annotated[str, Form()],
    
    # Training Information
    no_tvet: Annotated[str, Form()],
    is_tvet: Annotated[str, Form()],
    
    # Support Information
    daily_help: Annotated[str, Form()],
    chronic_diseases: Annotated[str, Form()],

    # Asset Information
    disability_photo: Annotated[UploadFile, Form()],
    disability_photo_full: Annotated[UploadFile, Form()],

    fp_right_photos: Annotated[list[UploadFile], Form()] = [],
    fp_left_photos: Annotated[list[UploadFile], Form()] = [],
    fp_right_metadatas: Annotated[list[str], Form()] = [],
    fp_left_metadatas: Annotated[list[str], Form()] = [],

    # Optional Related Documents (all optional)
    family_book: Annotated[UploadFile | None, Form()] = None,  # សៀវភៅគ្រួសារ
    residence_book: Annotated[UploadFile | None, Form()] = None,  # សៀវភៅស្នាក់នៅ
    national_id_card: Annotated[UploadFile | None, Form()] = None,  # អត្តសញ្ញាណបណ្ណ
    equity_card: Annotated[UploadFile | None, Form()] = None,  # បណ្ណសមធ័ម៌

    # Optional parameters with defaults
    score_status_live: Annotated[str, Form()] = "",

    # Scoring Information
    score_question: Annotated[Optional[str], Form()] = None,

) -> dict:
        
    # Validate local DB user
    db_user = await validate_user(keycloak_user.username, keycloak_user, db)
    user_id = db_user["id"]

    # Get user_id_pwd from UserProfile table (DMIS info)
    user_profile = await crud_user_profile.get_by_user_id(db, user_id)
    if not user_profile:
        raise HTTPException(
            status_code=404, 
            detail="User profile with DMIS info not found. Please fetch /user-profile first."
        )
    user_profile_id = user_profile.id 
    user_id_pwd = user_profile.user_id_pwd  # DMIS ID if needed

    logger.debug("UserProfile ID: %s", user_profile_id)
    logger.debug("UserProfile DMIS ID: %s", user_id_pwd)

    # --- DUPLICATE VALIDATION ---
    existing_record = await crud_main.get_by_disability_name(db, disability_name)
    if existing_record:
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT,
            detail=f"ជនមានពិការភាពជាមួយឈ្មោះ{disability_name} នេះបានចុះឈ្មោះរួចហើយ"
        )
    
    # Khmer-only fields
    validate_khmer_only(disability_getinfor, "disability_getinfor")
    validate_khmer_only(disability_family_name, "disability_family_name")
    validate_khmer_only(disability_given_name, "disability_given_name")
    validate_khmer_only(disability_name, "disability_name")

    # English-only fields
    validate_english_only(disability_family_name_en, "disability_family_name_en")
    validate_english_only(disability_given_name_en, "disability_given_name_en")
    validate_english_only(disability_name_eng, "disability_name_eng")

    # Cambodia phone number
    validate_cambodia_phone(phone_number)

    try:
        # Map gender integer to Gender enum
        gender_mapping = {0: Gender.OTHER, 1: Gender.MALE, 2: Gender.FEMALE}
        gender_enum = gender_mapping.get(gender, Gender.MALE)
        
        # Convert year_start_disability to a date (assuming January 1st of that year)
        disability_date_val = date(year_start_disability, 1, 1) if year_start_disability else None
        submit_date_val = datetime.strptime(submit_date, "%Y-%m-%d").date() if submit_date else None

        # --- Handle score_question ---
        score_question_array = [
            {"keyname": "Q1_1_1", "keyscore": 0 ,"answer_code": "A1", "category": "C1"},
            {"keyname": "Q1_1_2", "keyscore": 0 ,"answer_code": "A1", "category": "C1"},
            {"keyname": "Q1_1_3", "keyscore": 0 ,"answer_code": "A1", "category": "C1"},
        ]

        if score_question and score_question.strip():
            try:
                questions = json.loads(score_question)
                raw_json_to_save = score_question.strip()
                logging.info("Using score_question from frontend")
            except json.JSONDecodeError as e:
                raise HTTPException(status_code=400, detail=f"Invalid JSON in score_question: {e}")
        else:
            questions = score_question_array
            raw_json_to_save = json.dumps(score_question_array)
            logging.info("No score_question from frontend → using default array")

        # Create the registration data object
        registration_data = MainModel(
            gender=gender_enum,
            national_id=national_id,
            family_code=family_code,
            name=disability_name_eng,
            first_name=disability_given_name_en,
            last_name=disability_family_name_en,
            first_name_kh=disability_given_name,
            last_name_kh=disability_family_name,
            disability_date=disability_date_val,
            family_name=disability_family_name,
            given_name=disability_given_name,
            family_name_en=disability_family_name_en,
            given_name_en=disability_given_name_en,
            phone_number=phone_number,
            idpoor_id=idpoor_id,
            family_code_idpoor=family_code_idpoor,
            vacine_status=str(vacine_status),
            vacine_date=vacine_date,
            job=job,
            village_id=village_id,
            dob=date_of_birth,
            live_with_who=live_with_who,
            reason_disability=reason_disability,
            year_start_disability=str(year_start_disability),
            score_question=raw_json_to_save,
            score_status_live=score_status_live,
            is_educated=is_educated,
            education_level=education_level,
            have_income=have_income,
            primary_job=primary_job,
            find_job=find_job,
            no_job_reason=no_job_reason,
            no_job_reason_other=no_job_reason_other,
            no_tvet_reason=no_tvet, 
            is_tvet=is_tvet,
            daily_help=daily_help,
            chronic_diseases=chronic_diseases,
            idpoor_status=idpoor_status,
            disability_getinfor=disability_getinfor,
            disability_name=disability_name,
            submit_date=submit_date_val,
            child_education_level=child_education_level,
            gazetteer_code=village_id,
            created_by=user_id,
            disability_code=None,
            # disability_photo=disability_photo,
            # disability_photo_full=disability_photo_full
        )

        # insert into db - PWD internal service
        db.add(registration_data)
        await db.flush()


        # Convert dates to ISO format strings (YYYY-MM-DD) for JSON compatibility
        # disability_date_str = disability_date_val.isoformat() if disability_date_val else None
        submit_date_str = submit_date_val.isoformat() if submit_date_val else None

        # Convert files to base64 for DMIS
        disability_photo_b64 = await uploadfile_to_small_base64(disability_photo)
        disability_photo_full_b64 = await uploadfile_to_small_base64(disability_photo_full)
        national_id_card_b64 = await uploadfile_to_small_base64(national_id_card)
        equity_card_b64 = await uploadfile_to_small_base64(equity_card)

        if not national_id_card_b64:
            national_id_card_b64 = disability_photo_b64

        if not equity_card_b64:
            equity_card_b64 = disability_photo_b64

        # call insert disability endpoint dmis
        dmis_payload = {
            "user_id": user_id,
            "disability_family_name": disability_family_name,
            "disability_given_name": disability_given_name,
            "disability_name": disability_name,
            "disability_family_name_en": disability_family_name_en,
            "disability_given_name_en": disability_given_name_en,
            "disability_name_eng": disability_name_eng,
            "gender": gender,
            "national_id": national_id,
            "family_code": family_code,
            "phone_number": phone_number,
            "date_of_birth": date_of_birth,
            "idpoor_id": idpoor_id,
            "family_code_idpoor": family_code_idpoor,
            "idpoor_status": idpoor_status,
            "vacine_status": str(vacine_status),
            "vacine_date": vacine_date,
            "job": job,
            "village_id": village_id,
            "live_with_who": live_with_who,
            "reason_disability": reason_disability,
            "year_start_disability": str(year_start_disability),
            "submit_date": submit_date_str,
            "score_question": raw_json_to_save,
            "score_status_live": score_status_live,
            "child_education_level": child_education_level,
            "is_educated": is_educated,
            "education_level": education_level,
            "have_income": have_income,
            "primary_job": primary_job,
            "find_job": find_job,
            "no_job_reason": no_job_reason,
            "no_job_reason_other": no_job_reason_other,
            "no_tvet": no_tvet,
            "is_tvet": is_tvet,
            "daily_help": daily_help,
            "chronic_diseases": chronic_diseases,
            "disability_getinfor": disability_getinfor,
            "gazetteer_code": village_id,
            "created_by": user_id,
            "disability_photo": disability_photo_b64,
            "disability_photo_infor": disability_photo_full_b64,
            "disability_photo_path": national_id_card_b64,
            "disability_photo_doc": equity_card_b64,
        }

        # call insert into DMIS external service
        dmis_result = await insert_disability_dmis(dmis_payload)

        if dmis_result.get("error"):
            await db.rollback()

            message = (dmis_result.get("message") or "").lower()

            if "duplicate" in message:
                raise HTTPException(
                    status_code=409,
                    detail="Duplicate beneficiary in DMIS"
                )

            raise HTTPException(
                status_code=502,
                detail=f"DMIS error: {dmis_result.get('message')}"
            )

        dmis_disability_code = dmis_result["data"]["disability_code"]

        # update disability_code
        registration_data.disability_code = dmis_disability_code

        db.add(registration_data)
        await db.flush()

        main_id = registration_data.id
        logging.info(f"Created main record with ID: {main_id}")

        single_photos = {
            "disability_photo": (
                disability_photo,
                AssetType.DISABILITY_PHOTO,
            ),
            "disability_photo_full": (
                disability_photo_full, 
                AssetType.DISABILITY_PHOTO_FULL,
            ),
        }

        for field_name, (file, asset_type) in single_photos.items():
            if file:
                try:
                    # Read file content
                    content = await file.read()

                    # Generate path with UUID
                    unique_id = str(uuid.uuid4())
                    file_path = f"{main_id}/main/{field_name}_{unique_id}.png"

                    # Upload to MinIO
                    if settings.ENVIRONMENT == "local" and content:
                        await MinioService.upload_file(
                            file_content=content,
                            file_name=file_path,
                            content_type=file.content_type or "image/png",
                        )

                    # Create asset record using Pydantic model
                    asset_data = MainAsset(
                        main_id=main_id,
                        attachment=file_path,
                        type=asset_type,
                    )

                    db.add(asset_data)
                    await db.flush()

                except Exception as e:
                    # Rollback the transaction if MinIO upload fails
                    await db.rollback()
                    raise e

        # Handle optional related documents
        if family_book or residence_book or national_id_card or equity_card:
            related_docs = {
                "family_book": (family_book, AssetType.FAMILY_BOOK),
                "residence_book": (residence_book, AssetType.RESIDENCE_BOOK),
                "national_id_card": (national_id_card, AssetType.NID),
                "equity_card": (equity_card, AssetType.EQUITY_CARD),
            }

            for field_name, (file, asset_type) in related_docs.items():
                if file:   
                    try:
                        # Read file content
                        content = await file.read()

                        # Generate path with UUID
                        unique_id = str(uuid.uuid4())
                        file_path = f"{main_id}/main/{field_name}_{unique_id}.png"

                        # Upload to MinIO
                        if settings.ENVIRONMENT == "local" and content:
                            await MinioService.upload_file(
                                file_content=content,
                                file_name=file_path,
                                content_type=file.content_type or "image/png",
                            )

                        # Create asset record using Pydantic model
                        asset_data = MainAsset(
                            main_id=main_id,
                            attachment=file_path,
                            type=asset_type,
                        )

                        db.add(asset_data)
                        await db.flush()

                    except Exception as e:
                        # Rollback the transaction if MinIO upload fails
                        await db.rollback()
                        raise e

        
        # Handle multiple fingerprint photos
        fingerprint_photos = {
            "fp_right_photos": (fp_right_photos, AssetType.FP_RIGHT, fp_right_metadatas),
            "fp_left_photos": (fp_left_photos, AssetType.FP_LEFT, fp_left_metadatas),
        }
        for field_name, (files, asset_type, metadata_list) in fingerprint_photos.items():
            if files:
                # Handle each file in the list
                for index, file in enumerate(files):
                    try:
                        # Read file content
                        content = await file.read()

                        # Generate path with UUID
                        unique_id = str(uuid.uuid4())
                        file_path = f"{main_id}/main/{field_name}_{unique_id}.png"

                        if settings.ENVIRONMENT == "local" and content:
                            # Upload to MinIO
                            await MinioService.upload_file(
                                file_content=content,
                                file_name=file_path,
                                content_type=file.content_type or "image/png",
                            )

                        # Get metadata for this specific file
                        file_metadata = None
                        if metadata_list and index < len(metadata_list):
                            metadata_string = metadata_list[index]
                            # Validate that the metadata is valid JSON
                            try:
                                # Parse to validate JSON format
                                json.loads(metadata_string)
                                file_metadata = metadata_string
                            except json.JSONDecodeError as e:
                                logging.warning(
                                    f"Invalid JSON metadata for {asset_type.name.lower()} "
                                    f"photo {index}: {e}"
                                )
                                # Store as plain text if not valid JSON
                                file_metadata = metadata_string

                        new_asset = MainAsset(
                            main_id=main_id,
                            attachment=file_path,
                            type=asset_type,
                            remarks=file_metadata,
                        )
                        db.add(new_asset)
                        await db.flush()

                    except Exception as e:
                        # Rollback the transaction if MinIO upload fails
                        await db.rollback()
                        raise e

        # Commit the transaction if everything succeeded
        await db.commit()
        await db.refresh(registration_data)

        
        registration_data.score_question = raw_json_to_save
        await db.commit()
        await db.refresh(registration_data)

        saved_count = 0
        for q in questions:
            keyname = q["keyname"]
            answer_code = q["answer_code"]
            category_code = q.get("category") or q.get("category_code")
            qa_data = QuestionAnswerCreateInternal(
                main_id=registration_data.id,
                question_code=keyname,
                category_code=category_code,
                answer_code=answer_code
            )
            await crud_question_answer.create_question_answer(db=db, qa_data=qa_data)
            saved_count += 1

        logging.info(f"Inserted {saved_count} score answers into question_answer table")
        
        # --- Convert to Pydantic schema ---
        main_read_schema = MainRead.model_validate(registration_data)
        return {"error": False, "message": "success", "data": main_read_schema.model_dump(by_alias=True)}
        
    except Exception as e:
        # Rollback on any error
        await db.rollback()
        
        # Log the error for debugging
        error_message = str(e)
        logging.error(f"Error in create_member: {error_message}", exc_info=True)

        # Check if it's an HTTPException and re-raise it
        if isinstance(e, HTTPException):
            raise
        
        # Check if it's a validation error and handle it gracefully
        if "validation error" in error_message.lower() and "FmAccountMain" in error_message:
            # This is a Pydantic validation error, provide user-friendly message
            if "String should have at least" in error_message:
                # Generic string length error
                raise HTTPException(
                    status_code=HTTPStatus.BAD_REQUEST, detail="សូមពិនិត្យបំពេញទិន្នន័យរបស់អ្នកឡើងវិញ ហើយព្យាយាមម្តងទៀត។"
                )
            else:
                # Generic validation error
                raise HTTPException(
                    status_code=HTTPStatus.BAD_REQUEST, detail="សូមពិនិត្យបំពេញទិន្នន័យរបស់អ្នកឡើងវិញ ហើយព្យាយាមម្តងទៀត។"
                )
        else:
            # Other types of errors
            raise HTTPException(
                status_code=HTTPStatus.INTERNAL_SERVER_ERROR,
                detail=(
                    "មានបញ្ហាបច្ចេកទេស សូមទាក់ទងជំនួយ។"
                    if settings.ENVIRONMENT == "production"
                    else f"Error creating main account: {error_message}"
                ),
            )


===================
import logging


from fastapi import APIRouter, Depends, HTTPException, status, Query
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.exc import SQLAlchemyError, IntegrityError
from sqlalchemy import select
from typing import Annotated, Optional, Any, List
from sqlalchemy import text
from fastapi.responses import JSONResponse
from urllib.parse import quote

from ...api.auth_keycloak import get_user_info
from ...core.db.database import async_get_db
from ...core.utils.user_validation import validate_user
from ...schemas.user_keycloak import UserInSignInKeyCloak
from ...schemas.question_answer_view import QuestionOnlyRequest, QuestionAnswersResponse
from ...schemas.category_question_view import CategoryQuestionOnlyRequest, CategoryQuestionResponse
from ...crud.crud_question_answer_view import crud_question_answer_view
from ...crud.crud_category_question_view import crud_category_question_view
from ...models.question_answer_view import QuestionAnswerView
from ...models.category_question_view import CategoryQuestionView
from ...schemas.disability_questions_answer import DisabilityQuestionResponse
from ...schemas.fully_disability_questions_answer import DisabilityCategoryQuestionResponse
from ...schemas.question_answer import ScoreQuestionResponse
from ...crud.crud_category_question import crud_category
from ...schemas.category_question import (
    CategoryQuestionViewCreate,
    CategoryQuestionViewCreateInternal,
    CategoryQuestionViewRead,
    CategoryQuestionViewUpdate,
    CategoryQuestionViewUpdateInternal,
)
from datetime import datetime
from ...models.question import Question
from ...core.utils.helpers import get_asset_url

router = APIRouter(tags=["question-answer-view"], prefix="/question-answer-view")


def calculate_age_group(dob: str) -> str:
    """
    Calculate age group based on DOB string in format YYYY/MM/DD
    """
    try:
        birth_date = datetime.strptime(dob, "%Y/%m/%d")
    except ValueError:
        raise HTTPException(status_code=400, detail="DOB must be in format YYYY/MM/DD")
    
    today = datetime.today()
    age = today.year - birth_date.year - ((today.month, today.day) < (birth_date.month, birth_date.day))
    return "under_8_year_old" if age < 8 else "over_8_year_old"


@router.post(
    "/question-answer",
    status_code=status.HTTP_200_OK,
    response_model=QuestionAnswersResponse,
)
async def insert_question_and_get_answers(
    request: QuestionOnlyRequest,
    keycloak_user: Annotated[UserInSignInKeyCloak, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)]
) -> QuestionAnswersResponse:
    try:
        # Validate user
        db_user = await validate_user(keycloak_user.username, keycloak_user, db)
        user_id = db_user["id"]

        # Predefined question-answer mapping
        QUESTION_ANSWER_VIEW = {
            # under 8 years old
            "under_8_year_old": {
                "Q1_1_1": ["A1", "A2", "A3", "A4"],
                "Q1_1_2": ["A1", "A2", "A3", "A4"],
                "Q1_1_3": ["A1", "A2", "A3", "A4"],
                "Q1_1_4": ["A1", "A2", "A3", "A4"],
                "Q1_1_5": ["A1", "A2", "A3", "A4"],
                "Q1_1_6": ["A1", "A2", "A3", "A4"],
                "Q1_1_7": ["A1", "A2", "A3", "A4"],

                "Q1_2_1": ["A1", "A2", "A3", "A4"],
                "Q1_2_2": ["A1", "A2", "A3", "A4"],
                "Q1_2_3": ["A1", "A2", "A3", "A4"],
                "Q1_2_4": ["A1", "A2", "A3", "A4"],
                "Q1_2_5": ["A1", "A2", "A3", "A4"],
                "Q1_2_6":["A1", "A2", "A3", "A4"],
                "Q1_2_7":["A1", "A2", "A3", "A4"],
                "Q1_2_8": ["A5", "A6", "A7"],
                "Q1_2_9": ["A5", "A6", "A7"],

                "Q1_3_1": ["A8", "A9", "A10", "A11"],
                "Q1_3_2": ["A1", "A2", "A3", "A4"],
                "Q1_3_3": ["A1", "A2", "A3", "A4"],
                "Q1_3_4": ["A1", "A12", "A13", "A14"],
                "Q1_3_5": ["A1", "A12", "A13", "A14"],
                "Q1_3_6": ["A15", "A16"],
                "Q1_3_7": ["A1", "A2", "A3", "A4"],
                "Q1_3_8": ["A17", "A18", "A19", "A20"],
                "Q1_3_9": ["A17", "A18", "A19", "A20"],

                "Q1_4_1": ["A15", "A16"],
                "Q1_4_2": ["A17", "A18", "A19", "A20"],
                "Q1_4_3": ["A17", "A18", "A19", "A20"],
                "Q1_4_4": ["A17", "A18", "A19", "A20"],
                "Q1_4_5": ["A1", "A2", "A3", "A4"],
                "Q1_4_6": ["A1", "A2", "A3", "A4"],

                "Q2_1_1": ["A1", "A2", "A3", "A4"],
                "Q2_1_2": ["A17", "A18", "A19", "A20"],
                "Q2_1_3": ["A1", "A2", "A3", "A4"],
                "Q2_1_4": ["A1", "A2", "A3", "A4"],
                "Q2_1_5": ["A1", "A2", "A3", "A4"],
                "Q2_1_6": ["A1", "A2", "A3", "A4"],
                "Q2_1_7": ["A1", "A2", "A3", "A4"],

                "Q2_2_1": ["A1", "A2", "A3", "A4"],
                "Q2_2_2": ["A1", "A2", "A3", "A4"],
                "Q2_2_3": ["A1", "A2", "A3", "A4"],
                "Q2_2_4": ["A1", "A2", "A3", "A4"],
                "Q2_2_5": ["A1", "A2", "A3", "A4"],
                "Q2_2_6": ["A1", "A12", "A13", "A14"],
                "Q2_2_7": ["A1", "A2", "A3", "A4"],

                "Q2_3_1": ["A1", "A2", "A3", "A4"],
                "Q2_3_2": ["A1", "A2", "A3", "A4"],
                "Q2_3_3": ["A1", "A2", "A3", "A4"],
                "Q2_3_4": ["A1", "A2", "A3", "A4"],
                "Q2_3_5": ["A1", "A2", "A3", "A4"],
                "Q2_3_6": ["A1", "A2", "A3", "A4"],

                "Q3_1_1": ["A1", "A2", "A3", "A4"],
                "Q3_1_2": ["A17", "A18", "A19", "A20"],
                "Q3_1_3": ["A17", "A18", "A19", "A20"],
                "Q3_1_4": ["A17", "A18", "A19", "A20"],
                "Q3_1_5": ["A17", "A18", "A19", "A20"],
                "Q3_1_6": ["A17", "A18", "A19", "A20"],
                "Q3_1_7": ["A17", "A18", "A19", "A20"],
                "Q3_1_8": ["A17", "A18", "A19", "A20"],

                "Q3_2_1": ["A17", "A18", "A19", "A20"],
                "Q3_2_2": ["A17", "A18", "A19", "A20"],
                "Q3_2_3": ["A17", "A18", "A19", "A20"],
                "Q3_2_4": ["A17", "A18", "A19", "A20"],
                "Q3_2_5": ["A17", "A18", "A19", "A20"],
                "Q3_2_6": ["A17", "A18", "A19", "A20"],
                "Q3_2_7": ["A17", "A18", "A19", "A20"],
                "Q3_2_8": ["A17", "A18", "A19", "A20"],
                "Q3_2_9": ["A17", "A18", "A19", "A20"],

                "Q3_3_1": ["A1", "A2", "A3", "A4"],
                "Q3_3_2": ["A1", "A2", "A3", "A4"],
                "Q3_3_3": ["A1", "A2", "A3", "A4"],
                "Q3_3_4": ["A1", "A2", "A3", "A4"],
                "Q3_3_5": ["A1", "A2", "A3", "A4"],
                "Q3_3_6": ["A1", "A2", "A3", "A4"],
                "Q3_3_7": ["A1", "A2", "A3", "A4"],
                "Q3_3_8": ["A1", "A2", "A3", "A4"],

                "Q4_1_1": ["A17", "A18", "A19", "A20"],
                "Q4_1_2": ["A17", "A18", "A19", "A20"],
                "Q4_1_3": ["A17", "A18", "A19", "A20"],
                "Q4_1_4": ["A17", "A18", "A19", "A20"],
                "Q4_1_5": ["A17", "A18", "A19", "A20"],
                "Q4_1_6": ["A17", "A18", "A19", "A20"],
                "Q4_1_7": ["A17", "A18", "A19", "A20"],

                "Q4_2_1": ["A1", "A2", "A3", "A4"],
                "Q4_2_2": ["A1", "A2", "A3", "A4"],
                "Q4_2_3": ["A1", "A2", "A3", "A4"],
                "Q4_2_4": ["A1", "A2", "A3", "A4"],
                "Q4_2_5": ["A1", "A2", "A3", "A4"],
                "Q4_2_6": ["A1", "A2", "A3", "A4"],
                "Q4_2_7": ["A1", "A2", "A3", "A4"],

                "Q5_1_1": ["A15", "A16"],
                "Q5_1_2": ["A15", "A16"],
                "Q5_1_3": ["A17", "A18", "A19", "A20"],
                "Q5_1_4": ["A15", "A16"],
                "Q5_1_5": ["A17", "A18", "A19", "A20"],
                "Q5_1_6": ["A17", "A18", "A19", "A20"],

                "Q5_2_1": ["A21", "A22"],
                "Q5_2_2": ["A15", "A16"],
                "Q5_2_3": ["A17", "A18", "A19", "A20"],
                "Q5_2_4": ["A17", "A18", "A19", "A20"],
                "Q5_2_5": ["A17", "A18", "A19", "A20"],
                "Q5_2_6": ["A1", "A2", "A3", "A4"],
                "Q5_2_7": ["A17", "A18", "A19", "A20"],
                "Q5_2_8": ["A17", "A18", "A19", "A20"],

                "Q6_1_1": ["A1", "A2", "A3", "A4"],
                "Q6_1_2": ["A1", "A2", "A3", "A4"],

                "Q6_2_1": ["A21", "A22"],
                "Q6_2_2": ["A23", "A24"],
                "Q6_2_3": ["A23", "A24"],
                "Q6_2_4": ["A23", "A24"],
            },

            #Over 8 years old
            "over_8_year_old": {
                "Q1.1.1": ["A1", "A2", "A3", "A4"],
                "Q1.1.2": ["A1", "A2", "A3", "A4"],
                "Q1.1.3": ["A1", "A2", "A3", "A4"],
                "Q1.1.4": ["A1", "A2", "A3", "A4"],
                "Q1.1.5": ["A1", "A2", "A3", "A4"],
                "Q1.1.6": ["A1", "A2", "A3", "A4"],
                "Q1.1.7": ["A1", "A2", "A3", "A4"],

                "Q1.2.1": ["A1", "A2", "A3", "A4"],
                "Q1.2.2": ["A1", "A2", "A3", "A4"],
                "Q1.2.3": ["A1", "A2", "A3", "A4"],
                "Q1.2.4": ["A1", "A2", "A3", "A4"],
                "Q1.2.5": ["A1", "A2", "A3", "A4"],
                "Q1.2.6": ["A1", "A2", "A3", "A4"],
                "Q1.2.7": ["A1", "A2", "A3", "A4"],
                "Q1.2.8": ["A5", "A6", "A7"],
                "Q1.2.9": ["A5", "A6", "A7"],

                "Q1.3.1": ["A8", "A9", "A10", "A11"],
                "Q1.3.2": ["A1", "A2", "A3", "A4"],
                "Q1.3.3": ["A1", "A2", "A3", "A4"],
                "Q1.3.4": ["A1", "A12", "A13", "A14"],
                "Q1.3.5": ["A1", "A12", "A13", "A14"],
                "Q1.3.6": ["A15", "A16"],
                "Q1.3.7": ["A1", "A2", "A3", "A4"],
                "Q1.3.8": ["A17", "A18", "A19", "A20"],
                "Q1.3.9": ["A17", "A18", "A19", "A20"],

                "Q1.4.1": ["A15", "A16"],
                "Q1.4.2": ["A17", "A18", "A19", "A20"],
                "Q1.4.3": ["A17", "A18", "A19", "A20"],
                "Q1.4.4": ["A17", "A18", "A19", "A20"],
                "Q1.4.5": ["A1", "A2", "A3", "A4"],
                "Q1.4.6": ["A1", "A2", "A3", "A4"],

                "Q2.1.1": ["A1", "A2", "A3", "A4"],
                "Q2.1.2": ["A17", "A18", "A19", "A20"],
                "Q2.1.3": ["A1", "A2", "A3", "A4"],
                "Q2.1.4": ["A1", "A2", "A3", "A4"],
                "Q2.1.5": ["A1", "A2", "A3", "A4"],
                "Q2.1.6": ["A1", "A2", "A3", "A4"],
                "Q2.1.7": ["A1", "A2", "A3", "A4"],

                "Q2.2.1": ["A1", "A2", "A3", "A4"],
                "Q2.2.2": ["A1", "A2", "A3", "A4"],
                "Q2.2.3": ["A1", "A2", "A3", "A4"],
                "Q2.2.4": ["A1", "A2", "A3", "A4"],
                "Q2.2.5": ["A1", "A2", "A3", "A4"],
                "Q2.2.6": ["A1", "A12", "A13", "A14"],
                "Q2.2.7": ["A1", "A2", "A3", "A4"],

                "Q2.3.1": ["A1", "A2", "A3", "A4"],
                "Q2.3.2": ["A1", "A2", "A3", "A4"],
                "Q2.3.3": ["A1", "A2", "A3", "A4"],
                "Q2.3.4": ["A1", "A2", "A3", "A4"],
                "Q2.3.5": ["A1", "A2", "A3", "A4"],
                "Q2.3.6": ["A1", "A2", "A3", "A4"],
                "Q2.3.7": ["A1", "A2", "A3", "A4"],
                "Q2.3.8": ["A1", "A2", "A3", "A4"],
                "Q2.3.9": ["A1", "A2", "A3", "A4"],
                "Q2.3.10": ["A1", "A2", "A3", "A4"],

                "Q3.1.1": ["A1","A42", "A43", "A44"],
                "Q3.1.2": ["A17", "A18", "A19", "A20"],
                "Q3.1.3": ["A17", "A18", "A19", "A20"],
                "Q3.1.4": ["A17", "A18", "A19", "A20"],
                "Q3.1.5": ["A17", "A18", "A19", "A20"],
                "Q3.1.6": ["A17", "A18", "A19", "A20"],
                "Q3.1.7": ["A17", "A18", "A19", "A20"],
                "Q3.1.8": ["A17", "A18", "A19", "A20"],
                "Q3.1.9": ["A17", "A18", "A19", "A20"],

                "Q3.2.1": ["A17", "A18", "A19", "A20"],
                "Q3.2.2": ["A17", "A18", "A19", "A20"],
                "Q3.2.3": ["A17", "A18", "A19", "A20"],
                "Q3.2.4": ["A17", "A18", "A19", "A20"],
                "Q3.2.5": ["A17", "A18", "A19", "A20"],
                "Q3.2.6": ["A17", "A18", "A19", "A20"],
                "Q3.2.7": ["A17", "A18", "A19", "A20"],
                "Q3.2.8": ["A17", "A18", "A19", "A20"],
                "Q3.2.9": ["A17", "A18", "A19", "A20"],

                "Q3.3.1": ["A1", "A2", "A3", "A4"],
                "Q3.3.2": ["A1", "A2", "A3", "A4"],
                "Q3.3.3": ["A1", "A2", "A3", "A4"],
                "Q3.3.4": ["A1", "A2", "A3", "A4"],
                "Q3.3.5": ["A1", "A2", "A3", "A4"],
                "Q3.3.6": ["A1", "A2", "A3", "A4"],
                "Q3.3.7": ["A1", "A2", "A3", "A4"],
                "Q3.3.8": ["A1", "A2", "A3", "A4"],

                "Q4.1.1": ["A17", "A18", "A19", "A20"],
                "Q4.1.2": ["A17", "A18", "A19", "A20"],
                "Q4.1.3": ["A17", "A18", "A19", "A20"],
                "Q4.1.4": ["A17", "A18", "A19", "A20"],
                "Q4.1.5": ["A17", "A18", "A19", "A20"],
                "Q4.1.6": ["A17", "A18", "A19", "A20"],
                "Q4.1.7": ["A17", "A18", "A19", "A20"],
                "Q4.1.8": ["A17", "A18", "A19", "A20"],
                "Q4.1.9": ["A17", "A18", "A19", "A20"],
                "Q4.1.10": ["A17", "A18", "A19", "A20"],

                "Q4.2.1": ["A17", "A18", "A19", "A20"],
                "Q4.2.2": ["A17", "A18", "A19", "A20"],
                "Q4.2.3": ["A17", "A18", "A19", "A20"],
                "Q4.2.4": ["A17", "A18", "A19", "A20"],
                "Q4.2.5": ["A17", "A18", "A19", "A20"],
                "Q4.2.6": ["A17", "A18", "A19", "A20"],
                "Q4.2.7": ["A17", "A18", "A19", "A20"],
                "Q4.2.8": ["A17", "A18", "A19", "A20"],
                "Q4.2.9": ["A17", "A18", "A19", "A20"],

                "Q5.1.1": ["A15", "A16"],
                "Q5.1.2": ["A15", "A16"],
                "Q5.1.3": ["A17", "A18", "A19", "A20"],
                "Q5.1.4": ["A15", "A16"],
                "Q5.1.5": ["A17", "A18", "A19", "A20"],
                "Q5.1.6":  ["A17", "A18", "A19", "A20"],

                "Q5.2.1": ["A21", "A22"],
                "Q5.2.2": ["A15", "A16"],
                "Q5.2.3": ["A17", "A18", "A19", "A20"],
                "Q5.2.4": ["A17", "A18", "A19", "A20"],
                "Q5.2.5": ["A17", "A18", "A19", "A20"],
                "Q5.2.6": ["A1", "A2", "A3", "A4"],
                "Q5.2.7": ["A17", "A18", "A19", "A20"],
                "Q5.2.8": ["A17", "A18", "A19", "A20"],

                "Q6.1.1": ["A1", "A2", "A3", "A4"],
                "Q6.1.2": ["A1", "A2", "A3", "A4"],
                "Q6.1.3": ["A25", "A26", "A27"],
                "Q6.1.4": ["A28", "A29"],
                "Q6.1.5": ["A30", "A12", "A3", "A4"],
                "Q6.1.6": ["A17", "A18", "A19", "A20"],

                "Q6.2.1": ["A23", "A24"],
                "Q6.2.2": ["A23", "A24"],
                "Q6.2.3": ["A21", "A31", "A32", "A33", "A34", ],
                "Q6.2.4": ["A38", "A39", "A40", "A41"]
            }
        }

        # Get questions for this age_group
        questions_for_age_group = QUESTION_ANSWER_VIEW.get(request.age_group)
        if not questions_for_age_group:
            raise HTTPException(
                status_code=404,
                detail=f"No questions found for age group {request.age_group}"
            )

        # Bulk insert all question-answer entries for this user
        await crud_question_answer_view.create_bulk_by_age_group(
            db=db,
            user_id=user_id,
            question_answer_mapping=questions_for_age_group,
            age_group=request.age_group
        )

        # Return first question's total answers for response
        first_question_code = list(questions_for_age_group.keys())[0]
        result = await db.execute(
            select(QuestionAnswerView.answer_code).where(
                QuestionAnswerView.question_code == first_question_code,
                QuestionAnswerView.created_by == user_id,
                QuestionAnswerView.age_group == request.age_group
            )
        )
        all_answers = result.scalars().all()

        return QuestionAnswersResponse(
            question_code=first_question_code,
            answer_code=str(len(all_answers)),
            age_group=request.age_group   # total answers count
        )

    except IntegrityError as e:
        await db.rollback()
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail=f"Duplicate or invalid data: {str(e)}"
        )
    except SQLAlchemyError as e:
        await db.rollback()
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Database error: {str(e)}"
        )
    except Exception as e:
        await db.rollback()
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Unexpected error: {str(e)}"
        )


@router.get(
    "/disability-questions-answers",
    response_model=DisabilityQuestionResponse,
    description="Retrieve all disability types, subtypes, questions, and answers grouped by age group."
)
async def get_disability_questions(
    dob: Optional[str] = Query(None, description="Date of birth YYYY/MM/DD"),
    keycloak_user: Annotated[UserInSignInKeyCloak, Depends(get_user_info)] = None,
    db: Annotated[AsyncSession, Depends(async_get_db)] = None
):
    # Validate user if authentication is required
    if keycloak_user:
        await validate_user(keycloak_user.username, keycloak_user, db)


     # Calculate age group from DOB
    age_group = calculate_age_group(dob) if dob else None

    query = text("""
        WITH children AS (
    SELECT
        c.parent_code AS parent_code,
        json_agg(
            json_build_object(
                'code', c.code,
                'title', c.title,
                'description', c.description,
                'questions_by_age_group', COALESCE(
                    (
                        SELECT json_agg(
                            json_build_object(
                                'age_group', v.age_group,
                                'questions', COALESCE(
                                    (
                                        SELECT json_agg(
                                            json_build_object(
                                                'code', q.unique_code,
                                                'text', q.question,
                                                'answers', COALESCE(
                                                    (
                                                        SELECT json_agg(
                                                            json_build_object(
                                                                'code', a.unique_code,
                                                                'text', a.answer
                                                            )
                                                            ORDER BY a.unique_code
                                                        )
                                                        FROM answer a
                                                        WHERE a.unique_code IN (
                                                            SELECT answer_code
                                                            FROM question_answer_view v2
                                                            WHERE v2.question_code = q.unique_code
                                                              AND v2.age_group = v.age_group
                                                        )
                                                    ),
                                                    '[]'::json
                                                )
                                            )
                                            ORDER BY q.unique_code
                                        )
                                        FROM question q
                                        WHERE q.parent_code = CASE 
                                                                  WHEN v.age_group = 'under_8_year_old' THEN c.code
                                                                  WHEN v.age_group = 'over_8_year_old' THEN REPLACE(c.code, '_', '.') -- convert Q1_1 -> Q1.1
                                                              END
                                    ),
                                    '[]'::json
                                )
                            )
                            ORDER BY 
                                CASE 
                                    WHEN v.age_group = 'under_8_year_old' THEN 1
                                    WHEN v.age_group = 'over_8_year_old' THEN 2
                                    ELSE 3
                                END
                        )
                        FROM (
                            SELECT DISTINCT age_group
                            FROM question_answer_view
                            WHERE (CAST(:age_group AS TEXT) IS NULL OR age_group = CAST(:age_group AS TEXT))

                            
                        ) v
                    ),
                    '[]'::json
                )
            )
            ORDER BY c.code
        ) AS subtypes
    FROM disability_type c
    WHERE c.parent_code IS NOT NULL
    GROUP BY c.parent_code
)
SELECT
    dt.code AS disability_code,
    dt.title,
    dt.description,
    COALESCE(ch.subtypes, '[]'::json) AS subtypes
FROM disability_type dt
LEFT JOIN children ch
    ON ch.parent_code = dt.code
WHERE dt.parent_code IS NULL
ORDER BY CAST(SUBSTRING(dt.code FROM '[0-9]+') AS INT);
    """)

    result = await db.execute(query, {"age_group": age_group})
    data = result.mappings().all()

    return {"data": data}



# Score-Question
SCORE_QUESTION = text("""
SELECT
    json_agg(
        json_build_object(
            'main_id', main_id,
			'category', category_code,
            'keyname', question_code,
            'answer_code', answer_code
            
        )
    ) AS results
FROM question_answer;

""")

@router.get(
    "/score_question",
    description="Get score-question when user selected."
)
async def get_score_question_loop(
    keycloak_user: Annotated["UserInSignInKeyCloak", Depends(get_user_info)] = None,
    db: Annotated[AsyncSession, Depends(async_get_db)] = None
) -> List[Any]:
    
    if keycloak_user:
        await validate_user(keycloak_user.username, keycloak_user, db)
    
    result = await db.execute(SCORE_QUESTION)
    data = result.scalar() 
    
    looped_data = []
    
    if data: 
        for item in data:
            looped_data.append({
                "main_id": item.get("main_id"),
                "category": item.get("category"),
                "keyname": item.get("keyname"),
                "answer_code": item.get("answer_code"),
            })
    
    return looped_data



# Full-Disability-question-answer
FULL_DISABILITY_SQL = text("""
WITH children AS (
    SELECT
        c.parent_code AS parent_code,
        json_agg(
            json_build_object(
                'code', c.code,
                'title', c.title,
                'image', c.image,
                'description', c.description,
                'questions_by_age_group', COALESCE(
                    (
                        SELECT json_agg(
                            json_build_object(
                                'age_group', v.age_group,
                                'questions', COALESCE(
                                    (
                                        SELECT json_agg(
                                            json_build_object(
                                                'code', q.unique_code,
                                                'text', q.question,
                                                'main_category', COALESCE(
                                                    (
                                                        SELECT json_agg(
                                                            json_build_object(
                                                                'code', mc.code,
                                                                'text', mc.category
                                                            )
                                                            ORDER BY mc.code
                                                        )
                                                        FROM (
                                                            SELECT DISTINCT ON (cqv_mc.category_question_code)
                                                                cqv_mc.category_question_code,
                                                                cq.code,
                                                                cq.category
                                                            FROM category_question_view cqv_mc
                                                            JOIN category_question cq
                                                              ON cqv_mc.category_question_code = cq.code
                                                            WHERE cqv_mc.question_code = q.unique_code
                                                              AND (CAST(:age_group AS TEXT) IS NULL OR cqv_mc.age_group = CAST(:age_group AS TEXT))
                                                            ORDER BY cqv_mc.category_question_code, cq.code
                                                        ) mc
                                                    ),
                                                    '[]'::json
                                                ),
                                                'question_by_category', COALESCE(
                                                    (
                                                        SELECT json_agg(qbc_item ORDER BY base_cat.code)
                                                        FROM (
                                                            SELECT DISTINCT ON (cq2.code)
                                                                cq2.code,
                                                                cq2.category,
                                                                cq2.child_code
                                                            FROM category_question_view cqv2
                                                            JOIN category_question cq2
                                                              ON cqv2.category_question_code = cq2.code
                                                            WHERE cqv2.question_code = q.unique_code
                                                              AND (CAST(:age_group AS TEXT) IS NULL OR cqv2.age_group = CAST(:age_group AS TEXT))
                                                            ORDER BY cq2.code
                                                        ) base_cat
                                                        CROSS JOIN LATERAL (
                                                            SELECT json_agg(
                                                                json_build_object('code', a.unique_code, 'text', a.answer)
                                                                ORDER BY a.unique_code
                                                            ) AS answers_json
                                                            FROM question_answer_view qav
                                                            JOIN answer a ON qav.answer_code = a.unique_code
                                                            WHERE qav.question_code = q.unique_code
                                                              AND qav.age_group = v.age_group
                                                        ) q_answers
                                                        LEFT JOIN LATERAL (
                                                            SELECT json_agg(
                                                                json_build_object(
                                                                    'category', json_build_object('code', ch.code, 'text', ch.category),
                                                                    'answers', q_answers.answers_json
                                                                )
                                                                ORDER BY ch.code
                                                            ) AS nested_answers
                                                            FROM (
                                                                SELECT TRIM(unnest(string_to_array(base_cat.child_code, '_'))) AS child_code
                                                            ) split
                                                            JOIN category_question ch ON ch.code = split.child_code
                                                            WHERE base_cat.child_code IS NOT NULL
                                                        ) nested ON true
                                                        CROSS JOIN LATERAL (
                                                            SELECT
                                                                CASE
                                                                    -- FIXED: Only nest if child_code contains '_'
                                                                    WHEN strpos(base_cat.child_code, '_') > 0 THEN
                                                                        json_build_object(
                                                                            'category', json_build_object('code', base_cat.code, 'text', base_cat.category),
                                                                            'answers', COALESCE(nested.nested_answers, '[]'::json)
                                                                        )
                                                                    ELSE
                                                                        -- C1, C2: flat answers
                                                                        json_build_object(
                                                                            'category', json_build_object('code', base_cat.code, 'text', base_cat.category),
                                                                            'answers', COALESCE(q_answers.answers_json, '[]'::json)
                                                                        )
                                                                END AS qbc_item
                                                        ) final
                                                    ),
                                                    '[]'::json
                                                )
                                            )
                                            ORDER BY q.unique_code
                                        )
                                        FROM question q
                                        WHERE q.parent_code = CASE
                                            WHEN v.age_group = 'under_8_year_old' THEN c.code
                                            WHEN v.age_group = 'over_8_year_old' THEN REPLACE(c.code, '_', '.')
                                        END
                                    ),
                                    '[]'::json
                                )
                            )
                            ORDER BY
                                CASE
                                    WHEN v.age_group = 'under_8_year_old' THEN 1
                                    WHEN v.age_group = 'over_8_year_old' THEN 2
                                    ELSE 3
                                END
                        )
                        FROM (
                            SELECT DISTINCT age_group
                            FROM question_answer_view
                            WHERE (CAST(:age_group AS TEXT) IS NULL OR age_group = CAST(:age_group AS TEXT))
                        ) v
                    ),
                    '[]'::json
                )
            )
            ORDER BY c.code
        ) AS subtypes
    FROM disability_type c
    WHERE c.parent_code IS NOT NULL
    GROUP BY c.parent_code
)
SELECT
    dt.code AS disability_code,
    dt.title,
    dt.image,
    dt.description,
    COALESCE(ch.subtypes, '[]'::json) AS subtypes
FROM disability_type dt
LEFT JOIN children ch ON ch.parent_code = dt.code
WHERE dt.parent_code IS NULL
ORDER BY CAST(SUBSTRING(dt.code FROM '[0-9]+') AS INT);
""")

@router.get(
    "/fully-question-answer-disability",
    response_model=DisabilityCategoryQuestionResponse,
    description="Get full disability questions with main_category and answers per category"
)
async def get_fully_disability_questions(
    dob: Optional[str] = Query(None, description="Date of birth YYYY/MM/DD"),
    keycloak_user: Annotated[UserInSignInKeyCloak, Depends(get_user_info)] = None,
    db: Annotated[AsyncSession, Depends(async_get_db)] = None
):
    if keycloak_user:
        await validate_user(keycloak_user.username, keycloak_user, db)

    age_group = calculate_age_group(dob) if dob else None

    result = await db.execute(FULL_DISABILITY_SQL, {"age_group": age_group})
    rows = result.mappings().all()

    def get_image_url(filename: Optional[str]) -> Optional[str]:
        if not filename:
            return None
        encoded_filename = quote(filename)
        file_path = f"public/{encoded_filename}"
        return get_asset_url(file_path=file_path, token=keycloak_user.token)

    # Post-process the data to replace image filenames with URLs
    processed_data = []
    for row in rows:
        disability = dict(row)
        disability["image"] = get_image_url(disability.get("image"))
        subtypes = disability.get("subtypes", [])
        for subtype in subtypes:
            subtype["image"] = get_image_url(subtype.get("image"))

        disability["subtypes"] = subtypes
        processed_data.append(disability)

    return {"data": processed_data}



# GET all category_answer such as ដៃស្តាំ, ដៃឆ្វេង, ដៃទាំងពីរ, ... etc
@router.post(
    "/category_answer",
    summary = "Category of Answer in Answer part",
    description = "Get all Category answer that relate to answer"
)
async def category_answer(
    keycloak_user: Annotated[UserInSignInKeyCloak, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)]
) -> dict:
    """
    Seed the database with category answer.

    This endpoint inserts all the category_answer
    
    Args:
        keycloak_user: Authenticated user information
        db: Database session
        
    Returns:
        
    """

    logging.info("keycloak_user", keycloak_user)

    # Validate user
    db_user = await validate_user(keycloak_user.username, keycloak_user, db)
    user_id = db_user["id"]

    CATEGORY_ANSWER = [
        {"category": "ដៃស្តាំ" , "code": "C1", "child_code": "C1"},
        {"category": "ដៃឆ្វេង" , "code": "C2", "child_code": "C2"},
        {"category": "ដៃទាំងពីរ" , "code": "C3", "child_code": "C1_C2"},

        {"category": "ជើងស្តាំ" , "code": "C4", "child_code": "C4"},
        {"category": "ជើងឆ្វេង" , "code": "C5", "child_code": "C5"},
        {"category": "ជើងទាំងពីរ" , "code": "C6", "child_code": "C4_C5"},

        {"category": "ពាក់កណ្តាលខ្លួន" , "code": "C7", "child_code": "C7"},
        {"category": "ចំហៀងឆ្វេង ឬស្តាំ" , "code": "C8", "child_code": "C8"},
        {"category": "មួយតួខ្លួន" , "code": "C9", "child_code": "C7_C8"},

        {"category": "ត្រចៀកស្តាំ" , "code": "C10", "child_code": "C10"},
        {"category": "ត្រចៀកឆ្វេង" , "code": "C11", "child_code": "C11"},
        {"category": "ត្រចៀកទាំងពីរ" , "code": "C12", "child_code": "C10_C11"},

        {"category": "ភ្នែកស្តាំ" , "code": "C13", "child_code": "C13"},
        {"category": "ភ្នែកឆ្វេង" , "code": "C14", "child_code": "C14"},
        {"category": "ភ្នែកទាំងពីរ" , "code": "C15", "child_code": "C13_C14"},

        {"category": "NULL" , "code": "C16", "child_code": "C16"},
    ]

    try:
        inserted_count = 0
        skipped_count = 0
        failed_items = []
        
        for category_answer_data in CATEGORY_ANSWER:
            try:
                existing = await crud_category.get_by_category(
                    db=db,
                    category=category_answer_data["category"]
                )
                
                if existing:
                    skipped_count += 1
                    continue
                # Create new category type
                category_type_create = CategoryQuestionViewCreateInternal(
                    category=category_answer_data["category"],
                    code=category_answer_data["code"],
                    child_code=category_answer_data["child_code"],
                    created_by=user_id
                )
                
                # Insert into database
                await crud_category.create(db=db, object=category_type_create)
                inserted_count += 1
                
            except Exception as e:
                failed_items.append({
                    "category": category_answer_data["category"],
                    "error": str(e)
                })
        
        # Get final count
        total_in_db = len(await crud_category.get_all_active(db=db, limit=1000))
        
        return {
            "message": "Category types seeding completed",
            "summary": {
                "total_processed": len(CATEGORY_ANSWER),
                "inserted": inserted_count,
                "skipped": skipped_count,
                "failed": len(failed_items),
                "total_in_database": total_in_db
            },
            "failed_items": failed_items,
            "status": "success" if len(failed_items) == 0 else "partial_success"
        }
        
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to seed disability types: {str(e)}"
        )
    

@router.post(
    "/category_question_view",
    status_code=status.HTTP_200_OK,
    response_model=CategoryQuestionResponse,
)
async def insert_category_question_and_question(
    request: CategoryQuestionOnlyRequest,
    keycloak_user: Annotated[UserInSignInKeyCloak, Depends(get_user_info)],
    db: Annotated[AsyncSession, Depends(async_get_db)]
)-> CategoryQuestionResponse:
    try:
        # Validate user
        db_user = await validate_user(keycloak_user.username, keycloak_user, db)
        user_id = db_user["id"]

        CATEGORY_QUESTION_VIEW = {
            "under_8_year_old": {
                # under 8 years old
                "Q1_1_1": ["C1", "C2", "C3"],
                "Q1_1_2": ["C1", "C2", "C3"],
                "Q1_1_3": ["C1", "C2", "C3"],
                "Q1_1_4": ["C1", "C2", "C3"],
                "Q1_1_5": ["C1", "C2", "C3"],
                "Q1_1_6": ["C1", "C2", "C3"],
                "Q1_1_7": ["C1", "C2", "C3"],

                "Q1_2_1": ["C4", "C5", "C6"],
                "Q1_2_2": ["C4", "C5", "C6"],
                "Q1_2_3": ["C4", "C5", "C6"],
                "Q1_2_4": ["C4", "C5", "C6"],
                "Q1_2_5": ["C4", "C5", "C6"],
                "Q1_2_6": ["C4", "C5", "C6"],
                "Q1_2_7": ["C4", "C5", "C6"],
                "Q1_2_8": ["C16"],
                "Q1_2_9": ["C16"],

                "Q1_3_1": ["C16"],
                "Q1_3_2": ["C7", "C8", "C9"],
                "Q1_3_3": ["C16"],
                "Q1_3_4": ["C7", "C8", "C9"],
                "Q1_3_5": ["C7", "C8", "C9"],
                "Q1_3_6": ["C16"],
                "Q1_3_7": ["C16"],
                "Q1_3_8": ["C16"],
                "Q1_3_9": ["C16"],

                "Q1_4_1": ["C16"],
                "Q1_4_2": ["C16"],
                "Q1_4_3": ["C16"],
                "Q1_4_4": ["C16"],
                "Q1_4_5": ["C16"],
                "Q1_4_6": ["C16"],

                "Q2_1_1": ["C16"],
                "Q2_1_2": ["C10", "C11", "C12"],
                "Q2_1_3": ["C10", "C11", "C12"],
                "Q2_1_4": ["C10", "C11", "C12"],
                "Q2_1_5": ["C10", "C11", "C12"],
                "Q2_1_6": ["C10", "C11", "C12"],
                "Q2_1_7": ["C10", "C11", "C12"],

                "Q2_2_1": ["C16"],
                "Q2_2_2": ["C16"],
                "Q2_2_3": ["C16"],
                "Q2_2_4": ["C16"],
                "Q2_2_5": ["C16"],
                "Q2_2_6": ["C16"],
                "Q2_2_7": ["C16"],

                "Q2_3_1": ["C13", "C14", "C15"],
                "Q2_3_2": ["C13", "C14", "C15"],
                "Q2_3_3": ["C13", "C14", "C15"],
                "Q2_3_4": ["C13", "C14", "C15"],
                "Q2_3_5": ["C13", "C14", "C15"],
                "Q2_3_6": ["C13", "C14", "C15"],

                "Q3_1_1": ["C16"],
                "Q3_1_2": ["C16"],
                "Q3_1_3": ["C16"],
                "Q3_1_4": ["C16"],
                "Q3_1_5": ["C16"],
                "Q3_1_6": ["C16"],
                "Q3_1_7": ["C16"],
                "Q3_1_8": ["C16"],

                "Q3_2_1": ["C16"],
                "Q3_2_2": ["C16"],
                "Q3_2_3": ["C16"],
                "Q3_2_4": ["C16"],
                "Q3_2_5": ["C16"],
                "Q3_2_6": ["C16"],
                "Q3_2_7": ["C16"],
                "Q3_2_8": ["C16"],
                "Q3_2_9": ["C16"],

                "Q3_3_1": ["C16"],
                "Q3_3_2": ["C16"],
                "Q3_3_3": ["C16"],
                "Q3_3_4": ["C16"],
                "Q3_3_5": ["C16"],
                "Q3_3_6": ["C16"],
                "Q3_3_7": ["C16"],
                "Q3_3_8": ["C16"],

                "Q4_1_1": ["C16"],
                "Q4_1_2": ["C16"],
                "Q4_1_3": ["C16"],
                "Q4_1_4": ["C16"],
                "Q4_1_5": ["C16"],
                "Q4_1_6": ["C16"],
                "Q4_1_7": ["C16"],

                "Q4_2_1": ["C16"],
                "Q4_2_2": ["C16"],
                "Q4_2_3": ["C16"],
                "Q4_2_4": ["C16"],
                "Q4_2_5": ["C16"],
                "Q4_2_6": ["C16"],
                "Q4_2_7": ["C16"],

                "Q5_1_1": ["C16"],
                "Q5_1_2": ["C16"],
                "Q5_1_3": ["C16"],
                "Q5_1_4": ["C16"],
                "Q5_1_5": ["C16"],
                "Q5_1_6": ["C16"],

                "Q5_2_1": ["C16"],
                "Q5_2_2": ["C16"],
                "Q5_2_3": ["C16"],
                "Q5_2_4": ["C16"],
                "Q5_2_5": ["C16"],
                "Q5_2_6": ["C16"],
                "Q5_2_7": ["C16"],
                "Q5_2_8": ["C16"],

                "Q6_1_1": ["C16"],
                "Q6_1_2": ["C16"],

                "Q6_2_1": ["C16"],
                "Q6_2_2": ["C16"],
                "Q6_2_3": ["C16"],
                "Q6_2_4": ["C16"],
            },

            "over_8_year_old": {
                # Over 8 year old
                "Q1.1.1": ["C1", "C2", "C3"],
                "Q1.1.2": ["C1", "C2", "C3"],
                "Q1.1.3": ["C1", "C2", "C3"],
                "Q1.1.4": ["C1", "C2", "C3"],
                "Q1.1.5": ["C1", "C2", "C3"],
                "Q1.1.6": ["C1", "C2", "C3"],
                "Q1.1.7": ["C1", "C2", "C3"],

                "Q1.2.1": ["C4", "C5", "C6"],
                "Q1.2.2": ["C4", "C5", "C6"],
                "Q1.2.3": ["C4", "C5", "C6"],
                "Q1.2.4": ["C4", "C5", "C6"],
                "Q1.2.5": ["C4", "C5", "C6"],
                "Q1.2.6": ["C4", "C5", "C6"],
                "Q1.2.7": ["C4", "C5", "C6"],
                "Q1.2.8": ["C16"],
                "Q1.2.9": ["C16"],

                "Q1.3.1": ["C16"],
                "Q1.3.2": ["C7", "C8", "C9"],
                "Q1.3.3": ["C16"],
                "Q1.3.4": ["C7", "C8", "C9"],
                "Q1.3.5": ["C7", "C8", "C9"],
                "Q1.3.6": ["C16"],
                "Q1.3.7": ["C16"],
                "Q1.3.8": ["C16"],
                "Q1.3.9": ["C16"],

                "Q1.4.1": ["C16"],
                "Q1.4.2": ["C16"],
                "Q1.4.3": ["C16"],
                "Q1.4.4": ["C16"],
                "Q1.4.5": ["C16"],
                "Q1.4.6": ["C16"],

                "Q2.1.1": ["C16"],
                "Q2.1.2": ["C10", "C11", "C12"],
                "Q2.1.3": ["C10", "C11", "C12"],
                "Q2.1.4": ["C10", "C11", "C12"],
                "Q2.1.5": ["C10", "C11", "C12"],
                "Q2.1.6": ["C10", "C11", "C12"],
                "Q2.1.7": ["C10", "C11", "C12"],

                "Q2.2.1": ["C16"],
                "Q2.2.2": ["C16"],
                "Q2.2.3": ["C16"],
                "Q2.2.4": ["C16"],
                "Q2.2.5": ["C16"],
                "Q2.2.6": ["C16"],
                "Q2.2.7": ["C16"],

                "Q2.3.1": ["C13", "C14", "C15"],
                "Q2.3.2": ["C13", "C14", "C15"],
                "Q2.3.3": ["C13", "C14", "C15"],
                "Q2.3.4": ["C13", "C14", "C15"],
                "Q2.3.5": ["C13", "C14", "C15"],
                "Q2.3.6": ["C13", "C14", "C15"],
                "Q2.3.7": ["C13", "C14", "C15"],
                "Q2.3.8": ["C13", "C14", "C15"],
                "Q2.3.9": ["C13", "C14", "C15"],
                "Q2.3.10": ["C13", "C14", "C15"],

                "Q3.1.1": ["C16"],
                "Q3.1.2": ["C16"],
                "Q3.1.3": ["C16"],
                "Q3.1.4": ["C16"],
                "Q3.1.5": ["C16"],
                "Q3.1.6": ["C16"],
                "Q3.1.7": ["C16"],
                "Q3.1.8": ["C16"],
                "Q3.1.9": ["C16"],

                "Q3.2.1": ["C16"],
                "Q3.2.2": ["C16"],
                "Q3.2.3": ["C16"],
                "Q3.2.4": ["C16"],
                "Q3.2.5": ["C16"],
                "Q3.2.6": ["C16"],
                "Q3.2.7": ["C16"],
                "Q3.2.8": ["C16"],
                "Q3.2.9": ["C16"],

                "Q3.3.1": ["C16"],
                "Q3.3.2": ["C16"],
                "Q3.3.3": ["C16"],
                "Q3.3.4": ["C16"],
                "Q3.3.5": ["C16"],
                "Q3.3.6": ["C16"],
                "Q3.3.7": ["C16"],
                "Q3.3.8": ["C16"],

                "Q4.1.1": ["C16"],
                "Q4.1.2": ["C16"],
                "Q4.1.3": ["C16"],
                "Q4.1.4": ["C16"],
                "Q4.1.5": ["C16"],
                "Q4.1.6": ["C16"],
                "Q4.1.7": ["C16"],
                "Q4.1.8": ["C16"],
                "Q4.1.9": ["C16"],
                "Q4.1.10": ["C16"],

                "Q4.2.1": ["C16"],
                "Q4.2.2": ["C16"],
                "Q4.2.3": ["C16"],
                "Q4.2.4": ["C16"],
                "Q4.2.5": ["C16"],
                "Q4.2.6": ["C16"],
                "Q4.2.7": ["C16"],
                "Q4.2.8": ["C16"],
                "Q4.2.9": ["C16"],

                "Q5.1.1": ["C16"],
                "Q5.1.2": ["C16"],
                "Q5.1.3": ["C16"],
                "Q5.1.4": ["C16"],
                "Q5.1.5": ["C16"],
                "Q5.1.6": ["C16"],

                "Q5.2.1": ["C16"],
                "Q5.2.2": ["C16"],
                "Q5.2.3": ["C16"],
                "Q5.2.4": ["C16"],
                "Q5.2.5": ["C16"],
                "Q5.2.6": ["C16"],
                "Q5.2.7": ["C16"],
                "Q5.2.8": ["C16"],

                "Q6.1.1": ["C16"],
                "Q6.1.2": ["C16"],
                "Q6.1.3": ["C16"],
                "Q6.1.4": ["C16"],
                "Q6.1.5": ["C16"],
                "Q6.1.6": ["C16"],

                "Q6.2.1": ["C16"],
                "Q6.2.2": ["C16"],
                "Q6.2.3": ["C16"],
                "Q6.2.4": ["C16"],
            }

        }

        # Get mapping for the requested age group
        age_group = request.age_group
        age_group_mapping = CATEGORY_QUESTION_VIEW.get(age_group)
        if not age_group_mapping:
            raise HTTPException(status_code=400, detail=f"Invalid age group: {age_group}")

        # Bulk create category-question records
        all_new_records = await crud_category_question_view.create_bulk_by_age_group(
            db=db,
            user_id=user_id,
            category_question_mapping=age_group_mapping,
            age_group=age_group
        )

        if not all_new_records:
            raise HTTPException(status_code=400, detail="All records already exist.")

        return CategoryQuestionResponse(
            question_code=",".join(age_group_mapping.keys()),
            category_question_code=",".join(
                [code for codes in age_group_mapping.values() for code in codes]
            )
        )

    except Exception as e:
        await db.rollback()
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Unexpected error: {str(e)}"
        )


============

import asyncio
import logging
import uuid
from datetime import UTC, datetime
from datetime import date

from sqlalchemy import (
    Boolean,
    Date,
    Column,
    DateTime,
    ForeignKey,
    Text,
    Integer,
    MetaData,
    String,
    Table,
    insert,
    select,
    delete,
)
from sqlalchemy.dialects.postgresql import UUID

from ..app.core.config import settings
from ..app.core.db.database import AsyncSession, async_engine, local_session
from ..app.core.services.spr_service import encrypt_password
from ..app.models.disability_type import DisabilityType
from ..app.models.question import Question
from ..app.models.answer import Answer
from ..app.models.user import User
from ..app.models.question_answer import QuestionAnswer
from ..app.models.category_question import CategoryQuestion
from ..app.models.question_answer_view import QuestionAnswerView
from ..app.models.category_question_view import CategoryQuestionView
from ..app.models.main import Main,Gender, AccountStatus

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Disability-Type (ពិការភាពកាយសម្បទា, ពិបាកធ្វើចលនាលើ)
async def create_disability_type(session: AsyncSession) -> None:
    try:
        result = await session.execute(select(User.id).where(User.username == "gs_commune"))
        admin_user = result.scalar_one_or_none()
        created_by = admin_user if admin_user else None

        DISABILITY_TYPES_DATA = [
                # Physical Disabilities - Q1
                {"title": "ពិការភាពកាយសម្បទា", "code": "Q1", "description": "ពិការភាពផ្នែកកាយសម្បទា និងចលនា", "parent_code": None, "image": "ពិការភាពកាយសម្បទា.png"},
                {"title": "ពិបាកធ្វើចលនាលើ", "code": "Q1_1", "description": "ពិបាកធ្វើចលនាផ្នែកខាងលើនៃរាងកាយ", "parent_code": "Q1", "image": "ពិបាកធ្វើចលនាលើ.png"},
                {"title": "ពិបាកធ្វើចលនាក្រោម", "code": "Q1_2", "description": "ពិបាកធ្វើចលនាផ្នែកខាងក្រោមនៃរាងកាយ", "parent_code": "Q1", "image": "ពិបាកធ្វើចលនាក្រោម.png"},
                {"title": "ពិបាកសម្របសម្រួលដងខ្លួនខ្នង", "code": "Q1_3", "description": "ពិបាកក្នុងការសម្របសម្រួលដងខ្លួនខ្នង", "parent_code": "Q1", "image": "ពិបាកសម្របសម្រួលដងខ្លួនខ្នង.png"},
                {"title": "ពិការភាពសិរីរាង្គខាងក្នុង", "code": "Q1_4", "description": "ពិការភាពសិរីរាង្គខាងក្នុងរាងកាយ", "parent_code": "Q1", "image": "ពិការភាពសិរីរាង្គខាងក្នុង.png"},
                
                # Sensory Disabilities - Q2
                {"title": "ពិការភាពញ្ញាណដឹង", "code": "Q2", "description": "ពិការភាពផ្នែកញ្ញាណ និងការដឹងស្គាល់", "parent_code": None, "image": "ពិការភាពញ្ញាណដឹង.png"},
                {"title": "ពិបាកស្តាប់", "code": "Q2_1", "description": "ពិបាកក្នុងការស្តាប់ឮ", "parent_code": "Q2", "image": "ពិបាកស្តាប់.png"}, 
                {"title": "ពិបាកនិយាយ", "code": "Q2_2", "description": "ពិបាកក្នុងការនិយាយ", "parent_code": "Q2", "image": "ពិបាកនិយាយ.png"},
                {"title": "ពិបាកមើល", "code": "Q2_3", "description": "ពិបាកក្នុងការមើលឃើញ", "parent_code": "Q2", "image": "ពិបាកមើល.png"},
                
                # Intellectual Disabilities - Q3
                {"title": "ពិការភាពសតិបញ្ញា", "code": "Q3", "description": "ពិការភាពផ្នែកសតិបញ្ញា និងការយល់ដឹង", "parent_code": None, "image": "ពិការភាពសតិបញ្ញា.png"},
                {"title": "ដោស៊ីនដ្រូម", "code": "Q3_1", "description": "ជំងឺដោស៊ីនដ្រូម", "parent_code": "Q3", "image": "ដោស៊ីនដ្រូម.png"},
                {"title": "អូទីស្សឹម", "code": "Q3_2", "description": "ជំងឺអូទីស្សឹម", "parent_code": "Q3", "image": "អូទីស្សឹម.png"},
                {"title": "ពិការចលករខួរក្បាល(ស៊ីភី)", "code": "Q3_3", "description": "ពិការចលករខួរក្បាល (Cerebral Palsy)", "parent_code": "Q3", "image": "ពិការចលករខួរក្បាល(ស៊ីភី).png"},
                
                # Mental Health Disabilities - Q4
                {"title": "ពិការផ្លូវចិត្ត", "code": "Q4", "description": "ពិការភាពផ្នែកផ្លូវចិត្ត និងអារម្មណ៍", "parent_code": None, "image": "ពិការភាពភ្លូវចិត្ត.png"},
                {"title": "ពិការភាពផ្លូវចិត្ត", "code": "Q4_1", "description": "ពិការភាពផ្លូវចិត្តទូទៅ", "parent_code": "Q4", "image": "ពិការភាពផ្លូវចិត្ត.png"},
                {"title": "ពិបាកចងចាំ", "code": "Q4_2", "description": "ពិបាកក្នុងការចងចាំ និងការចាំ", "parent_code": "Q4", "image": "ពិបាកចងចាំ.png"},
                
                # Other Disabilities - Q5
                {"title": "ពិការភាពផ្សេងៗ", "code": "Q5", "description": "ពិការភាពប្រភេទផ្សេងៗ", "parent_code": None, "image": "ពិការភាពផ្សេងៗ.png"},
                {"title": "ជំងឺរមួលសារពាង្គកាយមិនប្រក្រតី", "code": "Q5_1", "description": "ជំងឺរុំរលាយសារពាង្គកាយមិនប្រក្រតី", "parent_code": "Q5", "image": "ជំងឺរមួលសារពាង្គកាយមិនប្រក្រតី.png"},
                {"title": "ពិការភាពផ្សេងៗ", "code": "Q5_2", "description": "ពិការភាពប្រភេទផ្សេងៗដទៃទៀត", "parent_code": "Q5", "image": "ពិការភាពផ្សេង.png"},

                #living enviroment - Q6
                {"title": "បរិស្ថានរស់នៅ", "code": "Q6", "description": "បរិស្ថានរស់នៅ", "parent_code": None, "image": "បរិស្ថានរស់នៅ.png"},
                {"title": "សកម្មភាពសង្គម", "code": "Q6_1", "description": "បរិស្ថានរស់នៅ", "parent_code": "Q6", "image": "សកម្មភាពសង្គម.png"},
                {"title": "ជំនួយការផ្ទាល់ខ្លួន", "code": "Q6_2", "description": "បរិស្ថានរស់នៅ", "parent_code": "Q6", "image": "ជំនួយការផ្ទាល់ខ្លួន.png"},
                {"title": "ឧបករណ៍ជំនួយ", "code": "Q6_3", "description": "បរិស្ថានរស់នៅ", "parent_code": "Q6", "image": "ឧបករណ៍ជំនួយ.png"},
            ]
        inserted = 0

        for item in DISABILITY_TYPES_DATA:
            # Create and insert using the model
            new_type = DisabilityType(
                title=item["title"],
                code=item["code"],
                description=item["description"],
                parent_code=item.get("parent_code"),
                image=item.get("image"),
                status=True,
                created_by=created_by,
                updated_by=created_by
            )
            session.add(new_type)
            inserted += 1

        await session.commit()
        logger.info(f"Disability types seeding completed → {inserted} inserted")

    except Exception as e:
        await session.rollback()
        logger.error(f"Error creating disability types: {str(e)}", exc_info=True)
        raise


# Questions of Disability-Type
async def create_question(session: AsyncSession) -> None:
    try:
        result = await session.execute(select(User.id).where(User.username == "gs_commune"))
        admin_user = result.scalar_one_or_none()
        created_by = admin_user if admin_user else None

        QUESTION_DISABILITY_TYPES = [
            # Age under 8 years old
            # Physical disability
            {"question": "តើកុមារអាចប្រើមេដៃចាប់កាន់ ឬលើកវត្ថុអ្វីមួយបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាលើ", "parent_code": "Q1_1", "unique_code": "Q1_1_1"},
            {"question": "តើកុមារអាចប្រើម្រាមដៃរើសវត្ថុដាក់ ដោះ ឬបិទឡេវអាវបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាលើ", "parent_code": "Q1_1", "unique_code": "Q1_1_2"},
            {"question": "តើកុមារអាចបង្វិលកដៃទៅឆ្វេង ឬស្តាំបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាលើ", "parent_code": "Q1_1", "unique_code": "Q1_1_3"},
            {"question": "តើកុមារអាចបត់កែងដៃ ដោយដាក់ចុងដៃលើស្មាបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាលើ", "parent_code": "Q1_1", "unique_code": "Q1_1_4"},
            {"question": "តើកុមារអាចលើក ដាក់ ឬទាញ វត្ថុបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាលើ", "parent_code": "Q1_1", "unique_code": "Q1_1_5"},
            {"question": "តើកុមារអាចលើកដៃដាក់ទៅមុខត្រឹមភ្នែកខ្លួនងងបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាលើ", "parent_code": "Q1_1", "unique_code": "Q1_1_6"},
            {"question": "តើកុមារអាចញាក់ ឬបង្វិលស្មាបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាលើ", "parent_code": "Q1_1", "unique_code": "Q1_1_7"},

            {"question": "តើកុមារអាចឈរអោយមានលំនឹងមួយកន្លែងលើសពី១នាទីបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាក្រោម", "parent_code": "Q1_2", "unique_code": "Q1_2_1"},
            {"question": "តើកុមារអាចដើរលើបន្ទាត់ត្រង់បានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាក្រោម", "parent_code": "Q1_2", "unique_code": "Q1_2_2"},
            {"question": "តើកុមារអាចដើរចុងជើង ឬចង្អើតចុងជើងបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាក្រោម", "parent_code": "Q1_2", "unique_code": "Q1_2_3"},
            {"question": "តើកុមារអាចបង្វិលកជើង ទៅឆ្វេង ឬទៅស្តាំ ឡើង ឬចុះបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាក្រោម", "parent_code": "Q1_2", "unique_code": "Q1_2_4"},
            {"question": "តើកុមារអាចឡើងចុះកៅអីកម្ពស់៣តឹកបានដែរឬទេ? (សាច់ដុំជើង)", "description": "ពិបាកធើ្វចលនាក្រោម", "parent_code": "Q1_2", "unique_code": "Q1_2_5"},
            {"question": "តើកុមារអាចឡើងចុះកាំជណ្តើរបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាក្រោម", "parent_code": "Q1_2", "unique_code": "Q1_2_6"},
            {"question": "តើកុមារអាចឡើងចុះកាំជណ្តើរបានដែរឬទេ ពេលមានអ្នកជួយ ឬឧបករណ៍ជំនួយ?", "description": "ពិបាកធើ្វចលនាក្រោម", "parent_code": "Q1_2", "unique_code": "Q1_2_7"},
            {"question": "តើកុមារអាចដើរដោយខ្លួនងងបានចម្ងាយប៉ុន្មានម៉ែត្រ?", "description": "ពិបាកធើ្វចលនាក្រោម", "parent_code": "Q1_2", "unique_code": "Q1_2_8"},
            {"question": "តើកុមារអាចដើរបានប៉ុន្មានម៉ែត្រ ដោយប្រើឧបករណ៍ជំនួយ ឬមានអ្នកជួយ?", "description": "ពិបាកធើ្វចលនាក្រោម", "parent_code": "Q1_2", "unique_code": "Q1_2_9"},

            {"question": "តើកុមារដេកក្នុងសភាពចុះខ្សោយខ្លាំងដែរឬទេ?", "description": "ពិបាកសម្របសម្រួលដងខ្លួន និងខ្នង", "parent_code": "Q1_3", "unique_code": "Q1_3_1"},
            {"question": "តើកុមារអាចក្រោកអង្គុយដោយគ្មានជំនួយបានដែរឬទេ?", "description": "ពិបាកសម្របសម្រួលដងខ្លួន និងខ្នង", "parent_code": "Q1_3", "unique_code": "Q1_3_2"},
            {"question": "តើកុមារបាត់បង់មុខងារចលករមួយចំហៀងខ្លួនឆ្វេង ឬស្តាំ ឬទាំងសងខាងដែរឬទេ? (លើស៦ខែ)", "description": "ពិបាកសម្របសម្រួលដងខ្លួន និងខ្នង", "parent_code": "Q1_3", "unique_code":"Q1_3_3"},
            {"question": "តើដងខ្លួនរបស់កុមារខូចទ្រង់ទ្រាយដែរឬទេ? (វៀច កោង គម ជាអចិន្រ្តៃយ៍)", "description": "ពិបាកសម្របសម្រួលដងខ្លួន និងខ្នង", "parent_code": "Q1_3", "unique_code": "Q1_3_4"},
            {"question": "តើដងខ្លួន និងអវយវះរបស់កុមារញាក់ញ៍រ ឬស្ពឹកខ្លាំងដែរឬទេ? (លើស៦ខែ)", "description": "ពិបាកសម្របសម្រួលដងខ្លួន និងខ្នង", "parent_code": "Q1_3", "unique_code": "Q1_3_5"},
            {"question": "តើកុមារធ្លាប់មានរបួសខួរឆ្អឹងខ្នងដែរឬទេ?", "description": "ពិបាកសម្របសម្រួលដងខ្លួន និងខ្នង", "parent_code": "Q1_3", "unique_code": "Q1_3_6"},
            {"question": "តើកុមារបាត់បង់មុខងារចលករត្រឹមចង្កេះចុះក្រោមដែរឬទេ? (លើស៦ខែ)", "description": "ពិបាកសម្របសម្រួលដងខ្លួន និងខ្នង", "parent_code": "Q1_3", "unique_code": "Q1_3_7"},
            {"question": "តើកុមារឈឺចាប់ខ្លាំងជាប្រចាំត្រង់ក​ ចង្កេះ ឬដងខ្លួនដែរទេ? (ឈឺជាអចិន្រ្តៃយ៍)", "description": "ពិបាកសម្របសម្រួលដងខ្លួន និងខ្នង", "parent_code": "Q1_3", "unique_code": "Q1_3_8"},
            {"question": "តើកុមារប្រើថ្នាំលេប ឬចាក់ជាប្រចាំដែរឬទេ? (លើស៦ខែ)", "description": "ពិបាកសម្របសម្រួលដងខ្លួន និងខ្នង", "parent_code": "Q1_3", "unique_code": "Q1_3_9"},

            {"question": "តើកុមារធ្លាប់មានការវះកាត់ធំលើសសរីរាង្គខាងក្នុងដែរឬទេ?", "description": "ពិការភាពសរីរាង្គខាងក្នុង", "parent_code": "Q1_4", "unique_code": "Q1_4_1"},
            {"question": "តើសរីរាង្គខាងក្នុងរបស់កុមារធ្លាប់ឈឺចាប់ដែរឬទេ?", "description": "ពិការភាពសរីរាង្គខាងក្នុង", "parent_code": "Q1_4", "unique_code": "Q1_4_2"},
            {"question": "តើកុមារប្រើឧបករណ៍ជំនួយសរីរាង្គដែរឬទេ?", "description": "ពិការភាពសរីរាង្គខាងក្នុង", "parent_code": "Q1_4", "unique_code": "Q1_4_3"},
            {"question": "តើកុមារប្រើថ្នាំពេទ្យដែរឬទេ សម្រាប់ជំងឺដែលបានវះកាត់ធំ?", "description": "ពិការភាពសរីរាង្គខាងក្នុង", "parent_code": "Q1_4", "unique_code": "Q1_4_4"},
            {"question": "តើកុមារអាចដើរ ឬលោតបានដែរឬទេចាប់តាំងពីក្រោយវះកាត់ធំ?", "description": "ពិការភាពសរីរាង្គខាងក្នុង", "parent_code": "Q1_4", "unique_code": "Q1_4_5"},
            {"question": "តើកុមារអាចមើលថែទាំអនាម័យខ្លួនងង ឬរស់នៅដោយងករាជ្យបានដែរឬទេ?", "description": "ពិការភាពសរីរាង្គខាងក្នុង", "parent_code": "Q1_4", "unique_code": "Q1_4_6"},

            # Cognitive disability
            {"question": "តើកុមារអាចស្តាប់ព្ឬដែរឬទេ?", "description": "ពិបាកស្តាប់", "parent_code": "Q2_1", "unique_code": "Q2_1_1"},
            {"question": "តើកុមារមានប្រើឧបករណ៍ជំនួយការស្តាប់ជាប្រចាំដែរឬទេ?", "description": "ពិបាកស្តាប់", "parent_code": "Q2_1", "unique_code": "Q2_1_2"},
            {"question": "បើខ្ញុំគោះប៊ិកលើបាតដៃរបស់ខ្ញុំ តើកុមារស្តាប់ព្ឬដែរឬទេ? (គោះស្តាំឆ្វេងពីមុខ ពីក្រោយ)", "description": "ពិបាកស្តាប់", "parent_code": "Q2_1", "unique_code": "Q2_1_3"},
            {"question": "តើកុមារពិបាកស្តាប់ ឬយល់ពីនរណាម្នាក់និយាយដែរឬទេ?", "description": "ពិបាកស្តាប់", "parent_code": "Q2_1", "unique_code": "Q2_1_4"},
            {"question": "តើកុមារមានបញ្ហាក្នុងការស្តាប់វិទ្យា ឬទូរទស្សន៍ដែរឬទេ? (ទោះបើកសំឡេងខ្លាំងៗក៏ដោយ)", "description": "ពិបាកស្តាប់", "parent_code": "Q2_1", "unique_code": "Q2_1_5"},
            {"question": "តើកុមារពិបាកស្តាប់ នៅពេលនរណាម្នាក់និយាយតិចៗដែរឬទេ?", "description": "ពិបាកស្តាប់", "parent_code": "Q2_1", "unique_code": "Q2_1_6"},
            {"question": "តើកុមារមានបញ្ហាស្តាប់ ដែលបណ្តាលអោយអ្នកប្រកែកជាមួយគេញឹកញាប់ដែរឬទេ?", "description": "ពិបាកស្តាប់", "parent_code": "Q2_1", "unique_code": "Q2_1_7"},

            {"question": "តើកុមារអាចនិយាយ ឬសន្ទនាបានដែរឬទេ?", "description": "ពិបាកនិយាយ", "parent_code": "Q2_2", "unique_code": "Q2_2_1"},
            {"question": "តើកុមារអាចនិយាយលើសពី ៥ ពាក្យជាប់គ្នាដែរឬទេ?", "description": "ពិបាកនិយាយ", "parent_code": "Q2_2", "unique_code": "Q2_2_2"},
            {"question": "តើកុមារប្រើភាសាសញ្ញា ឬភាសាកាយវិការដែរឬទេ ពេលនិយាយ?", "description": "ពិបាកនិយាយ", "parent_code": "Q2_2", "unique_code": "Q2_2_3"},
            {"question": "តើកុមារពិបាក ក្នុងការនិយាយភាសាកំណើតរបស់ខ្លួនច្បាស់ដែរឬទេ?", "description": "ពិបាកនិយាយ", "parent_code": "Q2_2", "unique_code":"Q2_2_4"},
            {"question": "តើកុមារអាចនិយាយត្រាប់តាមបានដែរឬទេ?", "description": "ពិបាកនិយាយ", "parent_code": "Q2_2", "unique_code":"Q2_2_5"},
            {"question": "តើកុមារនិយាយ ដោយប្រើខ្យល់ច្រមុះ(ក្ងួរ) ដែរឬទេ?", "description": "ពិបាកនិយាយ", "parent_code": "Q2_2", "unique_code": "Q2_2_6"},
            {"question": "តើកុមារមានការពិបាកបញ្ចេញសូរសំឡេងដែរឬទេ?", "description": "ពិបាកនិយាយ", "parent_code": "Q2_2", "unique_code": "Q2_2_7"},

            {"question": "តើកុមារអាចមើលឃើញ ក្នុងបរិយាកាសធម្មតាដែរឬទេ?", "description": "ពិបាកមើល", "parent_code": "Q2_3", "unique_code": "Q2_3_1"},
            {"question": "តើកុមារអាចមើលឃើញច្បាស់ដែរឬទេទោះពាក់វ៉ែនតាក៏ដោយ?", "description": "ពិបាកមើល", "parent_code": "Q2_3", "unique_code": "Q2_3_2"},
            {"question": "តើកុមារអាចមើលឃើញម្រាមដៃច្បាស់ក្នុងចម្ងាយ ៥ ម៉ែត្រដែរឬទេ? (ទោះពាក់វែនតាក៏ដោយ)", "description": "ពិបាកមើល", "parent_code": "Q2_3", "unique_code": "Q2_3_3"},
            {"question": "តើកុមារអាចមើលឃើញម្រាមដៃច្បាស់ក្នុងចម្ងាយ៣ម៉ែត្រដែរឬទេ? (ទោះពាក់វ៉ែនតាក៏ដោយ)", "description": "ពិបាកមើល", "parent_code": "Q2_3", "unique_code":"Q2_3_4"},
            {"question": "តើកុមារអាចមើលឃើញម្រាមដៃច្បាស់ក្នុងចម្ងាយ៤០ម៉ែត្របានដែរឬទេ? (ពាក់វ៉ែនតាក៏ដោយ)", "description": "ពិបាកមើល", "parent_code": "Q2_3", "unique_code": "Q2_3_5"},
            {"question": "តើកុមារអាចមើលឃើញពណ៏ (បែតង ខៀវ ក្រហម លឿង) ដែរឬទេ?", "description": "ពិបាកមើល", "parent_code": "Q2_3", "unique_code": "Q2_3_6"},

            # Intellectual disability
            {"question": "តើកុមារដេក ឬសរីរាង្គកាយ ពិសេសសាច់ដុំស្ថិតក្នុងសភាពចុះខ្សោយខ្លាំងដែរឬទេ?", "description": "ដោនស៊ីនដ្រូម", "parent_code": "Q3_1", "unique_code": "Q3_1_1"},
            {"question": "តើកុមារមានឥរិយាបថពិបាកសម្របខ្លួនជាមួយសង្គមដែរឬទេ?", "description": "ដោនស៊ីនដ្រូម", "parent_code": "Q3_1", "unique_code": "Q3_1_2"},
            {"question": "តើកុមារមានការនិយាយម្តងហើយម្តងទៀត ឬរវើរវាយដែរឬទេ? (និយាយដដែលៗ)", "description": "ដោនស៊ីនដ្រូម", "parent_code": "Q3_1", "unique_code": "Q3_1_3"},
            {"question": "តើកុមារនិយាយច្រើន ឬតិចតួចបំផុត ប៉ុន្តែពិបាកយល់ពីការប្រាស្រ័យទាក់ទងតាមពាក្យសម្តីដែរឬទេ?", "description": "ដោនស៊ីនដ្រូម", "parent_code": "Q3_1", "unique_code": "Q3_1_4"},
            {"question": "តើកុមារមានអាកប្បកិរិយារញ៉េរញ៉ៃ ឬចលនាម្តងទៅនេះម្តងទៅនោះដែរឬទេ?", "description": "ដោនស៊ីនដ្រូម", "parent_code": "Q3_1", "unique_code": "Q3_1_5"},
            {"question": "តើកុមារធ្លាប់រវើរវាយ ឬចង់ធើ្វនេះធើ្វនោះមិនធម្មតាដែរឬទេ?", "description": "ដោនស៊ីនដ្រូម", "parent_code": "Q3_1", "unique_code": "Q3_1_6"},
            {"question": "តើកុមារពិបាកនិយាយគ្នាលើរឿងតែមួយ ឬរក្សាការសន្ទនាគ្នាទៅវិញទៅមកដែរឬទេ?", "description": "ដោនស៊ីនដ្រូម", "parent_code": "Q3_1", "unique_code": "Q3_1_7"},
            {"question": "តើកុមារពិបាកក្នុងការយល់ដឹងពីអារម្មណ៍កុមារដទៃដែរឬទេ?", "description": "ដោនស៊ីនដ្រូម", "parent_code": "Q3_1", "unique_code": "Q3_1_8"},

            {"question": "តើកុមារនិយាយតិចតួចហើយផ្តល់ចម្លើយមិនទាក់ទងទៅនឹងសំណួរដែរឬទេ?", "description": "អូទីស្សឹម", "parent_code": "Q3_2", "unique_code": "Q3_2_1"},
            {"question": "តើកុមារមិនឆ្លើយតប បើហៅឈ្មោះចំៗ ឬគេចវេសពីការមើលភ្នែកដែរឬទេ?", "description": "អូទីស្សឹម", "parent_code": "Q3_2", "unique_code": "Q3_2_2"},
            {"question": "តើកុមារពិបាកយល់អំពីអារម្មណ៍របស់កុមារដទៃដែរឬទេ?", "description": "អូទីស្សឹម", "parent_code": "Q3_2", "unique_code": "Q3_2_3"},
            {"question": "តើកុមារងាយនឹងតូចចិត្តដែរឬទេ បើយើងផ្លាស់ប្តូរ ឬយកអ្វីមួយពីពួកគេ?", "description": "អូទីស្សឹម", "parent_code": "Q3_2", "unique_code": "Q3_2_4"},
            {"question": "តើកុមារតែងមានចំណាប់អារម្មណ៍ងប់និងអ្វីមួយដែរឬទេ? (ធើ្វអីធ្វើនឹង មិនរវល់ ឬតប)", "description": "អូទីស្សឹម", "parent_code": "Q3_2", "unique_code": "Q3_2_5"},
            {"question": "តើកុមារងាយប្តូរអារម្មណ៍តានតឹង ឬរំភើបពេលប៉ះ ចាប់ រងក្លិន រសជាតិ ឬសំឡេងអ្វីមួយដែរឬទេ?", "description": "អូទីស្សឹម", "parent_code": "Q3_2", "unique_code": "Q3_2_6"},
            {"question": "តើកុមារពិបាកទំនាក់ទំនងសង្គមជាមួយមនុស្សដទៃទៀតដែរឬទេ? (និយាយត្រាប់តាម ឬឡងពាក្យ)", "description": "អូទីស្សឹម", "parent_code": "Q3_2", "unique_code": "Q3_2_7"},
            {"question": "តើកុមារមិនអោយកុមារផ្សេង ឬអ្នកដទែដែលមិនស្គាល់ប៉ះដៃ ឬរូបរាងកាយដែរឬទេ?", "description": "អូទីស្សឹម", "parent_code": "Q3_2", "unique_code": "Q3_2_8"},
            {"question": "តើកុមារបង្ហាញការយល់ដឹងតិចតួចអំពីស្ថានភាពគ្រោះថ្នាក់ដែរឬទេ?", "description": "អូទីស្សឹម", "parent_code": "Q3_2", "unique_code": "Q3_2_9"},

            {"question": "តើកុមារអាចដើរក្នុងផ្ទះ ឬក្រៅផ្ទះ និងឡើងជណ្តើរដោយខ្លួនងងមិនចាំបាត់ជួយកាន់ដៃដែរឬទេ?", "description": "ពិការចលករខួរក្បាល(ស៊ីភី)", "parent_code": "Q3_3", "unique_code": "Q3_3_1"},
            {"question": "តើកុមារអាចធើ្វសកម្មភាព ដូចជារត់ ឬលោតបានដែរឬទេ?", "description": "ពិការចលករខួរក្បាល(ស៊ីភី)", "parent_code": "Q3_3", "unique_code": "Q3_3_2"},
            {"question": "តើកុមារមានការថមថយកម្លាំង ឬល្បឿនលំនឹងខ្លួន និងការសម្របសម្រួលសាច់ដុំដែរឬទេ?", "description": "ពិការចលករខួរក្បាល(ស៊ីភី)", "parent_code": "Q3_3", "unique_code": "Q3_3_3"},
            {"question": "តើកុមារប្រើរទេះរុញជាប្រចាំ ដោយខ្លួនងងបានដែរឬទេ?", "description": "ពិការចលករខួរក្បាល(ស៊ីភី)", "parent_code": "Q3_3", "unique_code": "Q3_3_4"},
            {"question": "តើកុមារអាចឈរបានដែរឬទេ?", "description": "ពិការចលករខួរក្បាល(ស៊ីភី)", "parent_code": "Q3_3", "unique_code": "Q3_3_5"},
            {"question": "តើកុមារពិបាកបញ្ជកាយសម្បទា ធើ្វចលនា និងចល័តដែរឬទេ?", "description": "ពិការចលករខួរក្បាល(ស៊ីភី)", "parent_code": "Q3_3", "unique_code": "Q3_3_6"},
            {"question": "តើកុមារមានការពិបាកគ្រប់ផ្នែកកាយសម្បទាទាំងអស់ដែរឬទេ?", "description": "ពិការចលករខួរក្បាល(ស៊ីភី)", "parent_code": "Q3_3", "unique_code": "Q3_3_7"},
            {"question": "តើកុមារមានសមត្ថភាពការពារក្បាល ក និងទីតាំងផ្សេងទៀតដោយខ្លួនងងដែរឬទេ?", "description": "ពិការចលករខួរក្បាល(ស៊ីភី)", "parent_code": "Q3_3", "unique_code": "Q3_3_8"},

            # Mentally disabled
            {"question": "តើកុមារមានអារម្មណ៍ពិបាកចិត្ត ឆាប់ខឹង ឆាប់ភ័យញ័រ ថប់បារម្ភ ឬតានតឹងខ្លាំងដែរឬទេ?", "description": "ពិការផ្លូវចិត្ត", "parent_code": "Q4_1", "unique_code": "Q4_1_1"},
            {"question": "តើកុមារមានអារម្មណ៍ចង់បោកក្បាលខ្លួនងងជាប្រចាំដែរឬទេ?", "description": "ពិការផ្លូវចិត្ត", "parent_code": "Q4_1", "unique_code": "Q4_1_2"},
            {"question": "តើកុមារមានអារម្មណ៍ចង់នៅតែម្នាក់ងង ឬខ្លាចគេងងមកជិតដែរឬទេ?", "description": "ពិការផ្លូវចិត្ត", "parent_code": "Q4_1", "unique_code": "Q4_1_3"},
            {"question": "តើកុមារមានអារម្មណ៍បោចទាញ ចង់វៃ ជេរប្រទេច បំផ្លិចបំផ្លាញជាញឹកញាប់ដែរឬទេ?", "description": "ពិការផ្លូវចិត្ត", "parent_code": "Q4_1", "unique_code": "Q4_1_4"},
            {"question": "តើកុមារមានអារម្មណ៍ធុញទ្រាន់ខ្លាំង ឬក្តោបត្រចៀកជាញឹកញាប់ ពេលនរណាម្នាក់និយាយដែរឬទេ?", "description": "ពិការផ្លូវចិត្ត", "parent_code": "Q4_1", "unique_code": "Q4_1_5"},
            {"question": "រៀងរាល់ពេលឃើញមនុស្សច្រើន តើកុមារយំខ្លាំងដែរឬទេ? (ទោះជាមនុស្សធ្លាប់ស្គាល់ឬជួបពីមុន)", "description": "ពិការផ្លូវចិត្ត", "parent_code": "Q4_1", "unique_code": "Q4_1_6"},
            {"question": "តើកុមារឧស្សាហ៍យំតែម្នាក់ងង ដោយមិនមានមូលហេតុដែរឬទេ?", "description": "ពិការផ្លូវចិត្ត", "parent_code": "Q4_1", "unique_code": "Q4_1_7"},

            {"question": "បើធៀបនឹងកុមារអាយុដំណាលគ្នា តើកុមារចេះប្រាប់ ឬបង្ហាញពីច្រមុះ មាត់ ត្រចៀក ឬភ្នែកដែរឬទេ?", "description": "ពិបាកចងចាំ", "parent_code": "Q4_2", "unique_code": "Q4_2_1"},
            {"question": "បើធៀបនឹងកុមារអាយុដំណាលគ្នា តើកុមារអាចធើ្វតាមការប្រាប់ដែលសាមញ្ញៗ បានដែរឬទេ?", "description": "ពិបាកចងចាំ", "parent_code": "Q4_2", "unique_code": "Q4_2_2"},
            {"question": "តើកុមារអាចស្គាល់ឈ្មោះសត្វ ដែលមនុស្សទូទៅស្គាល់ដែរឬទេ?", "description": "ពិបាកចងចាំ", "parent_code": "Q4_2", "unique_code": "Q4_2_3"},
            {"question": "តើកុមាររៀបចំគំនិត ក្នុងការនិយាយ ឬសរសេរ តាមការប្រាប់ដែរឬទេ?", "description": "ពិបាកចងចាំ", "parent_code": "Q4_2", "unique_code": "Q4_2_4"},
            {"question": "តើកុមារដឹងពីសកម្មភាពដែលត្រូវធើ្វតាមលំដាប់លំដោយ ដែលបានប្រាប់ដែរឬទេ?", "description": "ពិបាកចងចាំ", "parent_code": "Q4_2", "unique_code": "Q4_2_5"},
            {"question": "តើកុមារអាចនិយាយអ្វីដែលបានកើតឡើងពីម្សិលមិញ ឬកន្លងមកបានដែរឬទេ?", "description": "ពិបាកចងចាំ", "parent_code": "Q4_2", "unique_code": "Q4_2_6"},
            {"question": "តើការរៀនរបស់កុមារ ស្របតាមការលូតលាស់របស់កុមារដែរឬទេ?", "description": "ពិបាកចងចាំ", "parent_code": "Q4_2", "unique_code": "Q4_2_7"},

            # Other disabilities
            {"question": "តើកុមារធ្លាប់ប្រកាច់ ឬឆ្កួតជ្រូកក្នុងរយះពេល៣ខែចុងក្រោយដែរឬទេ?", "description": "ជំងឺរមួលសារពាង្គកាយមិនប្រក្រតី", "parent_code": "Q5_1", "unique_code":"Q5_1_1"},
            {"question": "តើកុមារធ្លាប់មានជំងឺប្រកាច់ ឬប្រកាច់បណ្តាលមកពីគ្រុនក្តៅខ្លាំងដែរឬទេ?", "description": "ជំងឺរមួលសារពាង្គកាយមិនប្រក្រតី", "parent_code": "Q5_1", "unique_code": "Q5_1_2"},
            {"question": "តើការប្រកាច់ ឬជំងឺឆ្កួតជ្រូកមិនអាចគ្រប់គ្រងបាន ទោះបីជាមានការព្យាបាលនៅមន្ទីរពេទ្យ និងការព្យាបាលដោយថ្នាំដែរឬទេ? (ចាំបាច់ត្រូវមានការបញ្ជាក់ពីមណ្ធលសុខភាព)", "description": "ជំងឺរមួលសារពាង្គកាយមិនប្រក្រតី", "parent_code": "Q5_1", "unique_code": "Q5_1_3"},
            {"question": "តើកុមារធ្លាប់បញ្ជូនទៅមន្ទីរពេទ្យ ៥ដង ឬលើសពីនេះ ដោយសារការប្រកាច់ ឬជំងឺឆ្កួតជ្រូកដែរឬទេ?", "description": "ជំងឺរមួលសារពាង្គកាយមិនប្រក្រតី", "parent_code": "Q5_1", "unique_code": "Q5_1_4"},
            {"question": "តើកុមារធ្លាប់ប្រកាច់ធើ្វអោយរបួសរាង្គកាយធ្ងន់ធ្ងរ ត្រូវព្យាបាលភ្លាមៗ ឬសម្រាកព្យាបាលនៅមន្ទីរពេទ្យដែរឬទេ?", "description": "ជំងឺរមួលសារពាង្គកាយមិនប្រក្រតី", "parent_code": "Q5_1", "unique_code": "Q5_1_5"},
            {"question": "តើកុមារធ្លាប់ប្រើថ្នាំសម្រាប់ការពារប្រកាច់ដែរឬទេ?", "description": "ជំងឺរមួលសារពាង្គកាយមិនប្រក្រតី", "parent_code": "Q5_1", "unique_code": "Q5_1_6"},

            {"question": "តើកុមារមានជំងឺរាំរៃ (លើសពី៦ខែ) ប្រចាំកាយដែរឬទេ?", "description": "ជំងឺរាំរៃ", "parent_code": "Q5_2", "unique_code": "Q5_2_1"},
            {"question": "តើកុមារធ្លាប់មានរបួស ឬវះកាត់ធំសរីរាង្គខាងក្នុងដែរឬទេ?", "description": "ជំងឺរាំរៃ", "parent_code": "Q5_2", "unique_code": "Q5_2_2"},
            {"question": "តើកុមារត្រូវការប្រើប្រាស់ថ្នាំព្យាបាលជាប្រចាំដែរឬទេ?", "description": "ជំងឺរាំរៃ", "parent_code": "Q5_2", "unique_code": "Q5_2_3"},
            {"question": "តើជំងឺរបស់កុមារមានការឈឺចាប់ជាប្រចាំដែរឬទេ?", "description": "ជំងឺរាំរៃ", "parent_code": "Q5_2", "unique_code": "Q5_2_4"},
            {"question": "តើកុមារត្រូវការពិគ្រោះយោបល់ និងព្យាបាលជាប្រចាំជាមួយគ្រូពេទ្យដែរឬទេ?", "description": "ជំងឺរាំរៃ", "parent_code": "Q5_2", "unique_code": "Q5_2_5"},
            {"question": "តើកុមារអាចធើ្វចលនា ឬហាត់ប្រាណដោយខ្លួនងងដែរឬទេ?", "description": "ជំងឺរាំរៃ", "parent_code": "Q5_2", "unique_code": "Q5_2_6"},
            {"question": "តើជំងឺរបស់កុមារបានបង្កផលពិបាកដល់សកម្មភាពប្រចាំថ្ងៃរបស់កុមារដែរឬទេ?", "description": "ជំងឺរាំរៃ", "parent_code": "Q5_2", "unique_code": "Q5_2_7"},
            {"question": "តើជំងឺរបស់កុមារបានប៉ះពាល់ដល់អារម្មណ៍របស់កុមារ (ខឹង មួរមឍ៉ៅ ខ្លាច ) ដែរឬទេ?", "description": "ជំងឺរាំរៃ", "parent_code": "Q_5", "unique_code": "Q5_2_8"},

            # Living environment
            {"question": "ធៀបទៅនឹងកុមារដែលមានអាយុដំណាលគ្នា តើកុមារលេងជាមួយក្មេងដទៃដែរឬទេ?", "description": "សកម្មភាពសង្គម", "parent_code": "Q6_1", "unique_code": "Q6_1_1"},
            {"question": "ធៀបជាមួយកុមារមានអាយុដំណាលគ្នា តើកុមារជាធម្មតាបង្ហាញការអាណិតដល់ក្មេងដទៃដែរឬទេ?", "description": "សកម្មភាពសង្គម", "parent_code": "Q6_1", "unique_code": "Q6_1_2"},

            {"question": "តើមាននរណាម្នាក់ចាំជួយមើលកុមារធើ្វសកម្មភាពជាប្រចាំលើសពី ៨ ម៉ោងដែរឬទេ?", "description": "ជំនួយការ", "parent_code": "Q6_2", "unique_code": "Q6_2_1"},
            {"question": "តើកុមារត្រូវការជំនួយបន្ថែមក្នុងសកម្មភាពប្រចាំថ្ងៃនៅផ្ទះ ឬក្រៅផ្ទះនៅពេលពួកគេធំឡើងដែរឬទេ?", "description": "ជំនួយការ", "parent_code": "Q6_2","unique_code":"Q6_2_2"},
            {"question": "តើកុមារត្រូវការជំនួយក្នុងសកម្មភាពប្រចាំថ្ងៃដែរឬទេ?", "description": "ជំនួយការ", "parent_code": "Q6_2","unique_code": "Q6_2_3"},
            {"question": "តើកុមារត្រូវការ ការជំនួយក្នុងសកម្មភាពប្រចាំថ្ងៃ (២៤ ៧) ដែរឬទេ?", "description": "ជំនួយការ", "parent_code": "Q6_2","unique_code":"Q6_2_4"},

            # Auxiliary equipment


            #Age over 8 years old
            # Physical disability
            {"question": "តើអ្នកអាចប្រើមេដៃចាប់កាន់ ឬលើកវត្ថុអ្វីមួយបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាលើ", "parent_code": "Q1.1", "unique_code": "Q1.1.1"},
            {"question": "តើអ្នកអាចប្រើម្រាមដៃរើសវត្ថុដាក់ ដោះឬបិទឡេវអាវបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាលើ", "parent_code": "Q1.1", "unique_code": "Q1.1.2"},
            {"question": "តើអ្នកអាចបង្វិលកដៃទៅឆ្វេង ឬស្តាំបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាលើ", "parent_code": "Q1.1", "unique_code": "Q1.1.3"},
            {"question": "តើអ្នកអាចបត់កែងដៃ ដោយដាក់ចុងដៃលើស្មាបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាលើ", "parent_code": "Q1.1", "unique_code": "Q1.1.4"},
            {"question": "តើអ្នកអាចលើក ដាក់ ឬទាញ វត្ថុទម្ងន់ កន្លះគីឡូក្រាម ឬធ្ងន់ជាងនេះបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាលើ", "parent_code": "Q1.1", "unique_code":"Q1.1.5"},
            {"question": "តើអ្នកអាចលើកដៃដាក់ទៅមុខត្រឹមភ្នែកខ្លួនងងបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាលើ", "parent_code": "Q1.1", "unique_code": "Q1.1.6"},
            {"question": "តើអ្នកអាចញាក់ ឬបង្វិលស្មាបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាលើ", "parent_code": "Q1.1", "unique_code": "Q1.1.7"},

            {"question": "តើអ្នកអាចឈរអោយមានលំនឹងមួយកន្លែងលើសពី១០នាទីបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាក្រោម", "parent_code": "Q1.2", "unique_code": "Q1.2.1"},
            {"question": "តើអ្នកអាចដើរលើបន្ទាត់ត្រង់លើសពី១០នាទីដែរឬទេ?", "description": "ពិបាកធើ្វចលនាក្រោម", "parent_code": "Q1.2", "unique_code": "Q1.2.2"},
            {"question": "តើអ្នកអាចដើរ ចុងជើង ឬចង្អើតចុងជើងបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាក្រោម", "parent_code": "Q1.2", "unique_code": "Q1.2.3"},
            {"question": "តើអ្នកអាចបង្វិលកជើង ទៅឆ្វេង ឬទៅស្តាំ ឡើង ឬចុះបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាក្រោម", "parent_code": "Q1.2", "unique_code": "Q1.2.4"},
            {"question": "តើអ្នកអាចឡើងចុះកៅអីកម្ពស់៣តឹកបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាក្រោម", "parent_code": "Q1.2", "unique_code": "Q1.2.5"},
            {"question": "តើអ្នកអាចឡើងចុះកាំជណ្តើរបានដែរឬទេ?", "description": "ពិបាកធើ្វចលនាក្រោម", "parent_code": "Q1.2", "unique_code": "Q1.2.6"},
            {"question": "តើអ្នកអាចឡើងចុះកាំជណ្តើរបានដែរឬទេ ពេលមានអ្នកជួយ ឬតោងយឺតបង្កាន់ដៃ?", "description": "ពិបាកធើ្វចលនាក្រោម", "parent_code": "Q1.2", "unique_code": "Q1.2.7"},
            {"question": "តើអ្នកអាចដើរដោយខ្លួនងង ដោយគ្មានអ្នកជួយបានចម្ងាយប៉ុន្មានម៉ែត្រ?", "description": "ពិបាកធើ្វចលនាក្រោម", "parent_code": "Q1.2", "unique_code": "Q1.2.8"},
            {"question": "តើអ្នកអាចដើរបានប៉ុន្មានម៉ែត្រ ដោយប្រើឧបករណ៍ជំនួយ ឬមានអ្នកជួយ?", "description": "ពិបាកធើ្វចលនាក្រោម", "parent_code": "Q1.2", "unique_code": "Q1.2.9"},

            {"question": "តើអ្នកដេកក្នុងសភាពចុះខ្សោយខ្លាំងដែរឬទេ?", "description": "ពិបាកសម្របសម្រួលដងខ្លួន និងខ្នង", "parent_code": "Q1.3", "unique_code": "Q1.3.1"},
            {"question": "តើអ្នកអាចក្រោកអង្គុយដោយគ្មានជំនួយបានដែរឬទេ?", "description": "ពិបាកសម្របសម្រួលដងខ្លួន និងខ្នង", "parent_code": "Q1.3", "unique_code": "Q1.3.2"},
            {"question": "តើអ្នកបាត់បង់មុខងារចលករមួយចំហៀងខ្លួនឆ្វេង ឬស្តាំសងខាងដែរឬទេ? (លើស៦ខែ)", "description": "ពិបាកសម្របសម្រួលដងខ្លួន និងខ្នង", "parent_code": "Q1.3", "unique_code": "Q1.3.3"},
            {"question": "តើដងខ្លួនរបស់អ្នកខូចទ្រង់ទ្រាយដែរឬទេ? (វៀច កោង គម ជាអចិន្រែ្តយ៍)", "description": "ពិបាកសម្របសម្រួលដងខ្លួន និងខ្នង", "parent_code": "Q1.3", "unique_code": "Q1.3.4"},
            {"question": "តើដងខ្លួន និងអវយវះរបស់ញាក់ញ័រឬស្ពឹកខ្លាំងឬទេ? (លើស៦ខែ)", "description": "ពិបាកសម្របសម្រួលដងខ្លួន និងខ្នង", "parent_code": "Q1.3", "unique_code": "Q1.3.5"},
            {"question": "តើអ្នកធ្លាប់មានរបួសខួរឆ្អឹងខ្នងដែររទេ?", "description": "ពិបាកសម្របសម្រួលដងខ្លួន និងខ្នង", "parent_code": "Q1.3", "unique_code": "Q1.3.6"},
            {"question": "តើអ្នកអាចប្រើមុខងារចលករត្រឹមចង្កេះចុះក្រោមដែរឬទេ? (លើស៦ខែ)", "description": "ពិបាកសម្របសម្រួលដងខ្លួន និងខ្នង", "parent_code": "Q1.3", "unique_code": "Q1.3.7"},
            {"question": "តើអ្នកឈឺចាប់ខ្លាំងជាប្រចាំត្រង់ក ចង្កេះ ឬដងខ្លួនដែរទេ? (ឈឺជាអចិន្រៃយ៍)", "description": "ពិបាកសម្របសម្រួលដងខ្លួន និងខ្នង", "parent_code": "Q1.3", "unique_code": "Q1.3.8"},
            {"question": "តើអ្នកប្រើថ្នាំលេប ឬចាក់ជាប្រចាំដែរឬទេ? (លើស៦ខែ)", "description": "ពិបាកសម្របសម្រួលដងខ្លួន និងខ្នង", "parent_code": "Q1.3", "unique_code": "Q1.3.9"},

            {"question": "តើអ្នកធ្លាប់មានការវះកាត់ធំលើសសរីរាង្គខាងក្នុងដែរឬទេ?", "description": "ពិការភាពសរីរាង្គខាងក្នុង", "parent_code": "Q1.4", "unique_code": "Q1.4.1"},
            {"question": "តើសរីរាង្គខាងក្នុងរបស់អ្នកធ្លាប់ឈឺចាប់ដែរឬទេ?", "description": "ពិការភាពសរីរាង្គខាងក្នុង", "parent_code": "Q1.4", "unique_code": "Q1.4.2"},
            {"question": "តើអ្នកប្រើឧបករណ៍ជំនួយសរីរាង្គឬទេ?", "description": "ពិការភាពសរីរាង្គខាងក្នុង", "parent_code": "Q1.4", "unique_code": "Q1.4.3"},
            {"question": "តើអ្នកប្រើថ្នាំពេទ្យដែរឬទេ សម្រាប់ជំងឺដែលបានវះកាត់ធំ?", "description": "ពិការភាពសរីរាង្គខាងក្នុង", "parent_code": "Q1.4", "unique_code": "Q1.4.4"},
            {"question": "តើអ្នកអាចដើរ ឬលោតបានដែរឬទេចាប់តាំងពីក្រោយវះកាត់ធំ?", "description": "ពិការភាពសរីរាង្គខាងក្នុង", "parent_code": "Q1.4", "unique_code": "Q1.4.5"},
            {"question": "តើអ្នកអាចមើលថែទាំអនាម័យខ្លួនងង ឬរស់នៅដោយងករាជ្យបានដែរឬទេ?", "description": "ពិការភាពសរីរាង្គខាងក្នុង", "parent_code": "Q1.4", "unique_code": "Q1.4.6"},


            # Cognitive disability
            {"question": "តើអ្នកអាចស្តាប់ព្ឬដែរ ឬទេ?", "description": "ពិបាកស្តាប់", "parent_code": "Q2.1", "unique_code": "Q2.1.1"},
            {"question": "តើអ្នកមានប្រើឧបករណ៍ជំនួយការស្តាប់ជាប្រចាំដែរឬទេ?", "description": "ពិបាកស្តាប់", "parent_code": "Q2.1", "unique_code": "Q2.1.2"},
            {"question": "បើខ្ញុំគោះប៊ិកលើបាតដៃរបស់ខ្ញុំ តើអ្នកស្តាប់ព្ឬដែរឬទេ? (គោះស្តាំឆ្វេងពីមុខពីក្រោយ", "description": "ពិបាកស្តាប់", "parent_code": "Q2.1", "unique_code": "Q2.1.3"},
            {"question": "តើអ្នកពិបាកស្តាប់ ឬយល់ពីនរណាម្នាក់និយាយដែរឬទេ?", "description": "ពិបាកស្តាប់", "parent_code": "Q2.1", "unique_code": "Q2.1.4"},
            {"question": "តើអ្នកមានបញ្ហក្នុងការស្តាប់វិទ្យុ ឬទូរទស្សន៍ដែរឬទេ? (ទោះបើកសំឡេងខ្លាំងៗក៏ដោយ)", "description": "ពិបាកស្តាប់", "parent_code": "Q2.1", "unique_code": "Q2.1.5"},
            {"question": "តើអ្នកពិបាកស្តាប់ នៅពេលនរណាម្នាក់និយាយតិចៗដែរឬទេ?", "description": "ពិបាកស្តាប់", "parent_code": "Q2.1", "unique_code": "Q2.1.6"},
            {"question": "តើអ្នកមានបញ្ហស្តាប់ដែលបណ្តាលអោយអ្នកប្រកែកជាមួយគេញឹកញាប់ដែរឬទេ?", "description": "ពិបាកស្តាប់", "parent_code": "Q2.1", "unique_code":"Q2.1.7"},

            {"question": "តើអ្នកអាចនិយាយ ឬសន្ទនាបានដែរឬទេ?", "description": "ពិបាកនិយាយ", "parent_code": "Q2.2", "unique_code": "Q2.2.1"},
            {"question": "តើអ្នកអាចនិយាយលើសពី៥០ពាក្យបានដែរឬទេ?", "description": "ពិបាកនិយាយ", "parent_code": "Q2.2", "unique_code":"Q2.2.2"},
            {"question": "តើអ្នកប្រើភាសាសញ្ញា ឬភាសាកាយវិការដែរឬទេ ពេលនិយាយ?", "description": "ពិបាកនិយាយ", "parent_code": "Q2.2", "unique_code": "Q2.2.3"},
            {"question": "តើអ្នកពិបាក ក្នុងការនិយាយភាសាកំណើតរបស់ខ្លួនច្បាស់ដែរឬទេ?", "description": "ពិបាកនិយាយ", "parent_code": "Q2.2", "unique_code": "Q2.2.4"},
            {"question": "តើអ្នកអាចនិយាយត្រាប់តាមបានដែរឬទេ?", "description": "ពិបាកនិយាយ", "parent_code": "Q2.2", "unique_code": "Q2.2.5"},
            {"question": "តើអ្នកនិយាយ ដោយប្រើខ្យល់ច្រមុះ (ក្ថួរ) ដែរឬទេ?", "description": "ពិបាកនិយាយ", "parent_code": "Q2.2", "unique_code": "Q2.2.6"},
            {"question": "តើអ្នកពិបាកនិយាយ ឬសន្ទនានៅក្នុងកន្លែង ឬបន្ទប់មានមនុស្សកកកុញដែរឬទេ?", "description": "ពិបាកនិយាយ", "parent_code": "Q2.2", "unique_code": "Q2.2.7"},

            {"question": "តើអ្នកអាចមើលឃើញ ក្នុងបរិយាកាសធម្មតាដែរឬទេ?", "description": "ពិបាកមើល", "parent_code": "Q2.3", "unique_code": "Q2.3.1"},
            {"question": "តើអ្នកអាចមើលឃើញច្បាស់ដែរឬទេ ទោះពាក់វ៉ែនតាក៏ដោយ?", "description": "ពិបាកមើល", "parent_code": "Q2.3", "unique_code": "Q2.3.2"},
            {"question": "តើអ្នកអាចក្រឡេកមើលឃើញដៃរបស់គាត់ឃើញដែរឬទេ?", "description": "ពិបាកមើល", "parent_code": "Q2.3", "unique_code": "Q2.3.3"},
            {"question": "តើអ្នកអាចធើ្វសញ្ញា ឬសកម្មភាពត្រាប់តាម ឬបញេ្ជញទឹកមុខតាមអ្នកដទៃបានដែរឬទេ?", "description": "ពិបាកមើល", "parent_code": "Q2.3", "unique_code": "Q2.3.4"},
            {"question": "តើអ្នកព្រិចភ្នែកដែរឬទេ ពេកត្រូវពន្លឺ?", "description": "ពិបាកមើល", "parent_code": "Q2.3", "unique_code": "Q2.3.5"},
            {"question": "តើអ្នកអាចមើលឃើញពណ៏ (បែតង ខៀវ ក្រហម លឿង) ដែរឬទេ?", "description": "ពិបាកមើល", "parent_code": "Q2.3", "unique_code": "Q2.3.6"},
            {"question": "តើអ្នកអាចមើលឃើញម្រាមដៃច្បាស់ក្នុងចម្ងាយ៥ម៉ែត្រដែរឬទេ? (ទោះពាក់វ៉ែនតាក៏ដោយ)", "description": "ពិបាកមើល", "parent_code": "Q2.3", "unique_code": "Q2.3.7"},
            {"question": "តើអ្នកអាចមើលម្រាមដៃច្បាស់ក្នុងចម្ងាយ៣ម៉ែត្រដែរឬទេ? (ទោះពាក់វ៉ែនតាក៏ដោយ)", "description": "ពិបាកមើល", "parent_code": "Q2.3", "unique_code": "Q2.3.8"},
            {"question": "តើអ្នកអាចមើលឃើញម្រាមដៃច្បាស់ក្នុងចម្ងាយ៤០សង់ទីម៉ែត្របានដែរឬទេ? (ពាក់វ៉ែនតាក៏ដោយ)", "description": "ពិបាកមើល", "parent_code": "Q2.3", "unique_code": "Q2.3.9"},
            {"question": "តើអ្នកអាចដើរទៅមុខ ដោយខ្លួនងងបានដែរឬទេ? (ប្រើដៃ ដើម្បីរកផ្លូវដើរ)", "description": "ពិបាកមើល", "parent_code": "Q2.3", "unique_code": "Q2.3.10"},

            # Intellectual disability
            {"question": "តើអ្នកដេក ឬសរីរាង្គកាយ ពិសេសសាច់ដុំ ស្ថិតក្នុងសភាពចុះខ្សោយខ្លាំងដែរឬទេ?", "description": "ដោនស៊ីនដ្រូម", "parent_code": "Q3.1", "unique_code": "Q3.1.1"},
            {"question": "តើអ្នកមានឥរិយាបថពិបាកសម្របខ្លួនជាមួយសង្គមដែរឬទេ?", "description": "ដោនស៊ីនដ្រូម", "parent_code": "Q3.1", "unique_code": "Q3.1.2"},
            {"question": "តើអ្នកមានការនិយាយម្តងងើយម្តងទៀតឬរវើយរវាយដែរឬទេ? (និយាយដដែលៗ)", "description": "ដោនស៊ីនដ្រូម", "parent_code": "Q3.1", "unique_code": "Q3.1.3"},
            {"question": "តើអ្នកនិយាយច្រើន ឬតិចតួចបំផុត ប៉ុន្តែពិបាកយល់ពីការប្រាស្រ័យទាក់ទងតាមពាក្យសម្តីដែរឬទេ?", "description": "ដោនស៊ីនដ្រូម", "parent_code": "Q3.1", "unique_code": "Q3.1.4"},
            {"question": "តើអ្នកមានអាកប្បកិរិយារញេរញៃ ឬចលនាម្តងទៅនេះម្តងទៅនោះដែរឬទេ?", "description": "ដោនស៊ីនដ្រូម", "parent_code": "Q3.1", "unique_code": "Q3.1.5"},
            {"question": "តើអ្នកធ្លាប់រវើរវាយ ឬចង់ធ្វើនេះធើ្វនោះមិនធម្មតាដែរឬទេ?", "description": "ដោនស៊ីនដ្រូម", "parent_code": "Q3.1", "unique_code": "Q3.1.6"},
            {"question": "តើអ្នកពិបាកនិយាយគ្នាលើរឿងតែមួយឬរក្សាការសន្ទនាគ្នាទៅវិញទៅមកដែរឬទេ?", "description": "ដោនស៊ីនដ្រូម", "parent_code": "Q3.1", "unique_code": "Q3.1.7"},
            {"question": "តើអ្នកពិបាកក្នុងការយល់ដឹងពីអារម្មណ៍អ្នកដទៃដែរឬទេ?", "description": "ដោនស៊ីនដ្រូម", "parent_code": "Q3.1", "unique_code": "Q3.1.8"},
            {"question": "តើអ្នកចូលចិត្តជជែកអំពីរឿងខ្លួនងងជាងរឿងអ្នកដទៃដែរឬទេ?", "description": "ដោនស៊ីនដ្រូម", "parent_code": "Q3.1", "unique_code": "Q3.1.9"},

            {"question": "តើអ្នកនិយាយតិចតួចហើយផ្តល់ចម្លើយមិនទាក់ទងទៅនិងសំណួរដែរឬទេ?", "description": "អូទីស្សឹម", "parent_code": "Q3.2", "unique_code": "Q3.2.1"},
            {"question": "តើអ្នកមិនឆ្លើយតប បើហៅឈ្មោះចំៗ ឬគេចវេសពីការមើលភ្នែកដែរឬទេ?", "description": "អូទីស្សឹម", "parent_code": "Q3.2", "unique_code": "Q3.2.2"},
            {"question": "តើអ្នកពិបាកយល់អំពីអារម្មណ៍របស់អ្នកឌទៃដែរឬទេ?", "description": "អូទីស្សឹម", "parent_code": "Q3.2", "unique_code": "Q3.2.3"},
            {"question": "តើអ្នកងាយនឹងខកចិត្តដែររទេ បើយើងផ្លាស់ប្តូរ ឬយកអ្វីមួយពិពួកគេ?", "description": "អូទីស្សឹម", "parent_code": "Q3.2", "unique_code": "Q3.2.4"},
            {"question": "តើអ្នកតែងមានចំណាប់អារម្មណ៍ងប់ងល់នឹងអ្វីមួយដែរឬទេ?", "description": "អូទីស្សឹម", "parent_code": "Q3.2", "unique_code": "Q3.2.5"},
            {"question": "តើអ្នកងាយប្តូរអាម្មណ៍តានតឹង ឬរំភើប ពេលប៉ះ ចាប់ រងក្លិន រសជាតិ ឬសំភេងអ្វីមួយដែរឬទេ?", "description": "អូទីស្សឹម", "parent_code": "Q3.2", "unique_code": "Q3.2.6"},
            {"question": "តើអ្នកពិបាកទំនាក់ទំនងសង្គមជាមួយមនុស្សដទៃទៀតដែរឬទេ? (និយាយត្រាប់តាម ឬឡងពាក្យ)", "description": "អូទីស្សឹម", "parent_code": "Q3.2", "unique_code": "Q3.2.7"},
            {"question": "តើអ្នកមិនអោយអ្នកផ្សេង ឬអ្នកដទៃដែលមិនស្គាល់ប៉ះដៃ ឬប្តូររាងកាយដែរឬទេ?", "description": "អូទីស្សឹម", "parent_code": "Q3.2", "unique_code": "Q3.2.8"},
            {"question": "តើអ្នកបង្ហាញការយល់ដឹងតិចតួចអំពីស្ថានភាពគ្រោះថ្នាក់ដែរឬទេ?", "description": "អូទីស្សឹម", "parent_code": "Q3.2", "unique_code": "Q3.2.9"},

            {"question": "តើអ្នកអាចដើរក្នុងផ្ទះ ឬក្រៅផ្ទះ និងឡើងជណ្តើរដោយខ្លួនងងមិនចាំបាច់ជួយកាន់ដៃដែរឬទេ?", "description": "ពិការចលករខួរក្បាល(ស៊ីភី)", "parent_code": "Q3.3", "unique_code": "Q3.3.1"},
            {"question": "តើអ្នកអាចធើ្វសកម្មភាព ដូចជារត់ ឬលោតបានដែរឬទេ?", "description": "ពិការចលករខួរក្បាល(ស៊ីភី)", "parent_code": "Q3.3", "unique_code": "Q3.3.2"},
            {"question": "តើអ្នកមានការថមថយកម្លាំង ឬល្បឿនលំនឹង និងការសម្របសម្រួលសាច់ដុំដែរឬទេ?", "description": "ពិការចលករខួរក្បាល(ស៊ីភី)", "parent_code": "Q3.3", "unique_code": "Q3.3.3"},
            {"question": "តើអ្នកប្រើរទះរុញជាប្រចាំ ដោយខ្លួនងងបានដែរឬទេ?", "description": "ពិការចលករខួរក្បាល(ស៊ីភី)", "parent_code": "Q3.3", "unique_code": "Q3.3.4"},
            {"question": "តើអ្នកអាចឈរបានដែរឬទេ?", "description": "ពិការចលករខួរក្បាល(ស៊ីភី)", "parent_code": "Q3.3", "unique_code": "Q3.3.5"},
            {"question": "តើអ្នកពិបាកបញ្ជាកាយសម្បទា ធើ្វចលនានិងចល័តទីដែរឬទេ?", "description": "ពិការចលករខួរក្បាល(ស៊ីភី)", "parent_code": "Q3.3", "unique_code": "Q3.3.6"},
            {"question": "តើអ្នកមានការពិបាកគ្រប់ផ្នែកកាយសម្បទាទាំងអស់ដែរឬទេ?", "description": "ពិការចលករខួរក្បាល(ស៊ីភី)", "parent_code": "Q3.3", "unique_code": "Q3.3.7"},
            {"question": "តើអ្នកមានសមត្ថភាពការពារក្បាល ក និងទីតាំងផ្សេងទៀតដោយខ្លួនងងដែរឬទេ?", "description": "ពិការចលករខួរក្បាល(ស៊ីភី)", "parent_code": "Q3.3", "unique_code": "Q3.3.8"},

            # Mentally disabled
            {"question": "តើអ្នកមានអារម្មណ៍ពិបាកចិត្ត ឆាប់ខឹង ឆាប់ភ៏យញ៍រ ថប់បារម្ភ ឬតានតឹងខ្លាំងដែរឬទេ?", "description": "ពិការផ្លូវចិត្ត", "parent_code": "Q4.1", "unique_code": "Q4.1.1"},
            {"question": "តើអ្នកមានប្រើថ្នាំរម្ងាប់អារម្មណ៦ ឬថ្នាំសណ្តំដែររឬទេ?", "description": "ពិការផ្លូវចិត្ត", "parent_code": "Q4.1", "unique_code": "Q4.1.2"},
            {"question": "តើអ្នកមានអារម្មន៦ចង់នៅតែម្នាក់ងង ឬខ្លាចគេងងមកជិតដែរឬទេ?", "description": "ពិការផ្លូវចិត្ត", "parent_code": "Q4.1", "unique_code": "Q4.1.3"},
            {"question": "តើអ្នកមានអារម្មណ៍ចង់វ៉ៃ ជេរបញ្ជោរ ឬបំផ្លិតបំផ្លាញជាញឹកញាប់ដែរឬទេ?", "description": "ពិការផ្លូវចិត្ត", "parent_code": "Q4.1", "unique_code": "Q4.1.4"},
            {"question": "តើអ្នកមានអារម្មណ៍ធុញទ្រាន់ខ្លាំង ឬក្តោបត្រចៀកជាញឹកញាប់នរណាម្នាក់និយាយដែរឬទេ?", "description": "ពិការផ្លូវចិត្ត", "parent_code": "Q4.1", "unique_code": "Q4.1.5"},
            {"question": "តើអ្នកចូលចិត្តច្រៀងរាំតែម្នាក់ងងដែរឬទេ? (ទោះពេលយប់ជ្រៅក៏ដោយ)", "description": "ពិការផ្លូវចិត្ត", "parent_code": "Q4.1", "unique_code": "Q4.1.6"},
            {"question": "តើអ្នកឆ្លើយតបដោយកំហឹង នៅពេលអ្នកមានអារម្មណ៍ថាត្រូវបានគេប្រមាថដែរឬទេ?", "description": "ពិការផ្លូវចិត្ត", "parent_code": "Q4.1", "unique_code": "Q4.1.7"},
            {"question": "តើអ្នកមានអារម្មណ៍ភ័យព្រួយ ឬព្រួយបារម្ភខ្លាំង ហើយពិបាកគ្រប់គ្រងដែរឬទេ?", "description": "ពិការផ្លូវចិត្ត", "parent_code": "Q4.1", "unique_code": "Q4.1.8"},
            {"question": "តើអ្នកធ្លាប់ឈឺចាប់ផ្លូវចិត្តខ្លាំង រយះពេលជាច្រើនខែ បន្ទាប់ពីការបាតបង់អ្វីមួយដែរឬទេ?", "description": "ពិការផ្លូវចិត្ត", "parent_code": "Q4.1", "unique_code": "Q4.1.9"},
            {"question": "តើអ្នកពិបាកោផ្តោតអារម្មណ៍លើអ្វីផ្សេងក្រៅពីអ្នកជាទីស្រលាញ់ដែលបានបាត់បង់ដែរឬទេ?", "description": "ពិការផ្លូវចិត្ត", "parent_code": "Q4.1", "unique_code": "Q4.1.10"},

            {"question": "តើអ្នកអាចចូលរួមរៀនសូត្រ ហើយពិបាកចងចាំខ្លាំងដែរឬទេ?", "description": "ពិបាកចងចាំ", "parent_code": "Q4.2", "unique_code": "Q4.2.1"},
            {"question": "តើអ្នកធ្លាប់ភ្លេចអ្វីមួយដែលអ្នកទើបទុកដាក់ថ្មីៗដែរឬទេ?", "description": "ពិបាកចងចាំ", "parent_code": "Q4.2", "unique_code": "Q4.2.2"},
            {"question": "តើអ្នកឧស្សាហ៍ភ្លេច ហើយសួរម្តងហើយ ម្តងទៀតដែរឬទេ?", "description": "ពិបាកចងចាំ", "parent_code": "Q4.2", "unique_code": "Q4.2.3"},
            {"question": "តើអ្នកមានអារម្មណ៍ច្រឡំ ក្នុងពេលអំឡុងពេលសន្ទនា ហើយត្រូវឈប់សិនដែរឬទេ?", "description": "ពិបាកចងចាំ", "parent_code": "Q4.2", "unique_code": "Q4.2.4"},
            {"question": "តើអ្នកពិបាកចាំព្រឹត្តិការណ៍ ដូចជាថ្ងៃកំណើតខ្លួនងងដែរឬទេ?", "description": "ពិបាកចងចាំ", "parent_code": "Q4.2", "unique_code": "Q4.2.5"},
            {"question": "តើអ្នកឧស្សាហ៍បាត់បង់វត្ថុ និងមានអារម្មណ៍ថាគេលួចវត្ថុដែរឬទេ?", "description": "ពិបាកចងចាំ", "parent_code": "Q4.2", "unique_code": "Q4.2.6"},
            {"question": "តើអ្នកមានការពិបាកក្នុងការចងចាំលើការអនុវត្តអនាម័យល្អដែរឬទេ?", "description": "ពិបាកចងចាំ", "parent_code": "Q4.2", "unique_code": "Q4.2.7"},
            {"question": "តើអ្នកមានការផ្លាស់ប្តូរបុគ្គលិកលក្ខណះជាញឹកញាប់ដែរឬទេ? (ឆាប់ខឹង អន្ទះសារ ....)", "description": "ពិបាកចងចាំ", "parent_code": "Q4.2", "unique_code": "Q4.2.8"},
            {"question": "តើអ្នកពិបាកចាំពាក្យដែលខ្លួនងង ឬអ្នកដទៃនិយាយប្រាប់ពី បីនាទីមុនដែរឬទេ?", "description": "ពិបាកចងចាំ", "parent_code": "Q4.2", "unique_code": "Q4.2.9"},

            # Other disabilities
            {"question": "តើអ្នកធ្លាប់ប្រកាច់ ឬឆ្កួតជ្រូកក្នុងរយះពេល៣ខែចុងក្រោយដែរឬទេ?", "description": "ជំងឺរមួលសារពាង្គកាយមិនប្រក្រតី", "parent_code": "Q5.1", "unique_code": "Q5.1.1"},
            {"question": "តើអ្នកធ្លាប់ប្រកាច់ ឬប្រកាច់បណ្តោលមកពីគ្រុនក្តៅខ្លាំង ពេលនៅក្មេងដែរឬទេ?", "description": "ជំងឺរមួលសារពាង្គកាយមិនប្រក្រតី", "parent_code": "Q5.1", "unique_code": "Q5.1.2"},
            {"question": "តើការប្រកាច់ ឬជំងឺឆ្កួតជ្រូកមិនអាចគ្រប់គ្រងបាន ទោះបីជាមានការព្យាបាលនៅមន្ទីពេទ្យ និងការព្យបាលដោយថ្នាំដែរឬទេ? (ចាំបាច់ត្រូវមានការបញ្ជាក់ពីមណ្ធលសុខភាព)", "description": "ជំងឺរមួលសារពាង្គកាយមិនប្រក្រតី", "parent_code": "Q5.1", "unique_code": "Q5.1.3"},
            {"question": "តើអ្នកធ្លាប់បញ្ចូននៅមន្ទីរពេទ្យ ៦ដងឬលើសពីនេះ ដោយសារការប្រកាច់ ឬជំងឺឆ្កួតជ្រូកដែរឬទេ?", "description": "ជំងឺរមួលសារពាង្គកាយមិនប្រក្រតី", "parent_code": "Q5.1", "unique_code": "Q5.1.4"},
            {"question": "តើអ្នកធ្លាប់ប្រកាច់ធ្វើអោយរបួសរាង្គកាយធ្ងន់ធ្ងរ ត្រូវព្យបាលភ្លាមៗ ឬសម្រាកព្យាបាលនៅមន្ទីរពេទ្យដែរឬទេ?", "description": "ជំងឺរមួលសារពាង្គកាយមិនប្រក្រតី", "parent_code": "Q5.1", "unique_code": "Q5.1.5"},
            {"question": "តើអ្នកធ្លាប់ប្រើថ្នាំសម្រាប់ការពារប្រកាច់ដែរឬទេ?", "description": "ជំងឺរមួលសារពាង្គកាយមិនប្រក្រតី", "parent_code": "Q5.1", "unique_code": "Q5.1.6"},

            {"question": "តើអ្នកមានជំងឺរាំរៃ (លើសពី៦ខែ) ប្រចាំកាយដែរឬទេ?", "description": "ពិការភាពផ្សេងៗ", "parent_code": "Q5.2", "unique_code": "Q5.2.1"},
            {"question": "តើអ្នកធ្លាប់មានរបួស ឬវះកាត់ធំសរីរាង្គខាងក្នុងដែរឬទេ?", "description": "ពិការភាពផ្សេងៗ", "parent_code": "Q5.2", "unique_code": "Q5.2.2"},
            {"question": "តើអ្នកត្រូវការប្រើប្រាស់ថ្នាំព្យបាលជាប្រចាំដែរឬទេ?", "description": "ពិការភាពផ្សេងៗ", "parent_code": "Q5.2", "unique_code":"Q5.2.3"},
            {"question": "តើជងឺរបស់អ្នកមានការឺឈចាប់ជាប្រចាំដែរឬទេ?", "description": "ពិការភាពផ្សេងៗ", "parent_code": "Q5.2", "unique_code": "Q5.2.4"},
            {"question": "តើអ្នកត្រូវការពិគ្រោះយោបល់ និងព្យបាលជាប្រចាំជាមួយគ្រូពេទ្យដែរឬទេ?", "description": "ពិការភាពផ្សេងៗ", "parent_code": "Q5.2", "unique_code": "Q5.2.5"},
            {"question": "តើអ្នកអាចធើ្វចលនា ឬហាត់ប្រាណដោយច្លួនងងដែរឬទេ?", "description": "ពិការភាពផ្សេងៗ", "parent_code": "Q5.2", "unique_code": "Q5.2.6"},
            {"question": "តើជំងឺរបស់អ្នកបានបង្កផលពិបាកដល់សកម្មភាពប្រចាំរបស់អ្នកដែរឬទេ?", "description": "ពិការភាពផ្សេងៗ", "parent_code": "Q5.2", "unique_code": "Q5.2.7"},
            {"question": "តើជំងឺរបស់អ្នកបានប៉ះពាល់ដល់អារម្មណ៍របស់អ្នក (ខឹង មួរម៉ៅ ខ្លាច) ដែរឬទេ?", "description": "ពិការភាពផ្សេងៗ", "parent_code": "Q5.2", "unique_code": "Q5.2.8"},

            # Living environment
            {"question": "តើអ្នកពិបាកចូលរួមក្នុងសកម្មភាពរបស់សហគមន៍ដែរឬទេ?", "description": "សកម្មភាពសង្គម", "parent_code": "Q6.1", "unique_code": "Q6.1.1"},
            {"question": "តើអ្នកអាចទៅផ្សារ ហាងទំនិញ ធនាគារឬសាលាឃុំ សង្កត់ បានដោយងាយស្រួលដែរឬទេ?", "description": "សកម្មភាពសង្គម", "parent_code": "Q6.1", "unique_code": "Q6.1.2"},
            {"question": "តើប្រភេទមធ្យោបាយធើ្វដំណើរអ្វី ដែលអ្នកប្រើប្រាស់?", "description": "សកម្មភាពសង្គម", "parent_code": "Q6.1", "unique_code": "Q6.1.3"},
            {"question": "តើមធ្យោបាយធើ្វឌំណើរឆ្លើយតបតាមត្រូវការរបស់ជនមានពិការភាពដែរឬទេ?", "description": "សកម្មភាពសង្គម", "parent_code": "Q6.1", "unique_code": "Q6.1.4"},
            {"question": "តើអ្នកជាអ្នកសម្រេចចិត្តដោយខ្លួនងងអំពីសកម្មភាពប្រចាំថ្ងៃដែរឬទេ?", "description": "សកម្មភាពសង្គម", "parent_code": "Q6.1", "unique_code": "Q6.1.5"},
            {"question": "តើអ្នកមានអារម្មណ៍ថាអ្នកដទែមិនអោយតម្លៃឬមិនស្តាប់អ្វីដែលអ្នកនិយាយដែរឬទេ?", "description": "សកម្មភាពសង្គម", "parent_code": "Q6.1", "unique_code": "Q6.1.6"},

            {"question": "តើអ្នកត្រូវការជំនួយការសម្រាប់សកម្មភាពប្រចាំថ្ងៃដែររទេ?", "description": "ជំនួយការ", "parent_code": "Q6.2", "unique_code": "Q6.2.1"},
            {"question": "តើអ្នកត្រូវការ ការជំនួយក្នុងសកម្មភាពប្រចាំថ្ងៃ (២៤/៧) ដែរឬទេ?", "description": "ជំនួយការ", "parent_code": "Q6.2","unique_code": "Q6.2.2"},
            {"question": "តើនរណាជាអ្នកជួយអ្នកក្នុងសកម្មភាពប្រចាំថ្ងៃ? សូមបញ្ជាក់", "description": "ជំនួយការ", "parent_code": "Q6.2","unique_code": "Q6.2.3"},
            {"question": "ប្រសិនបើ អ្នកតម្រូវការជំនួយសកម្មភាពប្រចាំថ្ងៃ តើអ្នកមើលថែទាំមានពេលវេលាគ្រប់គ្រាន់សម្រាប់ជយយអ្នកដែរឬទេ?", "description": "ជំនួយការ", "parent_code": "Q6.2","unique_code": "Q6.2.4"},
        ]
        
        inserted = 0
        for item in QUESTION_DISABILITY_TYPES:
            new_question = Question(
                question=item["question"],
                description=item["description"],
                parent_code=item["parent_code"],
                unique_code=item["unique_code"],
                status=True,
                created_by=created_by,
                updated_by=created_by,
            )
            session.add(new_question)
            inserted += 1

        await session.commit()
        logger.info(f"Disability-type questions seeding completed → {inserted} inserted")

    except Exception as e:
        await session.rollback()
        logger.error(f"Error creating disability questions: {str(e)}", exc_info=True)
        raise


# Answer of Disability-Type
async def create_answer(session: AsyncSession) -> None:
    try:
        result = await session.execute(select(User.id).where(User.username == "gs_commune"))
        admin_user = result.scalar_one_or_none()
        created_by = admin_user if admin_user else None

        ANSWER_DISABILITY_TYPES = [
            # Under 8 years-old
            {"answer": "គ្មានបញ្ហា", "description": "", "unique_code": "A1"},
            {"answer": "ធើ្វបានខ្លះៗ", "description": "", "unique_code": "A2"},
            {"answer": "ពិបាក ឬប្រើជំនួយ", "description": "", "unique_code": "A3"},
            {"answer": "មិនអាចធើ្វបាន", "description": "", "unique_code": "A4"},
            {"answer": "២៥០ម៉ែត្រឡើង", "description": "", "unique_code": "A5"},
            {"answer": "ចន្លោះ៥០-២៥០ម៉ែត្រ", "description": "", "unique_code": "A6"},
            {"answer": "៥០ម៉ែត្រចុះ", "description": "", "unique_code": "A7"},
            {"answer": "មិនចុះខ្សោយ", "description": "", "unique_code": "A8"},
            {"answer": "ខ្សោយតិចតួច", "description": "", "unique_code": "A9"},
            {"answer": "ខ្សោយបង្គួរ", "description": "", "unique_code": "A10"},
            {"answer": "ខ្សោយខ្លាំង", "description": "", "unique_code": "A11"},
            {"answer": "តិចតួច", "description": "", "unique_code": "A12"},
            {"answer": "បង្គួរ", "description": "", "unique_code": "A13"},
            {"answer": "ខ្លាំង", "description": "", "unique_code": "A14"},
            {"answer": "មិនធ្លាប់មាន", "description": "", "unique_code": "A15"},
            {"answer": "ធ្លាប់មាន", "description": "", "unique_code": "A16"},
            {"answer": "មិនដែល", "description": "", "unique_code": "A17"},
            {"answer": "ម្តងម្តាល", "description": "", "unique_code": "A18"},
            {"answer": "ញឹកញាប់", "description": "", "unique_code": "A19"},
            {"answer": "ជាប្រចាំ", "description": "", "unique_code": "A20"},
            {"answer": "មិនមាន", "description": "", "unique_code": "A21"},
            {"answer": "មាន", "description": "", "unique_code": "A22"},
            {"answer": "មិនត្រូវការ", "description": "", "unique_code": "A23"},
            {"answer": "ត្រូវការ", "description": "", "unique_code": "A24"},
            

            #Over 8 years-old
            {"answer": "សាធារណះ", "description": "", "unique_code": "A25"},
            {"answer": "មធ្យោបាយផ្ទាល់ខ្លួន", "description": "", "unique_code": "A26"},
            {"answer": "គ្មានមធ្យោបាយធើ្វដំណើរ", "description": "", "unique_code": "A27"},
            {"answer": "ទេ", "description": "", "unique_code": "A28"},
            {"answer": "បាទ/ចាស", "description": "", "unique_code": "A29"},
            {"answer": "តិចមានបញ្ហា", "description": "", "unique_code": "A30"},
            {"answer": "ឪពុកម្តាយបង្កើតម្នាក់ ឬ ទាំងពីរ", "description": "", "unique_code": "A31"},
            {"answer": "ឪពុកម្តាយចិញ្ចឹមម្នាក់ ឬ ទាំងពីរ", "description": "", "unique_code": "A32"},
            {"answer": "ជីដូនជីតាបង្កើត", "description": "", "unique_code": "A33"},
            {"answer": "បងប្អូនប្រុស/ស្រី", "description": "", "unique_code": "A34"},
            {"answer": "សាច់ញាតិ", "description": "", "unique_code": "A35"},
            {"answer": "មិនមែនសាច់ញាតិ", "description": "", "unique_code": "A36"},
            {"answer": "អ្នកមើលថែអាជីព", "description": "", "unique_code": "A37"},
            {"answer": "មានគ្រប់គ្រាន់", "description": "", "unique_code": "A38"},
            {"answer": "មានភាគច្រើន", "description": "", "unique_code": "A39"},
            {"answer": "ជួនមានជួនអត់", "description": "", "unique_code": "A40"},
            {"answer": "សឹងតែមិនមានសោះ", "description": "", "unique_code": "A41"},
            {"answer": "បើកភ្នែកខ្លះៗ", "description": "", "unique_code": "A42"},
            {"answer": "បើកភ្នែកដោយពិបាក", "description": "", "unique_code": "A43"},
            {"answer": "បិទភ្នែក", "description": "", "unique_code": "A44"},
        ]
        inserted = 0
        for item in ANSWER_DISABILITY_TYPES:
            # Create and insert using the model
            new_type = Answer(
                answer=item["answer"],
                description=item["description"],
                unique_code=item["unique_code"],
                status=True,
                created_by=created_by,
                updated_by=created_by
            )
            session.add(new_type)
            inserted += 1

        await session.commit()
        logger.info(f"Answer completed → {inserted} inserted")

    except Exception as e:
        await session.rollback()
        logger.error(f"Error creating disability types: {str(e)}", exc_info=True)
        raise


# Category-question
async def create_category_question(session: AsyncSession) -> None:
    try:
        result = await session.execute(select(User.id).where(User.username == "gs_commune"))
        admin_user = result.scalar_one_or_none()
        created_by = admin_user if admin_user else None

        CATEGORY_ANSWER = [
            {"category": "ដៃស្តាំ" , "code": "C1", "child_code": "C1"},
            {"category": "ដៃឆ្វេង" , "code": "C2", "child_code": "C2"},
            {"category": "ដៃទាំងពីរ" , "code": "C3", "child_code": "C1_C2"},

            {"category": "ជើងស្តាំ" , "code": "C4", "child_code": "C4"},
            {"category": "ជើងឆ្វេង" , "code": "C5", "child_code": "C5"},
            {"category": "ជើងទាំងពីរ" , "code": "C6", "child_code": "C4_C5"},

            {"category": "ពាក់កណ្តាលខ្លួន" , "code": "C7", "child_code": "C7"},
            {"category": "ចំហៀងឆ្វេង ឬស្តាំ" , "code": "C8", "child_code": "C8"},
            {"category": "មួយតួខ្លួន" , "code": "C9", "child_code": "C7_C8"},

            {"category": "ត្រចៀកស្តាំ" , "code": "C10", "child_code": "C10"},
            {"category": "ត្រចៀកឆ្វេង" , "code": "C11", "child_code": "C11"},
            {"category": "ត្រចៀកទាំងពីរ" , "code": "C12", "child_code": "C10_C11"},

            {"category": "ភ្នែកស្តាំ" , "code": "C13", "child_code": "C13"},
            {"category": "ភ្នែកឆ្វេង" , "code": "C14", "child_code": "C14"},
            {"category": "ភ្នែកទាំងពីរ" , "code": "C15", "child_code": "C13_C14"},

            {"category": "NULL" , "code": "C16", "child_code": "C16"},
        ]
        inserted = 0
        for item in CATEGORY_ANSWER:
            # Create and insert using the model
            new_type = CategoryQuestion(
                category=item["category"],
                code=item["code"],
                child_code=item["child_code"],
                status=True,
                created_by=created_by,
                updated_by=created_by
            )
            session.add(new_type)
            inserted += 1

        await session.commit()
        logger.info(f"Category-Question completed → {inserted} inserted")

    except Exception as e:
        await session.rollback()
        logger.error(f"Error creating Category-Question: {str(e)}", exc_info=True)
        raise


# Question-Answer-main_id
# async def create_user_select(session: AsyncSession) -> None:
#     """
#     Insert a QuestionAnswer record into the database.
#     The QA data is defined inside this function.
#     """

#     try:
#         # -----------------------------
#         #   Get admin user ID
#         # -----------------------------
#         result = await session.execute(
#             select(User.id).where(User.username == settings.ADMIN_USERNAME)
#         )
#         admin_user = result.scalar_one_or_none()
#         created_by = admin_user if admin_user else None

#         # -----------------------------
#         #   Define QA input inside the function
#         # -----------------------------
#         qa_input = {
#             "main_id": 46,
#             "question_code": "Q1_1_1",
#             "answer_code": "A1",
#             "category_code": "C3",
#         }

#          # -----------------------------
#         #   Check if QA already exists
#         # -----------------------------
#         existing = await session.execute(
#             select(QuestionAnswer.id).where(
#                 (QuestionAnswer.main_id == qa_input["main_id"]) &
#                 (QuestionAnswer.question_code == qa_input["question_code"]) &
#                 (QuestionAnswer.answer_code == qa_input["answer_code"])
#             )
#         )
#         if existing.scalar_one_or_none():
#             logger.info(f"QuestionAnswer already exists, skipping: {qa_input}")
#             return


#         # -----------------------------
#         #   Metadata and table
#         # -----------------------------
#         metadata = MetaData()
#         qa_table = Table(
#             "question_answer",
#             metadata,
#             Column("id", Integer, primary_key=True, autoincrement=True),
#             Column("main_id", Integer, nullable=False),
#             Column("question_code", String, nullable=False),
#             Column("answer_code", String, nullable=False),
#             Column("category_code", String, nullable=True),
#             Column("status", Boolean, default=True),
#             Column("created_by", Integer),
#             Column("updated_by", Integer),
#             Column("is_deleted", Boolean, default=False),
#         )

#         # -----------------------------
#         #   Prepare data for insertion
#         # -----------------------------
#         qa_data = {
#             "main_id": qa_input["main_id"],
#             "question_code": qa_input["question_code"],
#             "answer_code": qa_input["answer_code"],
#             "category_code": qa_input.get("category_code"),
#             "status": True,
#             "created_by": created_by,
#             "updated_by": created_by,
#         }

#         # -----------------------------
#         #   Insert into DB
#         # -----------------------------
#         stmt = insert(qa_table).values(qa_data)

#         async with async_engine.connect() as conn:
#             await conn.execute(stmt)
#             await conn.commit()

#         logger.info(f"QuestionAnswer inserted successfully: {qa_input}")

#     except Exception as e:
#         logger.error(f"Error inserting QuestionAnswer: {e}")
#         raise


# Question-Answer-View
async def create_question_answer_view(session: AsyncSession) -> None:
    try:
        result = await session.execute(select(User.id).where(User.username == "gs_commune"))
        admin_user = result.scalar_one_or_none()
        created_by = admin_user if admin_user else None

        QUESTION_ANSWER_VIEW = {
            # under 8 years old
            "under_8_year_old": {
                "Q1_1_1": ["A1", "A2", "A3", "A4"],
                "Q1_1_2": ["A1", "A2", "A3", "A4"],
                "Q1_1_3": ["A1", "A2", "A3", "A4"],
                "Q1_1_4": ["A1", "A2", "A3", "A4"],
                "Q1_1_5": ["A1", "A2", "A3", "A4"],
                "Q1_1_6": ["A1", "A2", "A3", "A4"],
                "Q1_1_7": ["A1", "A2", "A3", "A4"],

                "Q1_2_1": ["A1", "A2", "A3", "A4"],
                "Q1_2_2": ["A1", "A2", "A3", "A4"],
                "Q1_2_3": ["A1", "A2", "A3", "A4"],
                "Q1_2_4": ["A1", "A2", "A3", "A4"],
                "Q1_2_5": ["A1", "A2", "A3", "A4"],
                "Q1_2_6":["A1", "A2", "A3", "A4"],
                "Q1_2_7":["A1", "A2", "A3", "A4"],
                "Q1_2_8": ["A5", "A6", "A7"],
                "Q1_2_9": ["A5", "A6", "A7"],

                "Q1_3_1": ["A8", "A9", "A10", "A11"],
                "Q1_3_2": ["A1", "A2", "A3", "A4"],
                "Q1_3_3": ["A1", "A2", "A3", "A4"],
                "Q1_3_4": ["A1", "A12", "A13", "A14"],
                "Q1_3_5": ["A1", "A12", "A13", "A14"],
                "Q1_3_6": ["A15", "A16"],
                "Q1_3_7": ["A1", "A2", "A3", "A4"],
                "Q1_3_8": ["A17", "A18", "A19", "A20"],
                "Q1_3_9": ["A17", "A18", "A19", "A20"],

                "Q1_4_1": ["A15", "A16"],
                "Q1_4_2": ["A17", "A18", "A19", "A20"],
                "Q1_4_3": ["A17", "A18", "A19", "A20"],
                "Q1_4_4": ["A17", "A18", "A19", "A20"],
                "Q1_4_5": ["A1", "A2", "A3", "A4"],
                "Q1_4_6": ["A1", "A2", "A3", "A4"],

                "Q2_1_1": ["A1", "A2", "A3", "A4"],
                "Q2_1_2": ["A17", "A18", "A19", "A20"],
                "Q2_1_3": ["A1", "A2", "A3", "A4"],
                "Q2_1_4": ["A1", "A2", "A3", "A4"],
                "Q2_1_5": ["A1", "A2", "A3", "A4"],
                "Q2_1_6": ["A1", "A2", "A3", "A4"],
                "Q2_1_7": ["A1", "A2", "A3", "A4"],

                "Q2_2_1": ["A1", "A2", "A3", "A4"],
                "Q2_2_2": ["A1", "A2", "A3", "A4"],
                "Q2_2_3": ["A1", "A2", "A3", "A4"],
                "Q2_2_4": ["A1", "A2", "A3", "A4"],
                "Q2_2_5": ["A1", "A2", "A3", "A4"],
                "Q2_2_6": ["A1", "A12", "A13", "A14"],
                "Q2_2_7": ["A1", "A2", "A3", "A4"],

                "Q2_3_1": ["A1", "A2", "A3", "A4"],
                "Q2_3_2": ["A1", "A2", "A3", "A4"],
                "Q2_3_3": ["A1", "A2", "A3", "A4"],
                "Q2_3_4": ["A1", "A2", "A3", "A4"],
                "Q2_3_5": ["A1", "A2", "A3", "A4"],
                "Q2_3_6": ["A1", "A2", "A3", "A4"],

                "Q3_1_1": ["A1", "A2", "A3", "A4"],
                "Q3_1_2": ["A17", "A18", "A19", "A20"],
                "Q3_1_3": ["A17", "A18", "A19", "A20"],
                "Q3_1_4": ["A17", "A18", "A19", "A20"],
                "Q3_1_5": ["A17", "A18", "A19", "A20"],
                "Q3_1_6": ["A17", "A18", "A19", "A20"],
                "Q3_1_7": ["A17", "A18", "A19", "A20"],
                "Q3_1_8": ["A17", "A18", "A19", "A20"],

                "Q3_2_1": ["A17", "A18", "A19", "A20"],
                "Q3_2_2": ["A17", "A18", "A19", "A20"],
                "Q3_2_3": ["A17", "A18", "A19", "A20"],
                "Q3_2_4": ["A17", "A18", "A19", "A20"],
                "Q3_2_5": ["A17", "A18", "A19", "A20"],
                "Q3_2_6": ["A17", "A18", "A19", "A20"],
                "Q3_2_7": ["A17", "A18", "A19", "A20"],
                "Q3_2_8": ["A17", "A18", "A19", "A20"],
                "Q3_2_9": ["A17", "A18", "A19", "A20"],

                "Q3_3_1": ["A1", "A2", "A3", "A4"],
                "Q3_3_2": ["A1", "A2", "A3", "A4"],
                "Q3_3_3": ["A1", "A2", "A3", "A4"],
                "Q3_3_4": ["A1", "A2", "A3", "A4"],
                "Q3_3_5": ["A1", "A2", "A3", "A4"],
                "Q3_3_6": ["A1", "A2", "A3", "A4"],
                "Q3_3_7": ["A1", "A2", "A3", "A4"],
                "Q3_3_8": ["A1", "A2", "A3", "A4"],

                "Q4_1_1": ["A17", "A18", "A19", "A20"],
                "Q4_1_2": ["A17", "A18", "A19", "A20"],
                "Q4_1_3": ["A17", "A18", "A19", "A20"],
                "Q4_1_4": ["A17", "A18", "A19", "A20"],
                "Q4_1_5": ["A17", "A18", "A19", "A20"],
                "Q4_1_6": ["A17", "A18", "A19", "A20"],
                "Q4_1_7": ["A17", "A18", "A19", "A20"],

                "Q4_2_1": ["A1", "A2", "A3", "A4"],
                "Q4_2_2": ["A1", "A2", "A3", "A4"],
                "Q4_2_3": ["A1", "A2", "A3", "A4"],
                "Q4_2_4": ["A1", "A2", "A3", "A4"],
                "Q4_2_5": ["A1", "A2", "A3", "A4"],
                "Q4_2_6": ["A1", "A2", "A3", "A4"],
                "Q4_2_7": ["A1", "A2", "A3", "A4"],

                "Q5_1_1": ["A15", "A16"],
                "Q5_1_2": ["A15", "A16"],
                "Q5_1_3": ["A17", "A18", "A19", "A20"],
                "Q5_1_4": ["A15", "A16"],
                "Q5_1_5": ["A17", "A18", "A19", "A20"],
                "Q5_1_6": ["A17", "A18", "A19", "A20"],

                "Q5_2_1": ["A21", "A22"],
                "Q5_2_2": ["A15", "A16"],
                "Q5_2_3": ["A17", "A18", "A19", "A20"],
                "Q5_2_4": ["A17", "A18", "A19", "A20"],
                "Q5_2_5": ["A17", "A18", "A19", "A20"],
                "Q5_2_6": ["A1", "A2", "A3", "A4"],
                "Q5_2_7": ["A17", "A18", "A19", "A20"],
                "Q5_2_8": ["A17", "A18", "A19", "A20"],

                "Q6_1_1": ["A1", "A2", "A3", "A4"],
                "Q6_1_2": ["A1", "A2", "A3", "A4"],

                "Q6_2_1": ["A21", "A22"],
                "Q6_2_2": ["A23", "A24"],
                "Q6_2_3": ["A23", "A24"],
                "Q6_2_4": ["A23", "A24"],
            },

            #Over 8 years old
            "over_8_year_old": {
                "Q1.1.1": ["A1", "A2", "A3", "A4"],
                "Q1.1.2": ["A1", "A2", "A3", "A4"],
                "Q1.1.3": ["A1", "A2", "A3", "A4"],
                "Q1.1.4": ["A1", "A2", "A3", "A4"],
                "Q1.1.5": ["A1", "A2", "A3", "A4"],
                "Q1.1.6": ["A1", "A2", "A3", "A4"],
                "Q1.1.7": ["A1", "A2", "A3", "A4"],

                "Q1.2.1": ["A1", "A2", "A3", "A4"],
                "Q1.2.2": ["A1", "A2", "A3", "A4"],
                "Q1.2.3": ["A1", "A2", "A3", "A4"],
                "Q1.2.4": ["A1", "A2", "A3", "A4"],
                "Q1.2.5": ["A1", "A2", "A3", "A4"],
                "Q1.2.6": ["A1", "A2", "A3", "A4"],
                "Q1.2.7": ["A1", "A2", "A3", "A4"],
                "Q1.2.8": ["A5", "A6", "A7"],
                "Q1.2.9": ["A5", "A6", "A7"],

                "Q1.3.1": ["A8", "A9", "A10", "A11"],
                "Q1.3.2": ["A1", "A2", "A3", "A4"],
                "Q1.3.3": ["A1", "A2", "A3", "A4"],
                "Q1.3.4": ["A1", "A12", "A13", "A14"],
                "Q1.3.5": ["A1", "A12", "A13", "A14"],
                "Q1.3.6": ["A15", "A16"],
                "Q1.3.7": ["A1", "A2", "A3", "A4"],
                "Q1.3.8": ["A17", "A18", "A19", "A20"],
                "Q1.3.9": ["A17", "A18", "A19", "A20"],

                "Q1.4.1": ["A15", "A16"],
                "Q1.4.2": ["A17", "A18", "A19", "A20"],
                "Q1.4.3": ["A17", "A18", "A19", "A20"],
                "Q1.4.4": ["A17", "A18", "A19", "A20"],
                "Q1.4.5": ["A1", "A2", "A3", "A4"],
                "Q1.4.6": ["A1", "A2", "A3", "A4"],

                "Q2.1.1": ["A1", "A2", "A3", "A4"],
                "Q2.1.2": ["A17", "A18", "A19", "A20"],
                "Q2.1.3": ["A1", "A2", "A3", "A4"],
                "Q2.1.4": ["A1", "A2", "A3", "A4"],
                "Q2.1.5": ["A1", "A2", "A3", "A4"],
                "Q2.1.6": ["A1", "A2", "A3", "A4"],
                "Q2.1.7": ["A1", "A2", "A3", "A4"],

                "Q2.2.1": ["A1", "A2", "A3", "A4"],
                "Q2.2.2": ["A1", "A2", "A3", "A4"],
                "Q2.2.3": ["A1", "A2", "A3", "A4"],
                "Q2.2.4": ["A1", "A2", "A3", "A4"],
                "Q2.2.5": ["A1", "A2", "A3", "A4"],
                "Q2.2.6": ["A1", "A12", "A13", "A14"],
                "Q2.2.7": ["A1", "A2", "A3", "A4"],

                "Q2.3.1": ["A1", "A2", "A3", "A4"],
                "Q2.3.2": ["A1", "A2", "A3", "A4"],
                "Q2.3.3": ["A1", "A2", "A3", "A4"],
                "Q2.3.4": ["A1", "A2", "A3", "A4"],
                "Q2.3.5": ["A1", "A2", "A3", "A4"],
                "Q2.3.6": ["A1", "A2", "A3", "A4"],
                "Q2.3.7": ["A1", "A2", "A3", "A4"],
                "Q2.3.8": ["A1", "A2", "A3", "A4"],
                "Q2.3.9": ["A1", "A2", "A3", "A4"],
                "Q2.3.10": ["A1", "A2", "A3", "A4"],

                "Q3.1.1": ["A1","A42", "A43", "A44"],
                "Q3.1.2": ["A17", "A18", "A19", "A20"],
                "Q3.1.3": ["A17", "A18", "A19", "A20"],
                "Q3.1.4": ["A17", "A18", "A19", "A20"],
                "Q3.1.5": ["A17", "A18", "A19", "A20"],
                "Q3.1.6": ["A17", "A18", "A19", "A20"],
                "Q3.1.7": ["A17", "A18", "A19", "A20"],
                "Q3.1.8": ["A17", "A18", "A19", "A20"],
                "Q3.1.9": ["A17", "A18", "A19", "A20"],

                "Q3.2.1": ["A17", "A18", "A19", "A20"],
                "Q3.2.2": ["A17", "A18", "A19", "A20"],
                "Q3.2.3": ["A17", "A18", "A19", "A20"],
                "Q3.2.4": ["A17", "A18", "A19", "A20"],
                "Q3.2.5": ["A17", "A18", "A19", "A20"],
                "Q3.2.6": ["A17", "A18", "A19", "A20"],
                "Q3.2.7": ["A17", "A18", "A19", "A20"],
                "Q3.2.8": ["A17", "A18", "A19", "A20"],
                "Q3.2.9": ["A17", "A18", "A19", "A20"],

                "Q3.3.1": ["A1", "A2", "A3", "A4"],
                "Q3.3.2": ["A1", "A2", "A3", "A4"],
                "Q3.3.3": ["A1", "A2", "A3", "A4"],
                "Q3.3.4": ["A1", "A2", "A3", "A4"],
                "Q3.3.5": ["A1", "A2", "A3", "A4"],
                "Q3.3.6": ["A1", "A2", "A3", "A4"],
                "Q3.3.7": ["A1", "A2", "A3", "A4"],
                "Q3.3.8": ["A1", "A2", "A3", "A4"],

                "Q4.1.1": ["A17", "A18", "A19", "A20"],
                "Q4.1.2": ["A17", "A18", "A19", "A20"],
                "Q4.1.3": ["A17", "A18", "A19", "A20"],
                "Q4.1.4": ["A17", "A18", "A19", "A20"],
                "Q4.1.5": ["A17", "A18", "A19", "A20"],
                "Q4.1.6": ["A17", "A18", "A19", "A20"],
                "Q4.1.7": ["A17", "A18", "A19", "A20"],
                "Q4.1.8": ["A17", "A18", "A19", "A20"],
                "Q4.1.9": ["A17", "A18", "A19", "A20"],
                "Q4.1.10": ["A17", "A18", "A19", "A20"],

                "Q4.2.1": ["A17", "A18", "A19", "A20"],
                "Q4.2.2": ["A17", "A18", "A19", "A20"],
                "Q4.2.3": ["A17", "A18", "A19", "A20"],
                "Q4.2.4": ["A17", "A18", "A19", "A20"],
                "Q4.2.5": ["A17", "A18", "A19", "A20"],
                "Q4.2.6": ["A17", "A18", "A19", "A20"],
                "Q4.2.7": ["A17", "A18", "A19", "A20"],
                "Q4.2.8": ["A17", "A18", "A19", "A20"],
                "Q4.2.9": ["A17", "A18", "A19", "A20"],

                "Q5.1.1": ["A15", "A16"],
                "Q5.1.2": ["A15", "A16"],
                "Q5.1.3": ["A17", "A18", "A19", "A20"],
                "Q5.1.4": ["A15", "A16"],
                "Q5.1.5": ["A17", "A18", "A19", "A20"],
                "Q5.1.6":  ["A17", "A18", "A19", "A20"],

                "Q5.2.1": ["A21", "A22"],
                "Q5.2.2": ["A15", "A16"],
                "Q5.2.3": ["A17", "A18", "A19", "A20"],
                "Q5.2.4": ["A17", "A18", "A19", "A20"],
                "Q5.2.5": ["A17", "A18", "A19", "A20"],
                "Q5.2.6": ["A1", "A2", "A3", "A4"],
                "Q5.2.7": ["A17", "A18", "A19", "A20"],
                "Q5.2.8": ["A17", "A18", "A19", "A20"],

                "Q6.1.1": ["A1", "A2", "A3", "A4"],
                "Q6.1.2": ["A1", "A2", "A3", "A4"],
                "Q6.1.3": ["A25", "A26", "A27"],
                "Q6.1.4": ["A28", "A29"],
                "Q6.1.5": ["A30", "A12", "A3", "A4"],
                "Q6.1.6": ["A17", "A18", "A19", "A20"],

                "Q6.2.1": ["A23", "A24"],
                "Q6.2.2": ["A23", "A24"],
                "Q6.2.3": ["A21", "A31", "A32", "A33", "A34", ],
                "Q6.2.4": ["A38", "A39", "A40", "A41"]
            }
        }

        inserted = 0

        # -----------------------------
        #   Loop through age groups
        # -----------------------------
        for age_group, question_map in QUESTION_ANSWER_VIEW.items():

            for question_code, answer_list in question_map.items():

                # Resolve question_id once per question_code
                question_result = await session.execute(
                    select(Question.id).where(Question.unique_code == question_code).limit(1)
                )
                question_id = question_result.scalars().first()
                if question_id is None:
                    logger.warning(f"Question with code {question_code} not found, skipping")
                    continue

                for answer_code in answer_list:

                    # Resolve answer_id
                    answer_result = await session.execute(
                        select(Answer.id).where(Answer.unique_code == answer_code).limit(1)
                    )
                    answer_id = answer_result.scalars().first()
                    if answer_id is None:
                        logger.warning(f"Answer with code {answer_code} not found, skipping")
                        continue

                    # -----------------------------
                    #   Insert new row
                    # -----------------------------
                    row = QuestionAnswerView(
                        question_id=question_id,
                        answer_id=answer_id,
                        age_group=age_group,
                        question_code=question_code,
                        answer_code=answer_code,
                        status=True,
                        created_by=created_by,
                        updated_by=created_by,
                    )

                    session.add(row)
                    inserted += 1

        await session.commit()

        logger.info(
            f"QuestionAnswerView seeding completed → {inserted} inserted"
        )

    except Exception as e:
        await session.rollback()
        logger.error(f"Error creating QuestionAnswerView: {e}")
        raise


# Category-question-view
async def create_category_question_view(session: AsyncSession) -> None:
    try:
        result = await session.execute(select(User.id).where(User.username == "gs_commune"))
        admin_user = result.scalar_one_or_none()
        created_by = admin_user if admin_user else None

        CATEGORY_QUESTION_VIEW = {
            "under_8_year_old": {
                # under 8 years old
                "Q1_1_1": ["C1", "C2", "C3"],
                "Q1_1_2": ["C1", "C2", "C3"],
                "Q1_1_3": ["C1", "C2", "C3"],
                "Q1_1_4": ["C1", "C2", "C3"],
                "Q1_1_5": ["C1", "C2", "C3"],
                "Q1_1_6": ["C1", "C2", "C3"],
                "Q1_1_7": ["C1", "C2", "C3"],

                "Q1_2_1": ["C4", "C5", "C6"],
                "Q1_2_2": ["C4", "C5", "C6"],
                "Q1_2_3": ["C4", "C5", "C6"],
                "Q1_2_4": ["C4", "C5", "C6"],
                "Q1_2_5": ["C4", "C5", "C6"],
                "Q1_2_6": ["C4", "C5", "C6"],
                "Q1_2_7": ["C4", "C5", "C6"],
                "Q1_2_8": ["C16"],
                "Q1_2_9": ["C16"],

                "Q1_3_1": ["C16"],
                "Q1_3_2": ["C7", "C8", "C9"],
                "Q1_3_3": ["C16"],
                "Q1_3_4": ["C7", "C8", "C9"],
                "Q1_3_5": ["C7", "C8", "C9"],
                "Q1_3_6": ["C16"],
                "Q1_3_7": ["C16"],
                "Q1_3_8": ["C16"],
                "Q1_3_9": ["C16"],

                "Q1_4_1": ["C16"],
                "Q1_4_2": ["C16"],
                "Q1_4_3": ["C16"],
                "Q1_4_4": ["C16"],
                "Q1_4_5": ["C16"],
                "Q1_4_6": ["C16"],

                "Q2_1_1": ["C16"],
                "Q2_1_2": ["C10", "C11", "C12"],
                "Q2_1_3": ["C10", "C11", "C12"],
                "Q2_1_4": ["C10", "C11", "C12"],
                "Q2_1_5": ["C10", "C11", "C12"],
                "Q2_1_6": ["C10", "C11", "C12"],
                "Q2_1_7": ["C10", "C11", "C12"],

                "Q2_2_1": ["C16"],
                "Q2_2_2": ["C16"],
                "Q2_2_3": ["C16"],
                "Q2_2_4": ["C16"],
                "Q2_2_5": ["C16"],
                "Q2_2_6": ["C16"],
                "Q2_2_7": ["C16"],

                "Q2_3_1": ["C13", "C14", "C15"],
                "Q2_3_2": ["C13", "C14", "C15"],
                "Q2_3_3": ["C13", "C14", "C15"],
                "Q2_3_4": ["C13", "C14", "C15"],
                "Q2_3_5": ["C13", "C14", "C15"],
                "Q2_3_6": ["C13", "C14", "C15"],

                "Q3_1_1": ["C16"],
                "Q3_1_2": ["C16"],
                "Q3_1_3": ["C16"],
                "Q3_1_4": ["C16"],
                "Q3_1_5": ["C16"],
                "Q3_1_6": ["C16"],
                "Q3_1_7": ["C16"],
                "Q3_1_8": ["C16"],

                "Q3_2_1": ["C16"],
                "Q3_2_2": ["C16"],
                "Q3_2_3": ["C16"],
                "Q3_2_4": ["C16"],
                "Q3_2_5": ["C16"],
                "Q3_2_6": ["C16"],
                "Q3_2_7": ["C16"],
                "Q3_2_8": ["C16"],
                "Q3_2_9": ["C16"],

                "Q3_3_1": ["C16"],
                "Q3_3_2": ["C16"],
                "Q3_3_3": ["C16"],
                "Q3_3_4": ["C16"],
                "Q3_3_5": ["C16"],
                "Q3_3_6": ["C16"],
                "Q3_3_7": ["C16"],
                "Q3_3_8": ["C16"],

                "Q4_1_1": ["C16"],
                "Q4_1_2": ["C16"],
                "Q4_1_3": ["C16"],
                "Q4_1_4": ["C16"],
                "Q4_1_5": ["C16"],
                "Q4_1_6": ["C16"],
                "Q4_1_7": ["C16"],

                "Q4_2_1": ["C16"],
                "Q4_2_2": ["C16"],
                "Q4_2_3": ["C16"],
                "Q4_2_4": ["C16"],
                "Q4_2_5": ["C16"],
                "Q4_2_6": ["C16"],
                "Q4_2_7": ["C16"],

                "Q5_1_1": ["C16"],
                "Q5_1_2": ["C16"],
                "Q5_1_3": ["C16"],
                "Q5_1_4": ["C16"],
                "Q5_1_5": ["C16"],
                "Q5_1_6": ["C16"],

                "Q5_2_1": ["C16"],
                "Q5_2_2": ["C16"],
                "Q5_2_3": ["C16"],
                "Q5_2_4": ["C16"],
                "Q5_2_5": ["C16"],
                "Q5_2_6": ["C16"],
                "Q5_2_7": ["C16"],
                "Q5_2_8": ["C16"],

                "Q6_1_1": ["C16"],
                "Q6_1_2": ["C16"],

                "Q6_2_1": ["C16"],
                "Q6_2_2": ["C16"],
                "Q6_2_3": ["C16"],
                "Q6_2_4": ["C16"],
            },

            "over_8_year_old": {
                # Over 8 year old
                "Q1.1.1": ["C1", "C2", "C3"],
                "Q1.1.2": ["C1", "C2", "C3"],
                "Q1.1.3": ["C1", "C2", "C3"],
                "Q1.1.4": ["C1", "C2", "C3"],
                "Q1.1.5": ["C1", "C2", "C3"],
                "Q1.1.6": ["C1", "C2", "C3"],
                "Q1.1.7": ["C1", "C2", "C3"],

                "Q1.2.1": ["C4", "C5", "C6"],
                "Q1.2.2": ["C4", "C5", "C6"],
                "Q1.2.3": ["C4", "C5", "C6"],
                "Q1.2.4": ["C4", "C5", "C6"],
                "Q1.2.5": ["C4", "C5", "C6"],
                "Q1.2.6": ["C4", "C5", "C6"],
                "Q1.2.7": ["C4", "C5", "C6"],
                "Q1.2.8": ["C16"],
                "Q1.2.9": ["C16"],

                "Q1.3.1": ["C16"],
                "Q1.3.2": ["C7", "C8", "C9"],
                "Q1.3.3": ["C16"],
                "Q1.3.4": ["C7", "C8", "C9"],
                "Q1.3.5": ["C7", "C8", "C9"],
                "Q1.3.6": ["C16"],
                "Q1.3.7": ["C16"],
                "Q1.3.8": ["C16"],
                "Q1.3.9": ["C16"],

                "Q1.4.1": ["C16"],
                "Q1.4.2": ["C16"],
                "Q1.4.3": ["C16"],
                "Q1.4.4": ["C16"],
                "Q1.4.5": ["C16"],
                "Q1.4.6": ["C16"],

                "Q2.1.1": ["C16"],
                "Q2.1.2": ["C10", "C11", "C12"],
                "Q2.1.3": ["C10", "C11", "C12"],
                "Q2.1.4": ["C10", "C11", "C12"],
                "Q2.1.5": ["C10", "C11", "C12"],
                "Q2.1.6": ["C10", "C11", "C12"],
                "Q2.1.7": ["C10", "C11", "C12"],

                "Q2.2.1": ["C16"],
                "Q2.2.2": ["C16"],
                "Q2.2.3": ["C16"],
                "Q2.2.4": ["C16"],
                "Q2.2.5": ["C16"],
                "Q2.2.6": ["C16"],
                "Q2.2.7": ["C16"],

                "Q2.3.1": ["C13", "C14", "C15"],
                "Q2.3.2": ["C13", "C14", "C15"],
                "Q2.3.3": ["C13", "C14", "C15"],
                "Q2.3.4": ["C13", "C14", "C15"],
                "Q2.3.5": ["C13", "C14", "C15"],
                "Q2.3.6": ["C13", "C14", "C15"],
                "Q2.3.7": ["C13", "C14", "C15"],
                "Q2.3.8": ["C13", "C14", "C15"],
                "Q2.3.9": ["C13", "C14", "C15"],
                "Q2.3.10": ["C13", "C14", "C15"],

                "Q3.1.1": ["C16"],
                "Q3.1.2": ["C16"],
                "Q3.1.3": ["C16"],
                "Q3.1.4": ["C16"],
                "Q3.1.5": ["C16"],
                "Q3.1.6": ["C16"],
                "Q3.1.7": ["C16"],
                "Q3.1.8": ["C16"],
                "Q3.1.9": ["C16"],

                "Q3.2.1": ["C16"],
                "Q3.2.2": ["C16"],
                "Q3.2.3": ["C16"],
                "Q3.2.4": ["C16"],
                "Q3.2.5": ["C16"],
                "Q3.2.6": ["C16"],
                "Q3.2.7": ["C16"],
                "Q3.2.8": ["C16"],
                "Q3.2.9": ["C16"],

                "Q3.3.1": ["C16"],
                "Q3.3.2": ["C16"],
                "Q3.3.3": ["C16"],
                "Q3.3.4": ["C16"],
                "Q3.3.5": ["C16"],
                "Q3.3.6": ["C16"],
                "Q3.3.7": ["C16"],
                "Q3.3.8": ["C16"],

                "Q4.1.1": ["C16"],
                "Q4.1.2": ["C16"],
                "Q4.1.3": ["C16"],
                "Q4.1.4": ["C16"],
                "Q4.1.5": ["C16"],
                "Q4.1.6": ["C16"],
                "Q4.1.7": ["C16"],
                "Q4.1.8": ["C16"],
                "Q4.1.9": ["C16"],
                "Q4.1.10": ["C16"],

                "Q4.2.1": ["C16"],
                "Q4.2.2": ["C16"],
                "Q4.2.3": ["C16"],
                "Q4.2.4": ["C16"],
                "Q4.2.5": ["C16"],
                "Q4.2.6": ["C16"],
                "Q4.2.7": ["C16"],
                "Q4.2.8": ["C16"],
                "Q4.2.9": ["C16"],

                "Q5.1.1": ["C16"],
                "Q5.1.2": ["C16"],
                "Q5.1.3": ["C16"],
                "Q5.1.4": ["C16"],
                "Q5.1.5": ["C16"],
                "Q5.1.6": ["C16"],

                "Q5.2.1": ["C16"],
                "Q5.2.2": ["C16"],
                "Q5.2.3": ["C16"],
                "Q5.2.4": ["C16"],
                "Q5.2.5": ["C16"],
                "Q5.2.6": ["C16"],
                "Q5.2.7": ["C16"],
                "Q5.2.8": ["C16"],

                "Q6.1.1": ["C16"],
                "Q6.1.2": ["C16"],
                "Q6.1.3": ["C16"],
                "Q6.1.4": ["C16"],
                "Q6.1.5": ["C16"],
                "Q6.1.6": ["C16"],

                "Q6.2.1": ["C16"],
                "Q6.2.2": ["C16"],
                "Q6.2.3": ["C16"],
                "Q6.2.4": ["C16"],
            }
        }

        inserted = 0

        # -----------------------------
        #   Loop Through Data
        # -----------------------------
        for age_group, mapping in CATEGORY_QUESTION_VIEW.items():

            for question_code, category_list in mapping.items():

                for category_code in category_list:

                    # -----------------------------
                    #   Insert New Row
                    # -----------------------------
                    row = CategoryQuestionView(
                        age_group=age_group,
                        question_code=question_code,
                        category_question_code=category_code,
                        status=True,
                        created_by=created_by,
                        updated_by=created_by,
                    )

                    session.add(row)
                    inserted += 1

        await session.commit()

        logger.info(
            f"CategoryQuestionView seeding completed → {inserted} inserted"
        )

    except Exception as e:
        await session.rollback()
        logger.error(f"Error creating CategoryQuestionView: {e}")
        raise




async def main():
    async with local_session() as session:
        try:
            # Clean all tables in correct order (child tables first, then parent tables)
            logger.info("Starting table cleanup...")
            
            # Delete child tables first (those with foreign keys)
            await session.execute(delete(QuestionAnswerView))
            await session.execute(delete(CategoryQuestionView))
            logger.info("View tables cleaned")
            
            # Delete parent tables
            await session.execute(delete(Question))
            await session.execute(delete(Answer))
            await session.execute(delete(CategoryQuestion))
            await session.execute(delete(DisabilityType))
            
            await session.commit()
            logger.info("All tables cleaned successfully")
            
            # Now create data in correct order
            await create_disability_type(session)
            await create_question(session)
            await create_answer(session)
            await create_category_question(session)
            # await create_user_select(session)
            await create_question_answer_view(session)
            await create_category_question_view(session)
            logger.info("🎉 script completed successfully!")
        except Exception as e:
            logger.error("❌ script failed.")
            raise


if __name__ == "__main__":
    asyncio.run(main())
